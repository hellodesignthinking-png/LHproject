# ZeroSite v8.5 완전 해결 방안

## 🎯 문제 진단 요약

### 근본 원인
1. **v8.5 financial_result 구조 불완전**: `run_full_financial_analysis()`가 반환하는 데이터에 보고서가 필요로 하는 필드들이 없음
   - 없는 필드: `land_appraisal`, `total_verified_cost`, `lh_purchase_price`, `roi`, `project_rating`, `decision`
   - 존재하는 필드: `total_investment`, `unit_count`, `cap_rate`, `noi`, `irr_range`

2. **lh_price_sim 구조 불일치**: 보고서 템플릿이 기대하는 `lh_price_sim` 구조와 실제 생성되는 구조가 다름

3. **UI 데이터 바인딩 누락**: UI가 v8.5 데이터가 아닌 v7.5 더미 데이터를 표시

## ✅ 해결 전략

### 전략 A: v8.5 데이터 구조 완전 재구성 (권장)
`run_full_financial_analysis()` 반환값에 필요한 모든 필드를 추가

```python
return {
    'capex': capex,
    'opex': opex,
    'noi': noi,
    'returns': returns,
    'breakeven': breakeven,
    'sensitivity': sensitivity,
    'summary': {
        'total_investment': capex['total_capex'],
        'total_capex': capex['total_capex'],  # 별칭
        'unit_count': capex['unit_count'],
        'noi_stabilized': noi['noi'],
        'cap_rate': returns['cap_rate_percent'],
        'meets_lh_criteria': returns['meets_lh_target'],
        'irr_range': sensitivity['summary']['irr_range'],
        
        # 🆕 v8.5 보고서용 추가 필드
        'land_appraisal': land_appraisal_price,
        'total_verified_cost': capex['total_capex'],  # CAPEX = verified cost
        'lh_purchase_price': capex['total_capex'] * 0.85,  # LH 매입가 추정
        'total_project_cost': capex['total_capex'],
        'roi': (noi['noi'] / capex['total_capex'] * 100) if capex['total_capex'] > 0 else 0,
        'project_rating': 'A' if returns['cap_rate_percent'] >= 5 else 'B' if returns['cap_rate_percent'] >= 4 else 'C',
        'decision': 'GO' if returns['meets_lh_target'] else 'CONDITIONAL'
    }
}
```

### 전략 B: 보고서 생성기에서 계산 (차선책)
보고서 생성 시점에 누락된 필드를 계산하여 추가

## 📋 구현 순서

1. **financial_engine_v7_4.py 수정** - `run_full_financial_analysis()` 반환값 확장
2. **lh_report_generator_v7_5_final.py 수정** - v8.5 데이터 매핑 로직 수정
3. **main.py 수정** - API 응답에 v8.5 데이터 올바르게 포함
4. **static/index.html 수정** - UI가 v8.5 데이터 표시

## 🚀 즉시 실행 가능한 수정

### 파일 1: financial_engine_v7_4.py (Line 628-643)
기존 return 문을 다음으로 교체:

```python
return {
    'capex': capex,
    'opex': opex,
    'noi': noi,
    'returns': returns,
    'breakeven': breakeven,
    'sensitivity': sensitivity,
    'summary': {
        # 기존 필드
        'total_investment': capex['total_capex'],
        'total_capex': capex['total_capex'],
        'unit_count': capex['unit_count'],
        'noi_stabilized': noi['noi'],
        'cap_rate': returns['cap_rate_percent'],
        'meets_lh_criteria': returns['meets_lh_target'],
        'irr_range': sensitivity['summary']['irr_range'],
        
        # v8.5 보고서/UI용 필드
        'land_appraisal': land_appraisal_price or 0,
        'total_verified_cost': capex['total_capex'],
        'lh_purchase_price': int(capex['total_capex'] * 0.85),
        'total_project_cost': capex['total_capex'],
        'roi': round((noi['noi'] / capex['total_capex'] * 100), 2) if capex['total_capex'] > 0 else 0,
        'project_rating': 'A' if returns['cap_rate_percent'] >= 5.0 else 'B' if returns['cap_rate_percent'] >= 4.0 else 'C' if returns['cap_rate_percent'] >= 3.0 else 'D',
        'decision': 'GO' if returns['meets_lh_target'] and returns['cap_rate_percent'] >= 4.5 else 'CONDITIONAL' if returns['cap_rate_percent'] >= 3.5 else 'REVISE'
    }
}
```

### 파일 2: lh_report_generator_v7_5_final.py (Line 296-340)
lh_price_sim 생성 로직을 다음으로 완전 교체:

```python
if financial_result_v85 and lh_scores_v85:
    logger.info("✅ Using v8.5 financial data for report generation")
    financial_analysis = financial_result_v85
    
    # Extract v8.5 financial summary
    financial_summary = financial_result_v85.get('summary', {})
    
    # 모든 필수 필드 추출
    unit_count = financial_summary.get('unit_count', 0)
    total_capex = financial_summary.get('total_capex', 0)
    land_appraisal = financial_summary.get('land_appraisal', 0)
    total_verified_cost = financial_summary.get('total_verified_cost', total_capex)
    lh_purchase_price_calc = financial_summary.get('lh_purchase_price', int(total_capex * 0.85))
    cap_rate = financial_summary.get('cap_rate', 0)
    roi = financial_summary.get('roi', 0)
    project_rating = financial_summary.get('project_rating', 'C')
    decision = financial_summary.get('decision', 'CONDITIONAL')
    
    total_score = lh_scores_v85.get('total_score', 0)
    
    # Market value & gap calculation
    market_value = total_capex
    lh_purchase_price = lh_purchase_price_calc
    gap_amount = market_value - lh_purchase_price
    gap_percentage = (gap_amount / market_value * 100) if market_value > 0 else 0
    
    # Explanation based on score
    if total_score >= 80:
        explanation = "입지 경쟁력, 재무적 타당성, LH 매입 조건 모두 우수하여 사업 추진을 적극 권장합니다."
    elif total_score >= 60:
        explanation = f"전반적인 사업성은 양호하나, 재무 지표(Cap Rate {cap_rate:.2f}%) 개선을 통해 수익성 제고가 필요합니다."
    elif total_score >= 40:
        explanation = "사업성 개선을 위한 토지 매입가 재협상, 설계 최적화, 또는 LH 조건 재검토가 필요합니다."
    else:
        explanation = f"현재 조건으로는 수익성 확보가 어렵습니다. Gap {gap_percentage:.1f}% 해소를 위한 근본적인 사업 구조 재검토가 필요합니다."
    
    # 완전한 lh_price_sim 구조 생성 (LHPurchasePriceSimulator.simulate_lh_purchase_price 호환)
    lh_price_sim = {
        # 핵심 가격 정보
        'lh_purchase_price': lh_purchase_price,
        'market_value': market_value,
        'gap_amount': gap_amount,
        'gap_percentage': gap_percentage,
        
        # 상세 breakdown
        'lh_price_breakdown': {
            'land_cost': land_appraisal,
            'construction_cost': total_capex * 0.70,
            'developer_profit': total_capex * 0.05,
            'total': lh_purchase_price
        },
        
        # 평가 및 권고
        'profitability_score': total_score,
        'recommendation': 'GO' if total_score >= 80 else 'CONDITIONAL' if total_score >= 60 else 'REVISE' if total_score >= 40 else 'NO-GO',
        'explanation': explanation,
        
        # v8.5 특화 필드
        'total_score': total_score,
        'lh_scores': lh_scores_v85,
        'analysis_mode': analysis_mode,
        'unit_count': unit_count,
        
        # metadata (시뮬레이터 테이블 생성용)
        'metadata': {
            'unit_count': unit_count,
            'price_per_unit_lh': lh_purchase_price / unit_count if unit_count > 0 else 0,
            'price_per_unit_market': market_value / unit_count if unit_count > 0 else 0,
            'lh_price_cap': 150000000,  # 1.5억/세대 (기본값)
            'land_appraisal': land_appraisal,
            'total_verified_cost': total_verified_cost,
            'cap_rate': cap_rate,
            'roi': roi,
            'project_rating': project_rating
        }
    }
    
    logger.info(f"   ✓ v8.5 lh_price_sim created: LH Price={lh_purchase_price:,.0f}, Gap={gap_percentage:.1f}%")
```

## 🧪 테스트 방법

수정 후 다음 명령으로 테스트:

```bash
curl -X POST "http://localhost:8000/api/generate-report" \
-H "Content-Type: application/json" \
-d '{
  "address": "서울시 마포구 월드컵북로 120",
  "land_area": 660.0,
  "land_appraisal_price": 5000000000,
  "unit_type": "신혼·신생아 I",
  "report_mode": "v7_5_final"
}' | jq '.success, .analysis_id, (.html | length)'
```

기대 결과:
- `success: true`
- `analysis_id: [UUID]`
- `HTML length: > 100000`

## 📝 체크리스트

- [ ] financial_engine_v7_4.py 수정
- [ ] lh_report_generator_v7_5_final.py 수정  
- [ ] 서버 재시작 확인
- [ ] /api/analyze-land 테스트
- [ ] /api/generate-report 테스트
- [ ] PDF 다운로드 및 데이터 확인
- [ ] UI 표시 데이터 확인
- [ ] Commit 및 Push

## 🎯 최종 목표

- ✅ 모든 v8.5 데이터가 보고서에 반영
- ✅ KeyError 완전 제거
- ✅ 0원, 0%, N/A 제거
- ✅ UI와 PDF 데이터 100% 일치
- ✅ 전문가 스타일 v7.5 템플릿 유지
