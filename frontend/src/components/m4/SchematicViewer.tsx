/**
 * M4 Schematic Viewer Component
 * ==============================
 * 
 * Displays 4 types of building schematics generated by M4 V2
 * 
 * Schematic Types:
 * 1. Ground Layout (ì§€ìƒ ë°°ì¹˜ë„)
 * 2. Standard Floor Plan (ê¸°ì¤€ì¸µ í‰ë©´ë„)
 * 3. Basement Parking (ì§€í•˜ì£¼ì°¨ í‰ë©´ë„)
 * 4. Massing Comparison (ë§¤ìŠ¤ ë¹„êµ)
 * 
 * Author: ZeroSite Frontend Team
 * Date: 2025-12-17
 */

import React, { useState } from 'react';
import './SchematicViewer.css';

export interface SchematicFiles {
  groundLayout: string;
  standardFloor: string;
  basementParking: string;
  massingComparison: string;
}

export interface SchematicViewerProps {
  parcelId: string;
  schematics: SchematicFiles;
  available?: boolean;
}

const TABS = [
  { id: 'ground', label: 'ì§€ìƒ ë°°ì¹˜ë„', icon: 'ğŸ—ï¸' },
  { id: 'floor', label: 'ê¸°ì¤€ì¸µ í‰ë©´ë„', icon: 'ğŸ“' },
  { id: 'parking', label: 'ì§€í•˜ì£¼ì°¨ í‰ë©´ë„', icon: 'ğŸ…¿ï¸' },
  { id: 'massing', label: 'ë§¤ìŠ¤ ë¹„êµ', icon: 'ğŸ“Š' },
];

export const SchematicViewer: React.FC<SchematicViewerProps> = ({
  parcelId,
  schematics,
  available = true,
}) => {
  const [activeTab, setActiveTab] = useState('ground');

  if (!available) {
    return (
      <div className="schematic-viewer-unavailable">
        <div className="unavailable-icon">ğŸ“‹</div>
        <h3>ë„ë©´ ìƒì„± ì „</h3>
        <p>M4 ë¶„ì„ì´ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ 4ê°€ì§€ ë„ë©´ì´ ìƒì„±ë©ë‹ˆë‹¤.</p>
      </div>
    );
  }

  const getSchematicUrl = () => {
    switch (activeTab) {
      case 'ground':
        return schematics.groundLayout;
      case 'floor':
        return schematics.standardFloor;
      case 'parking':
        return schematics.basementParking;
      case 'massing':
        return schematics.massingComparison;
      default:
        return '';
    }
  };

  const currentTab = TABS.find((t) => t.id === activeTab);
  const schematicUrl = getSchematicUrl();
  const isPng = activeTab === 'massing';

  return (
    <div className="schematic-viewer">
      <div className="schematic-header">
        <h2 className="schematic-title">
          ê±´ì¶• ë„ë©´
          <span className="parcel-id">í•„ì§€ ID: {parcelId}</span>
        </h2>
      </div>

      {/* Tab Navigation */}
      <div className="schematic-tabs">
        {TABS.map((tab) => (
          <button
            key={tab.id}
            className={`tab-btn ${activeTab === tab.id ? 'active' : ''}`}
            onClick={() => setActiveTab(tab.id)}
          >
            <span className="tab-icon">{tab.icon}</span>
            <span className="tab-label">{tab.label}</span>
          </button>
        ))}
      </div>

      {/* Schematic Display */}
      <div className="schematic-content">
        <div className="schematic-display">
          {isPng ? (
            <img
              src={schematicUrl}
              alt={currentTab?.label}
              className="schematic-image"
            />
          ) : (
            <object
              data={schematicUrl}
              type="image/svg+xml"
              className="schematic-svg"
            >
              <p>ë„ë©´ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            </object>
          )}
        </div>

        <div className="schematic-info">
          <h3 className="info-title">{currentTab?.label}</h3>
          <p className="info-description">{getDescription(activeTab)}</p>
        </div>
      </div>

      {/* Download Buttons */}
      <div className="schematic-actions">
        <a
          href={schematicUrl}
          download
          className="btn-download"
        >
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path
              d="M10 13L6 9L7.41 7.59L9 9.17V3H11V9.17L12.59 7.59L14 9L10 13Z"
              fill="currentColor"
            />
            <path
              d="M17 15V17H3V15H1V17C1 18.1 1.9 19 3 19H17C18.1 19 19 18.1 19 17V15H17Z"
              fill="currentColor"
            />
          </svg>
          í˜„ì¬ ë„ë©´ ë‹¤ìš´ë¡œë“œ
        </a>

        <button className="btn-download-all" onClick={() => downloadAll(schematics)}>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path
              d="M15 9H11V3H9V9H5L10 14L15 9Z"
              fill="currentColor"
            />
            <path
              d="M17 15V17H3V15H1V17C1 18.1 1.9 19 3 19H17C18.1 19 19 18.1 19 17V15H17Z"
              fill="currentColor"
            />
          </svg>
          ì „ì²´ ë„ë©´ ë‹¤ìš´ë¡œë“œ (ZIP)
        </button>
      </div>
    </div>
  );
};

// Helper functions
function getDescription(tabId: string): string {
  const descriptions = {
    ground:
      'ëŒ€ì§€ ê²½ê³„ì™€ ê±´ë¬¼ ë°°ì¹˜ë¥¼ ë³´ì—¬ì£¼ëŠ” ë„ë©´ì…ë‹ˆë‹¤. ê±´íìœ¨, ì£¼ì°¨ ì¶œì…êµ¬ ìœ„ì¹˜ ë“±ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    floor:
      'ê¸°ì¤€ì¸µ(í‘œì¤€ì¸µ) í‰ë©´ë„ì…ë‹ˆë‹¤. ì„¸ëŒ€ ë°°ì¹˜, ì½”ì–´ ìœ„ì¹˜, ì „ìš©/ê³µìš© ë©´ì  êµ¬ì„±ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    parking:
      'ì§€í•˜ì£¼ì°¨ì¥ í‰ë©´ë„ì…ë‹ˆë‹¤. ì£¼ì°¨ ëŒ€ìˆ˜, ë¨í”„ ìœ„ì¹˜, êµ¬ì¡° ê¸°ë‘¥ ë°°ì¹˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
    massing:
      'ëŒ€ì•ˆë³„ ê±´ë¬¼ ë§¤ì‹± ë¹„êµ ë„ë©´ì…ë‹ˆë‹¤. ìš©ì ë¥  ìµœëŒ€í™”(Aì•ˆ)ì™€ ì£¼ì°¨ ìš°ì„ (Bì•ˆ)ì„ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
  };
  return descriptions[tabId as keyof typeof descriptions] || '';
}

async function downloadAll(schematics: SchematicFiles) {
  // Simplified: Download each file individually
  // In production, create a ZIP file
  const files = [
    { name: 'ground_layout.svg', url: schematics.groundLayout },
    { name: 'standard_floor.svg', url: schematics.standardFloor },
    { name: 'basement_parking.svg', url: schematics.basementParking },
    { name: 'massing_comparison.png', url: schematics.massingComparison },
  ];

  for (const file of files) {
    const link = document.createElement('a');
    link.href = file.url;
    link.download = file.name;
    link.click();
    await new Promise((r) => setTimeout(r, 100));
  }

  alert('ëª¨ë“  ë„ë©´ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

export default SchematicViewer;
