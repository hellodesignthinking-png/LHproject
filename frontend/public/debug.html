<!DOCTYPE html>
<html>
<head>
    <title>Pipeline Debug Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        .log {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #00ff00;
            border-radius: 4px;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #00cc00;
        }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
        .info { color: #00ccff; }
    </style>
</head>
<body>
    <h1>ðŸ”§ Pipeline Connection Debug</h1>
    <div id="status" class="log">
        <strong>Status:</strong> <span id="statusText">Ready</span>
    </div>
    <div id="logs" class="log" style="max-height: 400px; overflow-y: auto;">
        <strong>Logs:</strong><br>
    </div>

    <button onclick="testM1Freeze()">Test M1 Context Freeze</button>
    <button onclick="testPipelineAnalyze()">Test Pipeline Analyze</button>
    <button onclick="testFullFlow()">Test Full Flow</button>
    <button onclick="clearLogs()">Clear Logs</button>

    <script>
        const BACKEND_URL = 'https://8091-ivaebkgzir7elqapbc68q-8f57ffe2.sandbox.novita.ai';
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logsDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function setStatus(text, type = 'info') {
            const statusText = document.getElementById('statusText');
            statusText.textContent = text;
            statusText.className = type;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<strong>Logs:</strong><br>';
        }

        async function testM1Freeze() {
            log('ðŸš€ Testing M1 Context Freeze API...', 'info');
            setStatus('Testing M1 Freeze...', 'info');

            const testData = {
                // STEP 1-2: Address & Coordinates
                address: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123",
                road_address: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ëž€ë¡œ 123",
                sido: "ì„œìš¸íŠ¹ë³„ì‹œ",
                sigungu: "ê°•ë‚¨êµ¬",
                dong: "ì—­ì‚¼ë™",
                coordinates: { lat: 37.498, lon: 127.028 },
                coordinates_verified: true,
                address_source: "API",
                coordinates_source: "API",
                
                // STEP 3: Cadastral
                bonbun: "123",
                bubun: "0",
                jimok: "ëŒ€",
                area: 500,
                cadastral_source: "API",
                
                // STEP 4: Zoning & Legal
                zone_type: "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
                zone_detail: "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
                land_use: "ì£¼ê±°ìš©",  // â† í•„ìˆ˜ í•„ë“œ!
                far: 200,
                bcr: 60,
                height_limit: null,  // â† nullë¡œ ë³€ê²½ (0ì€ validation ì—ëŸ¬)
                regulations: [],
                restrictions: [],
                zoning_source: "API",
                
                // STEP 5: Road Access
                road_contact: "ì ‘ë„",
                road_width: 12,
                road_type: "ì¼ë°˜ë„ë¡œ",
                nearby_roads: [],
                road_source: "API",
                
                // STEP 6: Market Data
                official_land_price: 1000000,
                official_land_price_date: "2024-01-01",
                official_price_source: "API",
                transaction_cases_appraisal: [],
                transaction_cases_reference: [],
                
                // Premium factors
                corner_lot: false,
                wide_road: false,
                
                // Metadata
                created_by: "debug_test"
            };

            try {
                const response = await fetch(`${BACKEND_URL}/api/m1/freeze-context-v2`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log(`âœ… M1 Freeze Success!`, 'success');
                log(`ðŸ“¦ Context ID: ${data.context_id}`, 'success');
                log(`ðŸ“¦ Parcel ID: ${data.parcel_id}`, 'success');
                log(`ðŸ“Š Confidence: ${data.confidence_score}`, 'success');
                setStatus('M1 Freeze: SUCCESS', 'success');
                
                // Store for next test
                window.lastContextId = data.context_id;
                window.lastParcelId = data.parcel_id;
                
            } catch (error) {
                log(`âŒ M1 Freeze Failed: ${error.message}`, 'error');
                setStatus('M1 Freeze: FAILED', 'error');
            }
        }

        async function testPipelineAnalyze() {
            if (!window.lastParcelId) {
                log('âš ï¸ Run "Test M1 Freeze" first!', 'error');
                return;
            }

            log('ðŸš€ Testing Pipeline Analyze API...', 'info');
            setStatus('Testing Pipeline Analyze...', 'info');

            const requestBody = {
                parcel_id: window.lastParcelId,
                use_cache: false,
                mock_land_data: {
                    address: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123",
                    coordinates: { lat: 37.498, lon: 127.028 },
                    area: 500,
                    zone_type: "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
                    far: 200,
                    bcr: 60,
                    road_width: 12,
                    bonbun: "123",
                    jimok: "ëŒ€"
                }
            };

            log(`ðŸ“¦ Parcel ID: ${window.lastParcelId}`, 'info');

            try {
                const startTime = Date.now();
                const response = await fetch(`${BACKEND_URL}/api/v4/pipeline/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const elapsed = Date.now() - startTime;

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData, null, 2));
                }

                const data = await response.json();
                log(`âœ… Pipeline Analyze Success! (${elapsed}ms)`, 'success');
                log(`ðŸ“Š Status: ${data.status}`, 'success');
                log(`ðŸ“Š Analysis ID: ${data.analysis_id}`, 'success');
                log(`ðŸ“Š Modules Executed: ${data.modules_executed}`, 'success');
                log(`ðŸ“Š Land Value: ${data.land_value?.toLocaleString()} ì›`, 'success');
                log(`ðŸ“Š Housing Type: ${data.selected_housing_type}`, 'success');
                log(`ðŸ“Š LH Decision: ${data.lh_decision}`, 'success');
                setStatus('Pipeline Analyze: SUCCESS', 'success');
                
            } catch (error) {
                log(`âŒ Pipeline Analyze Failed: ${error.message}`, 'error');
                setStatus('Pipeline Analyze: FAILED', 'error');
            }
        }

        async function testFullFlow() {
            clearLogs();
            log('ðŸš€ Starting Full Flow Test...', 'info');
            await testM1Freeze();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testPipelineAnalyze();
            log('âœ… Full Flow Test Complete!', 'success');
        }

        // Auto-run on load
        log('âœ… Debug page loaded', 'success');
        log(`ðŸ”— Backend URL: ${BACKEND_URL}`, 'info');
    </script>
</body>
</html>
