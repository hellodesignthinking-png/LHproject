# ZeroSite v23: Sensitivity Analysis & Dynamic CAPEX Implementation

## 🎯 목표
LH 신축매입임대 사업 분석 엔진의 핵심 재무 로직 개선:
1. **민감도 분석 추가**: CAPEX ±10%, 감정평가율 ±5% 시나리오
2. **CAPEX 동적 계산**: 시장가 기반 토지비 동적 산정
3. **건축비 검증**: LH 인정 건축비 기준 검증 및 경고

---

## ✅ 구현 완료 사항

### 1. 민감도 분석 모듈 (`sensitivity_analysis.py`)
- **9가지 시나리오 자동 생성**
  - CAPEX ±10% (270억 / 300억 / 330억)
  - 감정평가율 ±5% (87% / 92% / 97%)
  - 총 9개 조합 (3×3 matrix)

- **재무 지표 계산**
  - 각 시나리오별 수익, ROI, IRR, NPV 계산
  - GO/NO-GO 의사결정 (Private IRR ≥ 8%, Policy IRR ≥ 2%)

- **Tornado 다이어그램**
  - 민감도 순위 분석 (CAPEX vs 감정평가율)
  - 각 요인별 수익 변동폭 시각화

### 2. Dynamic CAPEX 계산 모듈 (`dynamic_capex_calculator.py`)
- **시장가 기반 토지비 동적 계산**
  - 국토부 실거래가 데이터 활용
  - 협상 할인율 적용 (기본 5%)
  - CAPEX 토지비 비율 상한 설정 (기본 50%)
  - CAPEX 증액 필요 시 권장 금액 제시

- **LH 인정 건축비 검증**
  - LH 표준건축비: **350만원/㎡**
  - LH 인정 한도: **420만원/㎡** (표준 +20%)
  - 현재 CAPEX 건축비와 비교 검증
  - 초과 시 ERROR 상태 및 경고 메시지

- **CAPEX 세부 항목 조정**
  - 토지비를 동적 계산값으로 조정
  - 나머지 항목(건축비, 간접비, 설계비, 기타) 자동 재조정
  - 각 항목별 LH 기준 검증

### 3. 국토부 실거래가 API 통합 (`land_trade_api.py`)
- **3-Layer Land Valuation**
  1. **Market Value**: 국토부 실거래가 API 기반
  2. **LH Appraisal**: 시장가 × 감정평가율 (92%)
  3. **CAPEX Fallback**: 실거래가 부족 시 CAPEX 기반

- **데이터 신뢰도 평가**
  - HIGH: 10건 이상 실거래
  - MEDIUM: 3-9건 실거래
  - LOW: 1-2건 실거래
  - FALLBACK: 실거래 없음

- **지역 필터링**
  - 반경 기반 필터링 (기본 500m, 최대 2km)
  - 데이터 부족 시 자동 확장

### 4. 통합 테스트 스위트 (`test_v23_improvements.py`)
- **3개 테스트 케이스**
  - ✅ 민감도 분석 테스트
  - ✅ Dynamic CAPEX 계산 테스트
  - ✅ 메인 서비스 통합 테스트

- **모든 테스트 통과 확인**

---

## 📊 분석 결과 (강남 역삼동 825 프로젝트)

### 프로젝트 기본 정보
- 토지 면적: 1,100㎡
- 연면적: 2,200㎡
- 기준 CAPEX: 300억원
- 시장 토지가: 242억원

### 민감도 분석 결과

| 시나리오 | CAPEX | 감정평가율 | 수익 | ROI | 의사결정 |
|---------|-------|-----------|------|-----|---------|
| 최적 | 270억 | 97% | **+40.77억** | 15.10% | ✅ GO (Policy) |
| 기준 | 300억 | 92% | **-0.36억** | -0.12% | ❌ NO-GO |
| 최악 | 330억 | 87% | **-41.49억** | -12.57% | ❌ NO-GO |

**주요 발견**
- **CAPEX 민감도**: 60억원 변동폭 (±30억)
- **감정평가율 민감도**: 22.26억원 변동폭 (±11.13억)
- **결론**: **CAPEX 관리가 사업성 확보의 핵심**

### Dynamic CAPEX 분석 결과

#### 1. 시장가 기반 토지비 계산
```
시장 토지가:        242.00억원
협상 후 예상가:     229.90억원 (5% 할인)
CAPEX 토지비:       150.00억원 (50% 상한)
기존 토지비:         75.00억원 (25% 고정)
```

**⚠️ CAPEX 증액 권장**
- 현재 CAPEX: 300억원
- 권장 CAPEX: **460억원 (+160억원)**
- 이유: 토지비 비율 76.6% → 50% 제한

#### 2. LH 인정 건축비 검증
```
❌ ERROR: 건축비 과다

CAPEX 건축비:       750.0만원/㎡
LH 표준건축비:      350.0만원/㎡
LH 인정 한도:       420.0만원/㎡ (+20%)
초과액:            400.0만원/㎡ (114.3%)
```

**⚠️ 위험 경고**
- LH 매입가 < CAPEX 위험 (사업성 없음)
- 권장: 건축비를 **420만원/㎡ 이하로 조정**

---

## 🔧 기술적 개선사항

### 버그 수정
1. `app_v20_complete_service.py` IndentationError 수정
2. 누락된 `logger` 모듈 import 추가
3. `land_cost_won` 변수 초기화 추가

### 코드 품질
- 모든 모듈에 docstring 추가
- 타입 힌팅 적용
- 에러 핸들링 강화
- 로깅 체계 개선

---

## 📁 변경 파일 목록

### 신규 파일 (4개)
- `app/services_v13/sensitivity_analysis.py` (679줄)
- `app/services_v13/dynamic_capex_calculator.py` (512줄)
- `app/services_v13/land_trade_api.py` (425줄)
- `test_v23_improvements.py` (249줄)

### 수정 파일 (2개)
- `app_v20_complete_service.py` (+40줄)
- `app/services_v13/report_full/lh_expert_edition_v3.html.jinja2` (템플릿 변수 추가)

### 문서 파일 (2개)
- `docs/v23_토지가격_산정_상세_설계서.md` (23KB)
- `docs/v23_재무항목_계산_로직_분석서.md` (18KB)

**총 변경**: +3,905줄, -26줄

---

## 🧪 테스트 결과

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TEST SUMMARY
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   sensitivity_analysis: ✅ PASS
   dynamic_capex: ✅ PASS  
   integration: ✅ PASS

🎉 모든 테스트 통과!
```

---

## 📖 문서화

### 1. 토지가격 산정 상세 설계서
`docs/v23_토지가격_산정_상세_설계서.md`
- 3-Layer Land Valuation 상세 설명
- 실거래가 API 연동 로직
- 데이터 신뢰도 평가 기준
- 지역 필터링 알고리즘

### 2. 재무항목 계산 로직 분석서
`docs/v23_재무항목_계산_로직_분석서.md`
- CAPEX 세부 항목 분석
- ROI/IRR/NPV 계산 로직
- LH 인정 건축비 검증 기준
- 개선 전후 비교

---

## 🚀 다음 단계

### Phase 1: 통합 및 배포 (현재 PR)
- [x] 민감도 분석 모듈 구현
- [x] Dynamic CAPEX 계산 모듈 구현
- [x] LH 건축비 검증 구현
- [x] 통합 테스트 완료
- [x] 문서화 완료
- [ ] 코드 리뷰 및 승인
- [ ] main 브랜치 병합

### Phase 2: UI 개선 (후속 PR)
- [ ] 민감도 분석 결과 UI 추가
- [ ] Tornado 다이어그램 차트 추가
- [ ] Dynamic CAPEX 분석 결과 표시
- [ ] LH 건축비 검증 경고 UI

### Phase 3: 고도화 (향후 계획)
- [ ] NPV 정밀 계산 (할인율, 현금흐름)
- [ ] Financial Engine v9.0 통합
- [ ] 지역별 토지가격 DB 구축
- [ ] 머신러닝 기반 예측 모델

---

## 🔍 Review Checklist

- [ ] 코드 품질 및 가독성
- [ ] 테스트 커버리지 충분성
- [ ] 문서화 완성도
- [ ] 성능 및 효율성
- [ ] 보안 및 에러 핸들링
- [ ] 기존 기능 호환성

---

## 💡 Key Insights

1. **CAPEX가 사업성의 핵심 결정 요인**
   - CAPEX ±10% 변동 시 수익 변동폭 60억원
   - 감정평가율 ±5% 변동 시 수익 변동폭 22.26억원
   - **CAPEX 관리 효율성이 감정평가율의 2.7배 중요**

2. **현재 CAPEX 구조의 문제점**
   - 고정 25% 토지비 비율은 시장 현실 미반영
   - 건축비 750만원/㎡는 LH 기준 대비 114% 초과
   - **CAPEX 재구조화 필수**

3. **권장 개선 방향**
   - CAPEX 총액: 300억 → **460억원 증액**
   - 토지비: 75억 (25%) → **150억 (50% 상한)** 반영
   - 건축비: 750만원/㎡ → **420만원/㎡ 이하 조정**

---

## 📞 Contact

**Author**: ZeroSite AI Analysis System  
**Date**: 2025-12-10  
**Branch**: `v23_financial_rearchitecture`  
**Commit**: `2af7414`  

---

**이 PR은 ZeroSite v23의 핵심 재무 분석 로직을 대폭 개선하여, 보다 정확하고 신뢰할 수 있는 LH 신축매입임대 사업 분석을 제공합니다.**
