<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZeroSite - í† ì§€ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans KR", sans-serif;
            background: #f7fafc;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Step 1: í”„ë¡œì íŠ¸ ìš”ì•½ ì¹´ë“œ */
        .project-summary {
            background: white;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .summary-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .analysis-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
        }

        .badge-direct {
            background: #fff5e6;
            color: #d97706;
            border: 2px solid #fbbf24;
        }

        .badge-api {
            background: #e6f7ed;
            color: #059669;
            border: 2px solid #10b981;
        }

        .confidence-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .confidence-low {
            background: #fed7d7;
            color: #c53030;
        }

        .confidence-high {
            background: #c6f6d5;
            color: #2f855a;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .summary-item {
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
        }

        .summary-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .summary-value {
            font-size: 16px;
            color: #1a202c;
            font-weight: 600;
            word-break: break-all;
        }

        /* Step 3: Direct Input ê²½ê³  */
        .warning-banner {
            background: linear-gradient(135deg, #fff5e6 0%, #ffedd5 100%);
            border: 2px solid #fb923c;
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
            display: none;
        }

        .warning-banner.active {
            display: block;
        }

        .warning-title {
            font-size: 16px;
            font-weight: 700;
            color: #c2410c;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .warning-list {
            list-style: none;
            color: #7c2d12;
            line-height: 1.8;
        }

        .warning-list li {
            padding-left: 20px;
            position: relative;
        }

        .warning-list li::before {
            content: "â€¢";
            position: absolute;
            left: 0;
            font-weight: 700;
        }

        /* Step 2: ë³´ê³ ì„œ ì¹´ë“œ í‘œì¤€í™” */
        .reports-section {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .section-subtitle {
            font-size: 14px;
            color: #718096;
        }

        .report-grid {
            display: grid;
            gap: 16px;
        }

        .report-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }

        .report-card:hover {
            border-color: #cbd5e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .report-info {
            flex: 1;
        }

        .report-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            margin-right: 12px;
        }

        .report-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-description {
            font-size: 14px;
            color: #718096;
            line-height: 1.6;
        }

        .report-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .btn-share {
            background: #fff5e6;
            color: #d97706;
            border: 2px solid #fbbf24;
        }

        .btn-share:hover {
            background: #ffedd5;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Step 4: ê³µìœ  ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: #718096;
        }

        .modal-warning {
            background: #fff5e6;
            border-left: 4px solid #fb923c;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .modal-warning-title {
            font-size: 14px;
            font-weight: 600;
            color: #c2410c;
            margin-bottom: 8px;
        }

        .modal-warning-list {
            list-style: none;
            font-size: 13px;
            color: #7c2d12;
            line-height: 1.8;
        }

        .modal-warning-list li::before {
            content: "â€¢ ";
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .share-result {
            background: #e6f7ed;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            display: none;
        }

        .share-result.active {
            display: block;
        }

        .share-url {
            font-size: 13px;
            color: #065f46;
            word-break: break-all;
            margin: 8px 0;
            padding: 12px;
            background: white;
            border-radius: 6px;
            font-family: monospace;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-full {
            flex: 1;
        }

        /* Step 5: ì—ëŸ¬ ìƒíƒœ */
        .error-card {
            background: #fed7d7;
            border: 2px solid #fc8181;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .error-title {
            font-size: 16px;
            font-weight: 700;
            color: #c53030;
            margin-bottom: 8px;
        }

        .error-message {
            font-size: 14px;
            color: #742a2a;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }

            .summary-header {
                flex-direction: column;
                gap: 16px;
            }

            .report-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Step 1: í”„ë¡œì íŠ¸ ìš”ì•½ ì¹´ë“œ -->
        <div class="project-summary">
            <div class="summary-header">
                <div>
                    <div class="summary-title">
                        <span id="project-title">í”„ë¡œì íŠ¸ ë¶„ì„</span>
                    </div>
                    <div>
                        <span class="analysis-badge" id="analysis-badge">
                            <span id="badge-icon">ğŸ§ª</span>
                            <span id="badge-text">ë¶„ì„ ë°©ì‹ ë¡œë”© ì¤‘...</span>
                        </span>
                        <span class="confidence-badge" id="confidence-badge" style="display: none;">
                            ì‹ ë¢°ë„: <span id="confidence-value">-</span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">RUN_ID</div>
                    <div class="summary-value" id="summary-run-id">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ì£¼ì†Œ</div>
                    <div class="summary-value" id="summary-address">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ë¶„ì„ ì‹œê°</div>
                    <div class="summary-value" id="summary-timestamp">-</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ë©´ì </div>
                    <div class="summary-value" id="summary-area">-</div>
                </div>
            </div>
        </div>

        <!-- Step 3: Direct Input ê²½ê³  -->
        <div class="warning-banner" id="direct-warning">
            <div class="warning-title">
                <span>âš ï¸</span>
                <span>ì´ í”„ë¡œì íŠ¸ëŠ” 'ì§ì ‘ ì…ë ¥ ì£¼ì†Œ'ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ëœ ì°¸ê³ ìš© ë¶„ì„ì…ë‹ˆë‹¤</span>
            </div>
            <ul class="warning-list">
                <li>ì™¸ë¶€ í–‰ì • API(Kakao, VWorld, Data.go.kr)ë¥¼ ì¡°íšŒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</li>
                <li>PNU, ì¢Œí‘œ, ê³µì‹œì§€ê°€ ë“±ì€ ì¶”ì •ê°’ì…ë‹ˆë‹¤</li>
                <li>ë²•ì Â·í–‰ì •ì  íš¨ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</li>
                <li>ê²€í† /ì•„ì´ë””ì–´ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”</li>
            </ul>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading-state">
            <div class="spinner"></div>
            <div>ëŒ€ì‹œë³´ë“œ ë¡œë”© ì¤‘...</div>
        </div>

        <!-- Error State -->
        <div id="error-container"></div>

        <!-- Step 2: ë³´ê³ ì„œ ì„¹ì…˜ -->
        <div class="reports-section" id="reports-section" style="display: none;">
            <div class="section-header">
                <div class="section-title">ğŸ“Š 6ì¢… ë³´ê³ ì„œ</div>
                <div class="section-subtitle">ê° ë³´ê³ ì„œëŠ” ì„œë¡œ ë‹¤ë¥¸ ëª©ì ê³¼ ëŒ€ìƒì„ ìœ„í•´ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤</div>
            </div>

            <div class="report-grid" id="report-grid">
                <!-- Reports will be dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- Step 4: ê³µìœ  ëª¨ë‹¬ -->
    <div class="modal" id="share-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ”— ì™¸ë¶€ ê³µìœ  ë§í¬ ìƒì„±</div>
                <div class="modal-subtitle">ë¡œê·¸ì¸ ì—†ì´ ëˆ„êµ¬ë‚˜ ë³¼ ìˆ˜ ìˆëŠ” ë§í¬ë¥¼ ë§Œë“­ë‹ˆë‹¤</div>
            </div>

            <div class="modal-warning">
                <div class="modal-warning-title">âš ï¸ ê³µìœ  ì „ í™•ì¸ì‚¬í•­</div>
                <ul class="modal-warning-list">
                    <li>ì´ ë§í¬ëŠ” ë¡œê·¸ì¸ ì—†ì´ ì™¸ë¶€ì— ì „ë‹¬ë©ë‹ˆë‹¤</li>
                    <li>ì½ê¸° ì „ìš© (ìˆ˜ì • ë¶ˆê°€)</li>
                    <li>ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥</li>
                    <li>ë§Œë£Œ ì‹œ ìë™ ì°¨ë‹¨ë©ë‹ˆë‹¤</li>
                </ul>
            </div>

            <div class="form-group">
                <label class="form-label" for="expires-select">ìœ íš¨ ê¸°ê°„ ì„ íƒ</label>
                <select class="form-select" id="expires-select">
                    <option value="24">24ì‹œê°„</option>
                    <option value="168" selected>7ì¼</option>
                    <option value="720">30ì¼</option>
                </select>
            </div>

            <div class="share-result" id="share-result">
                <div style="font-weight: 600; margin-bottom: 8px; color: #065f46;">âœ… ê³µìœ  ë§í¬ ìƒì„± ì™„ë£Œ!</div>
                <div class="share-url" id="share-url-display">-</div>
                <div style="font-size: 12px; color: #065f46; margin-top: 8px;">
                    ë§Œë£Œ: <span id="expires-at-display">-</span>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary btn-full" onclick="closeShareModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary btn-full" id="create-share-btn" onclick="createShareLink()">ë§í¬ ìƒì„±</button>
                <button class="btn btn-share btn-full" id="copy-share-btn" onclick="copyShareUrl()" style="display: none;">ğŸ“‹ ë³µì‚¬</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = window.ZEROSITE_CONFIG || {
            defaultUser: 'admin@zerosite.com',
            apiBasePath: '/api/v4'
        };

        // Global state
        let currentRunId = null;
        let currentShareReport = null;
        let runIdData = null;

        // Report definitions
        const REPORTS = [
            {
                code: 'A',
                name: 'ì¢…í•© ìµœì¢… ë³´ê³ ì„œ',
                description: 'ì „ì²´ ë¶„ì„ ê²°ê³¼ë¥¼ í¬í•¨í•œ ë§ˆìŠ¤í„° ë³´ê³ ì„œ (ê´€ë¦¬ì ì „ìš©)',
                roles: ['ADMIN', 'INTERNAL']
            },
            {
                code: 'B',
                name: 'í† ì§€ì£¼ ë³´ê³ ì„œ',
                description: 'í† ì§€ ì†Œìœ ìë¥¼ ìœ„í•œ í•µì‹¬ ì •ë³´ ìš”ì•½',
                roles: ['ADMIN', 'INTERNAL', 'LANDOWNER']
            },
            {
                code: 'C',
                name: 'LH ê¸°ìˆ ê²€í†  ë³´ê³ ì„œ',
                description: 'LH ê³µì‚¬ ê¸°ìˆ  ê²€í† ìš© ìƒì„¸ ë¶„ì„',
                roles: ['ADMIN', 'INTERNAL', 'LH']
            },
            {
                code: 'D',
                name: 'ì‹œì¥ ë¶„ì„ ë³´ê³ ì„œ',
                description: 'ì‹œì¥ ë™í–¥ ë° íˆ¬ì ê°€ì¹˜ ë¶„ì„ (ëª¨ë“  ì—­í•  ì ‘ê·¼ ê°€ëŠ¥)',
                roles: ['ADMIN', 'INTERNAL', 'LANDOWNER', 'LH', 'INVESTOR']
            },
            {
                code: 'E',
                name: 'LH ì œì¶œ ë³´ê³ ì„œ',
                description: 'LH ê³µì‚¬ ì œì¶œìš© ê³µì‹ ì„œë¥˜',
                roles: ['ADMIN', 'LH']
            },
            {
                code: 'F',
                name: 'íˆ¬ìì í”„ë ˆì  í…Œì´ì…˜',
                description: 'ì™¸ë¶€ ê³µìœ ìš© ìš”ì•½ ìë£Œ (ê³µìœ  ê¸°ëŠ¥ ì§€ì›)',
                roles: ['ADMIN', 'INTERNAL', 'INVESTOR'],
                shareable: true
            }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const runId = urlParams.get('run_id');
            const user = urlParams.get('user') || config.defaultUser;

            if (user) {
                config.defaultUser = user;
            }

            if (runId) {
                currentRunId = runId;
                loadDashboard(runId);
            } else {
                showError('RUN_IDê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'ëŒ€ì‹œë³´ë“œë¥¼ ë¡œë“œí•˜ë ¤ë©´ run_id íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            }
        });

        async function loadDashboard(runId) {
            try {
                // For DIRECT_ RUN_IDs, create fallback data from RUN_ID itself
                if (runId.startsWith('DIRECT_')) {
                    console.log('ğŸ“ DIRECT RUN_ID detected - using fallback data');
                    runIdData = {
                        run_id: runId,
                        address: 'ì§ì ‘ ì…ë ¥ ì£¼ì†Œ',
                        land_area: 500,
                        zone: 'ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­',
                        pnu: runId.split('_').pop(),
                        created_at: new Date().toISOString(),
                        status: 'ACTIVE',
                        has_data: true
                    };
                } else {
                    // Load RUN_ID data from service
                    const response = await fetch(`/api/v4/run-ids/info/${runId}`, {
                        headers: {
                            'X-User-Email': config.defaultUser
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`RUN_ID ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (${response.status})`);
                    }

                    runIdData = await response.json();
                }

                // Update UI
                updateProjectSummary(runIdData);
                renderReports();

                // Hide loading, show content
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('reports-section').style.display = 'block';

            } catch (error) {
                console.error('Dashboard load error:', error);
                showError('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨', error.message);
                document.getElementById('loading-state').style.display = 'none';
            }
        }

        function updateProjectSummary(data) {
            const isDirectInput = data.run_id && data.run_id.startsWith('DIRECT_');
            const confidence = isDirectInput ? 'LOW' : 'HIGH';

            // Update badges
            const badge = document.getElementById('analysis-badge');
            const badgeIcon = document.getElementById('badge-icon');
            const badgeText = document.getElementById('badge-text');
            
            if (isDirectInput) {
                badge.className = 'analysis-badge badge-direct';
                badgeIcon.textContent = 'âœï¸';
                badgeText.textContent = 'ì§ì ‘ ì…ë ¥ (ì°¸ê³ ìš©)';
            } else {
                badge.className = 'analysis-badge badge-api';
                badgeIcon.textContent = 'ğŸ”—';
                badgeText.textContent = 'API ê¸°ë°˜ (ì‹¤ì œ ë°ì´í„°)';
            }

            // Show confidence badge
            const confidenceBadge = document.getElementById('confidence-badge');
            const confidenceValue = document.getElementById('confidence-value');
            confidenceBadge.style.display = 'inline-block';
            confidenceValue.textContent = confidence;
            confidenceBadge.className = confidence === 'LOW' ? 'confidence-badge confidence-low' : 'confidence-badge confidence-high';

            // Update summary values
            document.getElementById('summary-run-id').textContent = data.run_id || '-';
            document.getElementById('summary-address').textContent = data.address || '-';
            document.getElementById('summary-timestamp').textContent = 
                data.created_at ? new Date(data.created_at).toLocaleString('ko-KR') : '-';
            document.getElementById('summary-area').textContent = 
                data.land_area ? `${data.land_area.toLocaleString()}ã¡` : '-';

            // Show warning for direct input
            if (isDirectInput) {
                document.getElementById('direct-warning').classList.add('active');
            }
        }

        function renderReports() {
            const grid = document.getElementById('report-grid');
            grid.innerHTML = '';

            REPORTS.forEach(report => {
                const card = createReportCard(report);
                grid.appendChild(card);
            });
        }

        function createReportCard(report) {
            const card = document.createElement('div');
            card.className = 'report-card';

            const hasAccess = checkReportAccess(report.roles);

            card.innerHTML = `
                <div class="report-header">
                    <div style="display: flex; align-items: flex-start; flex: 1;">
                        <div class="report-badge">${report.code}</div>
                        <div class="report-info">
                            <div class="report-title">${report.name}</div>
                            <div class="report-description">${report.description}</div>
                        </div>
                    </div>
                </div>
                <div class="report-actions">
                    <button class="btn btn-primary" onclick="openReport('${report.code}', 'html', '${currentRunId}', ${hasAccess})" ${!hasAccess ? 'disabled title="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"' : ''}>
                        ğŸ“„ HTML ë³´ê¸°
                    </button>
                    <button class="btn btn-secondary" onclick="openReport('${report.code}', 'pdf', '${currentRunId}', ${hasAccess})" ${!hasAccess ? 'disabled title="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤"' : ''}>
                        ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ
                    </button>
                    ${report.shareable && hasAccess ? `
                        <button class="btn btn-share" onclick="openShareModal('${report.code}', '${currentRunId}')">
                            ğŸ”— ê³µìœ í•˜ê¸°
                        </button>
                    ` : ''}
                </div>
            `;

            return card;
        }

        function checkReportAccess(allowedRoles) {
            // Simple role check - in production, this should come from backend
            const userEmail = config.defaultUser;
            
            if (userEmail.includes('admin')) return true;
            if (userEmail.includes('internal') && allowedRoles.includes('INTERNAL')) return true;
            if (userEmail.includes('landowner') && allowedRoles.includes('LANDOWNER')) return true;
            if (userEmail.includes('lh') && allowedRoles.includes('LH')) return true;
            if (userEmail.includes('investor') && allowedRoles.includes('INVESTOR')) return true;

            return allowedRoles.includes('ADMIN');
        }

        async function openReport(reportType, format, runId, hasAccess) {
            if (!hasAccess) {
                showError('ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ', 'ì´ ë³´ê³ ì„œëŠ” í˜„ì¬ ê¶Œí•œìœ¼ë¡œ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const url = `/api/v4/reports/six-types/${reportType}/${format}?context_id=${runId}`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'X-User-Email': config.defaultUser
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('ë³´ê³ ì„œê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¶„ì„ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                    }
                    throw new Error(`ë³´ê³ ì„œë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (${response.status})`);
                }

                if (format === 'html') {
                    const htmlContent = await response.text();
                    const newWindow = window.open();
                    newWindow.document.write(htmlContent);
                    newWindow.document.close();
                } else if (format === 'pdf') {
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = blobUrl;
                    a.download = `Report_${reportType}_${runId}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(blobUrl);
                }
            } catch (error) {
                console.error('Report open error:', error);
                showError('ë³´ê³ ì„œ ì—´ê¸° ì‹¤íŒ¨', error.message);
            }
        }

        function openShareModal(reportType, runId) {
            currentShareReport = { reportType, runId };
            document.getElementById('share-modal').classList.add('active');
            document.getElementById('share-result').classList.remove('active');
            document.getElementById('copy-share-btn').style.display = 'none';
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
            currentShareReport = null;
        }

        async function createShareLink() {
            if (!currentShareReport) return;

            const expiresInHours = parseInt(document.getElementById('expires-select').value);
            const createBtn = document.getElementById('create-share-btn');
            const copyBtn = document.getElementById('copy-share-btn');
            
            createBtn.disabled = true;
            createBtn.textContent = 'ìƒì„± ì¤‘...';

            try {
                const response = await fetch('/api/v4/share/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Email': config.defaultUser
                    },
                    body: JSON.stringify({
                        run_id: currentShareReport.runId,
                        report_type: currentShareReport.reportType,
                        expires_in_hours: expiresInHours
                    })
                });

                if (!response.ok) {
                    throw new Error(`ê³µìœ  ë§í¬ ìƒì„± ì‹¤íŒ¨ (${response.status})`);
                }

                const result = await response.json();
                
                document.getElementById('share-url-display').textContent = result.share_url;
                document.getElementById('expires-at-display').textContent = 
                    new Date(result.expires_at).toLocaleString('ko-KR');
                document.getElementById('share-result').classList.add('active');
                
                createBtn.textContent = 'âœ… ìƒì„± ì™„ë£Œ';
                copyBtn.style.display = 'inline-flex';

            } catch (error) {
                console.error('Share link creation error:', error);
                showError('ê³µìœ  ë§í¬ ìƒì„± ì‹¤íŒ¨', error.message);
                createBtn.disabled = false;
                createBtn.textContent = 'ë§í¬ ìƒì„±';
            }
        }

        function copyShareUrl() {
            const urlText = document.getElementById('share-url-display').textContent;
            navigator.clipboard.writeText(urlText).then(() => {
                const copyBtn = document.getElementById('copy-share-btn');
                copyBtn.textContent = 'âœ… ë³µì‚¬ ì™„ë£Œ';
                setTimeout(() => {
                    copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                }, 2000);
            });
        }

        function showError(title, message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `
                <div class="error-card">
                    <div class="error-title">${title}</div>
                    <div class="error-message">${message}</div>
                </div>
            `;
        }

        // Close modal on outside click
        document.getElementById('share-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeShareModal();
            }
        });
    </script>
</body>
</html>
