"""
Zone Type Estimator (Problem 3 í•´ê²° - ìš©ë„ì§€ì—­ ì •í™•í•œ ì¶”ì •)

Purpose: Sophisticated zone type estimation with regional mapping
Input: Address (sido, sigungu, dong)
Output: Accurate zone type classification

Author: ZeroSite Development Team
Date: 2024-12-14
"""

from typing import Optional
import logging

logger = logging.getLogger(__name__)


# ============================================================================
# ì§€ì—­ë³„ ìš©ë„ì§€ì—­ ë§¤í•‘ (Region-specific Zone Type Mapping)
# ============================================================================

REGIONAL_ZONE_MAPPING = {
    # ì„œìš¸ ì£¼ìš” ìƒì—…ì§€ì—­
    "ì„œìš¸íŠ¹ë³„ì‹œ": {
        "ê°•ë‚¨êµ¬": {
            "default": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì—­ì‚¼ë™": "ê·¼ë¦°ìƒì—…ì§€ì—­",
            "ì‚¼ì„±ë™": "ê·¼ë¦°ìƒì—…ì§€ì—­",
            "ì²­ë‹´ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ë…¼í˜„ë™": "ê·¼ë¦°ìƒì—…ì§€ì—­",
            "ì••êµ¬ì •ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ëŒ€ì¹˜ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
        },
        "ì„œì´ˆêµ¬": {
            "default": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì„œì´ˆë™": "ê·¼ë¦°ìƒì—…ì§€ì—­",
            "ë°˜í¬ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì ì›ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
        },
        "ì†¡íŒŒêµ¬": {
            "default": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì ì‹¤ë™": "ì¤€ì£¼ê±°ì§€ì—­",
            "ì‹ ì²œë™": "ê·¼ë¦°ìƒì—…ì§€ì—­"
        },
        "ì¤‘êµ¬": {
            "default": "ì¤‘ì‹¬ìƒì—…ì§€ì—­",
            "ëª…ë™": "ì¤‘ì‹¬ìƒì—…ì§€ì—­",
            "ì„ì§€ë¡œ": "ì¤‘ì‹¬ìƒì—…ì§€ì—­"
        },
        "ì¢…ë¡œêµ¬": {
            "default": "ì¤‘ì‹¬ìƒì—…ì§€ì—­",
            "ì²­ìš´ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
        },
        "ìš©ì‚°êµ¬": {
            "default": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "í•œë‚¨ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì´íƒœì›ë™": "ê·¼ë¦°ìƒì—…ì§€ì—­"
        },
        "ì˜ë“±í¬êµ¬": {
            "default": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì—¬ì˜ë„ë™": "ì¤‘ì‹¬ìƒì—…ì§€ì—­",
            "ì˜ë“±í¬ë™": "ê·¼ë¦°ìƒì—…ì§€ì—­"
        },
        "ê´€ì•…êµ¬": {
            "default": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì‹ ë¦¼ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ë´‰ì²œë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
        },
        "êµ¬ë¡œêµ¬": {
            "default": "ì¤€ê³µì—…ì§€ì—­",
            "êµ¬ë¡œë™": "ì¤€ê³µì—…ì§€ì—­",
            "ì‹ ë„ë¦¼ë™": "ê·¼ë¦°ìƒì—…ì§€ì—­"
        }
    },
    
    # ë¶€ì‚° ì£¼ìš” ì§€ì—­
    "ë¶€ì‚°ê´‘ì—­ì‹œ": {
        "í•´ìš´ëŒ€êµ¬": {
            "default": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ìš°ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì¤‘ë™": "ê·¼ë¦°ìƒì—…ì§€ì—­",
            "ì¢Œë™": "ì œ1ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
        },
        "ìˆ˜ì˜êµ¬": {
            "default": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ê´‘ì•ˆë™": "ê·¼ë¦°ìƒì—…ì§€ì—­"
        },
        "ì¤‘êµ¬": {
            "default": "ì¤‘ì‹¬ìƒì—…ì§€ì—­"
        }
    },
    
    # ê²½ê¸°ë„ ì£¼ìš” ì§€ì—­
    "ê²½ê¸°ë„": {
        "ì„±ë‚¨ì‹œ": {
            "default": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ë¶„ë‹¹êµ¬": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì •ìë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ìˆ˜ì •êµ¬": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
        },
        "ìš©ì¸ì‹œ": {
            "default": "ê³„íšê´€ë¦¬ì§€ì—­",
            "ìˆ˜ì§€êµ¬": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ê¸°í¥êµ¬": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
        },
        "ê³ ì–‘ì‹œ": {
            "default": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì¼ì‚°ë™êµ¬": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì¼ì‚°ì„œêµ¬": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
        },
        "ìˆ˜ì›ì‹œ": {
            "default": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì˜í†µêµ¬": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì¥ì•ˆêµ¬": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
        },
        "í™”ì„±ì‹œ": {
            "default": "ê³„íšê´€ë¦¬ì§€ì—­",
            "ë™íƒ„": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
        }
    },
    
    # ì œì£¼ ì§€ì—­
    "ì œì£¼íŠ¹ë³„ìì¹˜ë„": {
        "ì œì£¼ì‹œ": {
            "default": "ê³„íšê´€ë¦¬ì§€ì—­",
            "ì—°ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ë…¸í˜•ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
            "ì´ë„ë™": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
        },
        "ì„œê·€í¬ì‹œ": {
            "default": "ê³„íšê´€ë¦¬ì§€ì—­",
            "ì¤‘ë¬¸ë™": "ê´€ê´‘ìƒì—…ì§€ì—­"
        }
    }
}


# ============================================================================
# í‚¤ì›Œë“œ ê¸°ë°˜ ìš©ë„ì§€ì—­ ì¶”ì • (Keyword-based Estimation)
# ============================================================================

KEYWORD_TO_ZONE = {
    # ìƒì—… ê´€ë ¨ í‚¤ì›Œë“œ
    "ì—­": "ê·¼ë¦°ìƒì—…ì§€ì—­",
    "ì¤‘ì•™": "ì¤‘ì‹¬ìƒì—…ì§€ì—­",
    "ì‹œì¥": "ê·¼ë¦°ìƒì—…ì§€ì—­",
    "ìƒê°€": "ê·¼ë¦°ìƒì—…ì§€ì—­",
    "íƒ€ìš´": "ê·¼ë¦°ìƒì—…ì§€ì—­",
    "ì„¼í„°": "ê·¼ë¦°ìƒì—…ì§€ì—­",
    
    # ì£¼ê±° ê´€ë ¨ í‚¤ì›Œë“œ
    "ì•„íŒŒíŠ¸": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
    "ë¹Œë¼": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
    "ì£¼ê³µ": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
    "ë‹¨ì§€": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
    
    # ê³µì—… ê´€ë ¨ í‚¤ì›Œë“œ
    "ê³µë‹¨": "ì¼ë°˜ê³µì—…ì§€ì—­",
    "ì‚°ë‹¨": "ì „ìš©ê³µì—…ì§€ì—­",
    "ê³µì¥": "ì¤€ê³µì—…ì§€ì—­",
    "í…Œí¬ë…¸": "ì¤€ê³µì—…ì§€ì—­",
    
    # ë…¹ì§€/ê´€ë¦¬ ê´€ë ¨ í‚¤ì›Œë“œ
    "ì‚°": "ìì—°ë…¹ì§€ì§€ì—­",
    "ë†": "ê³„íšê´€ë¦¬ì§€ì—­",
    "ìˆ²": "ë³´ì „ë…¹ì§€ì§€ì—­"
}


# ============================================================================
# Sido ê¸°ë³¸ê°’ ë§¤í•‘ (Sido Default Mapping)
# ============================================================================

SIDO_DEFAULT_ZONES = {
    "ì„œìš¸íŠ¹ë³„ì‹œ": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
    "ë¶€ì‚°ê´‘ì—­ì‹œ": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
    "ì¸ì²œê´‘ì—­ì‹œ": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
    "ëŒ€êµ¬ê´‘ì—­ì‹œ": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
    "ê´‘ì£¼ê´‘ì—­ì‹œ": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
    "ëŒ€ì „ê´‘ì—­ì‹œ": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
    "ìš¸ì‚°ê´‘ì—­ì‹œ": "ì¤€ê³µì—…ì§€ì—­",
    "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ": "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­",
    "ê²½ê¸°ë„": "ê³„íšê´€ë¦¬ì§€ì—­",
    "ê°•ì›íŠ¹ë³„ìì¹˜ë„": "ê³„íšê´€ë¦¬ì§€ì—­",
    "ì¶©ì²­ë¶ë„": "ê³„íšê´€ë¦¬ì§€ì—­",
    "ì¶©ì²­ë‚¨ë„": "ê³„íšê´€ë¦¬ì§€ì—­",
    "ì „ë¶íŠ¹ë³„ìì¹˜ë„": "ê³„íšê´€ë¦¬ì§€ì—­",
    "ì „ë¼ë‚¨ë„": "ê³„íšê´€ë¦¬ì§€ì—­",
    "ê²½ìƒë¶ë„": "ê³„íšê´€ë¦¬ì§€ì—­",
    "ê²½ìƒë‚¨ë„": "ê³„íšê´€ë¦¬ì§€ì—­",
    "ì œì£¼íŠ¹ë³„ìì¹˜ë„": "ê³„íšê´€ë¦¬ì§€ì—­"
}


def estimate_zone_type(
    sido: Optional[str] = None,
    sigungu: Optional[str] = None,
    dong: Optional[str] = None,
    address_full: Optional[str] = None
) -> str:
    """
    ì£¼ì†Œ ê¸°ë°˜ ìš©ë„ì§€ì—­ ì¶”ì • (Problem 3 í•´ê²° - ì •êµí•œ ì¶”ì •)
    
    Estimation priority:
    1. Regional mapping (REGIONAL_ZONE_MAPPING)
    2. Keyword-based estimation (KEYWORD_TO_ZONE)
    3. Sido default (SIDO_DEFAULT_ZONES)
    4. Global fallback ("ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­")
    
    Args:
        sido: ì‹œÂ·ë„ (ì˜ˆ: "ì„œìš¸íŠ¹ë³„ì‹œ")
        sigungu: ì‹œÂ·êµ°Â·êµ¬ (ì˜ˆ: "ê°•ë‚¨êµ¬")
        dong: ìÂ·ë©´Â·ë™ (ì˜ˆ: "ì—­ì‚¼ë™")
        address_full: ì „ì²´ ì£¼ì†Œ (í‚¤ì›Œë“œ ë¶„ì„ìš©)
    
    Returns:
        ì¶”ì • ìš©ë„ì§€ì—­
    """
    
    logger.info(f"ğŸ” Estimating zone type for: {sido} {sigungu} {dong}")
    
    # Sido ë³„ì¹­ ì²˜ë¦¬
    sido_aliases = {
        "ì„œìš¸": "ì„œìš¸íŠ¹ë³„ì‹œ",
        "ë¶€ì‚°": "ë¶€ì‚°ê´‘ì—­ì‹œ",
        "ì¸ì²œ": "ì¸ì²œê´‘ì—­ì‹œ",
        "ëŒ€êµ¬": "ëŒ€êµ¬ê´‘ì—­ì‹œ",
        "ê´‘ì£¼": "ê´‘ì£¼ê´‘ì—­ì‹œ",
        "ëŒ€ì „": "ëŒ€ì „ê´‘ì—­ì‹œ",
        "ìš¸ì‚°": "ìš¸ì‚°ê´‘ì—­ì‹œ",
        "ê²½ê¸°": "ê²½ê¸°ë„",
        "ê°•ì›": "ê°•ì›íŠ¹ë³„ìì¹˜ë„",
        "ì œì£¼": "ì œì£¼íŠ¹ë³„ìì¹˜ë„"
    }
    
    if sido and sido in sido_aliases:
        sido = sido_aliases[sido]
    
    # 1. Regional Mapping (ìµœìš°ì„ )
    if sido and sigungu:
        if sido in REGIONAL_ZONE_MAPPING:
            sigungu_data = REGIONAL_ZONE_MAPPING[sido].get(sigungu)
            if sigungu_data:
                # Dong-level mapping
                if dong and dong in sigungu_data:
                    zone = sigungu_data[dong]
                    logger.info(f"âœ… Zone from regional mapping (dong): {zone}")
                    return zone
                
                # Sigungu-level default
                if "default" in sigungu_data:
                    zone = sigungu_data["default"]
                    logger.info(f"âœ… Zone from regional mapping (sigungu default): {zone}")
                    return zone
    
    # 2. Keyword-based Estimation
    if address_full or dong:
        search_text = address_full or dong or ""
        for keyword, zone in KEYWORD_TO_ZONE.items():
            if keyword in search_text:
                logger.info(f"âœ… Zone from keyword '{keyword}': {zone}")
                return zone
    
    # 3. Sido Default
    if sido and sido in SIDO_DEFAULT_ZONES:
        zone = SIDO_DEFAULT_ZONES[sido]
        logger.info(f"âœ… Zone from sido default: {zone}")
        return zone
    
    # 4. Global Fallback
    logger.warning(f"âš ï¸ No zone mapping found, using fallback: ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­")
    return "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"


def get_zone_characteristics(zone_type: str) -> dict:
    """
    ìš©ë„ì§€ì—­ë³„ íŠ¹ì„± ì •ë³´ ë°˜í™˜
    
    Args:
        zone_type: ìš©ë„ì§€ì—­
    
    Returns:
        dict with zone characteristics
    """
    
    zone_info = {
        # ì£¼ê±°ì§€ì—­
        "ì œ1ì¢…ì „ìš©ì£¼ê±°ì§€ì—­": {"category": "ì£¼ê±°", "far": 1.0, "bcr": 0.5, "description": "ì €ì¸µ ë‹¨ë…ì£¼íƒ ìœ„ì£¼"},
        "ì œ2ì¢…ì „ìš©ì£¼ê±°ì§€ì—­": {"category": "ì£¼ê±°", "far": 1.0, "bcr": 0.5, "description": "ì €ì¸µ ë‹¨ë…ì£¼íƒ ìœ„ì£¼"},
        "ì œ1ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­": {"category": "ì£¼ê±°", "far": 2.0, "bcr": 0.6, "description": "ì €ì¸µ ê³µë™ì£¼íƒ ìœ„ì£¼"},
        "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­": {"category": "ì£¼ê±°", "far": 2.5, "bcr": 0.6, "description": "ì¤‘ì¸µ ê³µë™ì£¼íƒ ìœ„ì£¼"},
        "ì œ3ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­": {"category": "ì£¼ê±°", "far": 3.0, "bcr": 0.5, "description": "ê³ ì¸µ ê³µë™ì£¼íƒ ìœ„ì£¼"},
        "ì¤€ì£¼ê±°ì§€ì—­": {"category": "ì£¼ê±°", "far": 5.0, "bcr": 0.7, "description": "ìƒì—…+ì£¼ê±° ë³µí•©"},
        
        # ìƒì—…ì§€ì—­
        "ì¤‘ì‹¬ìƒì—…ì§€ì—­": {"category": "ìƒì—…", "far": 15.0, "bcr": 0.9, "description": "ë„ì‹¬ í•µì‹¬ ìƒê¶Œ"},
        "ê·¼ë¦°ìƒì—…ì§€ì—­": {"category": "ìƒì—…", "far": 9.0, "bcr": 0.7, "description": "ê·¼ë¦° ìƒí™œ ìƒê¶Œ"},
        "ì¼ë°˜ìƒì—…ì§€ì—­": {"category": "ìƒì—…", "far": 12.0, "bcr": 0.8, "description": "ì¼ë°˜ ìƒì—… í™œë™"},
        "ìœ í†µìƒì—…ì§€ì—­": {"category": "ìƒì—…", "far": 8.0, "bcr": 0.7, "description": "ë„ì†Œë§¤ ìœ í†µ"},
        
        # ê³µì—…ì§€ì—­
        "ì „ìš©ê³µì—…ì§€ì—­": {"category": "ê³µì—…", "far": 3.0, "bcr": 0.7, "description": "ì¤‘í™”í•™ ê³µì—…"},
        "ì¼ë°˜ê³µì—…ì§€ì—­": {"category": "ê³µì—…", "far": 3.5, "bcr": 0.7, "description": "ì¼ë°˜ ê³µì—…"},
        "ì¤€ê³µì—…ì§€ì—­": {"category": "ê³µì—…", "far": 4.0, "bcr": 0.7, "description": "ê²½ê³µì—…+ì£¼ê±° ë³µí•©"},
        
        # ë…¹ì§€ì§€ì—­
        "ë³´ì „ë…¹ì§€ì§€ì—­": {"category": "ë…¹ì§€", "far": 0.8, "bcr": 0.2, "description": "ìì—°í™˜ê²½ ë³´ì „"},
        "ìƒì‚°ë…¹ì§€ì§€ì—­": {"category": "ë…¹ì§€", "far": 1.0, "bcr": 0.2, "description": "ë†ì—… ìƒì‚°"},
        "ìì—°ë…¹ì§€ì§€ì—­": {"category": "ë…¹ì§€", "far": 1.0, "bcr": 0.2, "description": "ë…¹ì§€ ë³´ì „ + ì œí•œì  ê°œë°œ"},
        
        # ê´€ë¦¬ì§€ì—­
        "ë³´ì „ê´€ë¦¬ì§€ì—­": {"category": "ê´€ë¦¬", "far": 0.8, "bcr": 0.2, "description": "ìì—°í™˜ê²½ ë³´ì „"},
        "ìƒì‚°ê´€ë¦¬ì§€ì—­": {"category": "ê´€ë¦¬", "far": 0.8, "bcr": 0.2, "description": "ë†ë¦¼ì—… ìƒì‚°"},
        "ê³„íšê´€ë¦¬ì§€ì—­": {"category": "ê´€ë¦¬", "far": 1.0, "bcr": 0.4, "description": "ê³„íšì  ê°œë°œ ì˜ˆì •"}
    }
    
    return zone_info.get(zone_type, {
        "category": "ê¸°íƒ€",
        "far": 2.0,
        "bcr": 0.6,
        "description": "ì¼ë°˜ ì§€ì—­"
    })


# ============================================================================
# TEST CODE
# ============================================================================

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')
    
    print("=" * 80)
    print("ZeroSite Zone Estimator Test (Problem 3 í•´ê²°)")
    print("=" * 80)
    
    test_cases = [
        ("ì„œìš¸íŠ¹ë³„ì‹œ", "ê°•ë‚¨êµ¬", "ì—­ì‚¼ë™"),
        ("ì„œìš¸íŠ¹ë³„ì‹œ", "ê´€ì•…êµ¬", "ì‹ ë¦¼ë™"),
        ("ë¶€ì‚°ê´‘ì—­ì‹œ", "í•´ìš´ëŒ€êµ¬", "ìš°ë™"),
        ("ê²½ê¸°ë„", "ì„±ë‚¨ì‹œ", "ì •ìë™"),
        ("ì œì£¼íŠ¹ë³„ìì¹˜ë„", "ì œì£¼ì‹œ", "ì—°ë™"),
    ]
    
    for sido, sigungu, dong in test_cases:
        zone = estimate_zone_type(sido, sigungu, dong)
        characteristics = get_zone_characteristics(zone)
        
        print(f"\n{sido} {sigungu} {dong}")
        print(f"  â†’ Zone: {zone}")
        print(f"  â†’ Category: {characteristics['category']}")
        print(f"  â†’ FAR: {characteristics['far']} / BCR: {characteristics['bcr']}")
        print(f"  â†’ Description: {characteristics['description']}")
    
    print("\n" + "=" * 80)
    print("Test Complete")
    print("=" * 80)
