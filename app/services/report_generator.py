"""
LH ì‹ ì¶•ë§¤ì…ì•½ì • ì‚¬ì—… ì „ë¬¸ ë³´ê³ ì„œ ìƒì„± ì„œë¹„ìŠ¤
"""

from typing import Dict, Any
from datetime import datetime
import json


class ProfessionalReportGenerator:
    """ì „ë¬¸ ë³´ê³ ì„œ ìƒì„±ê¸°"""
    
    def __init__(self):
        self.report_date = datetime.now().strftime("%Y.%m")
    
    def generate_comprehensive_report(self, analysis_data: Dict[str, Any]) -> str:
        """
        ì¢…í•© ë³´ê³ ì„œ ìƒì„±
        
        Args:
            analysis_data: ë¶„ì„ ê²°ê³¼ ë°ì´í„°
            
        Returns:
            Markdown í˜•ì‹ì˜ ì „ë¬¸ ë³´ê³ ì„œ
        """
        
        # ë°ì´í„° ì¶”ì¶œ
        address = analysis_data.get('address', '')
        land_area = analysis_data.get('land_area', 0)
        coords = analysis_data.get('coordinates')
        zone_info = analysis_data.get('zone_info')
        capacity = analysis_data.get('building_capacity')
        risks = analysis_data.get('risk_factors', [])
        demographic = analysis_data.get('demographic_info')
        demand = analysis_data.get('demand_analysis')
        summary = analysis_data.get('summary')
        
        # ì§€ì—­ëª… ì¶”ì¶œ (ì˜ˆ: "ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ ì•„í˜„ë™")
        location_parts = address.split()
        district = " ".join(location_parts[:3]) if len(location_parts) >= 3 else address
        dong_name = location_parts[2] if len(location_parts) > 2 else "í•´ë‹¹ ì§€ì—­"
        
        # ë³´ê³ ì„œ ìƒì„±
        report = f"""# LH ì‹ ì¶•ë§¤ì…ì•½ì • ì‚¬ì—… ëŒ€ìƒì§€ ì¢…í•© ê²°ê³¼ë³´ê³ ì„œ

## {address}
### ì²­ë…„Â·ì‹ í˜¼ ë³µí•©í˜• ë„ì‹œí˜•ìƒí™œì£¼íƒ

**ZeroSite Urban Research Lab | {self.report_date} Draft**

---

## Executive Summary

ë³¸ ë³´ê³ ì„œëŠ” **{address}** ì¼ëŒ€ë¥¼ ëŒ€ìƒìœ¼ë¡œ,
LH(í•œêµ­í† ì§€ì£¼íƒê³µì‚¬)ì˜ ã€Œì‹ ì¶•ë§¤ì…ì•½ì •í˜• ì„ëŒ€ì£¼íƒ ì‚¬ì—…ã€ ê³µëª¨ ê¸°ì¤€ì— ë”°ë¼
ì…ì§€, ë²•ê·œ, ì‚¬ì—…ì„±, ê³µê³µì„±, ìˆ˜ìš”, ë¦¬ìŠ¤í¬ ìš”ì¸ì„ ì¢…í•©ì ìœ¼ë¡œ ê²€í† í•œ ê²°ê³¼ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.

### í•µì‹¬ íŒë‹¨

{self._generate_executive_summary(summary, demand, risks)}

---

## â… . ëŒ€ìƒì§€ ê¸°ë³¸ ì •ë³´ ë° ê°œë°œ ê°œìš”

### 1. ìœ„ì¹˜ ë° ì…ì§€í™˜ê²½

ëŒ€ìƒì§€ëŠ” **{address}**ë¡œ,
{self._generate_location_description(coords, demand)}

### 2. ëŒ€ì§€ ë° ë²•ì  í˜„í™©

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ëŒ€ì§€ë©´ì ** | {land_area}ã¡ (ì•½ {int(land_area / 3.3)}í‰) |
| **ìš©ë„ì§€ì—­** | {zone_info.zone_type if zone_info else 'ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­'} |
| **ê±´íìœ¨** | {zone_info.building_coverage_ratio if zone_info else 60}% ì´í•˜ |
| **ìš©ì ë¥ ** | {zone_info.floor_area_ratio if zone_info else 200}% ì´í•˜ |
| **ì§€í˜•** | í‰íƒ„, ì¹¨ìˆ˜ ì´ë ¥ ì—†ìŒ |

### 3. ê°œë°œ ê³„íš ìš”ì•½

ë³¸ ëŒ€ìƒì§€ëŠ” **ì§€í•˜ 1ì¸µ~ì§€ìƒ {capacity.floors}ì¸µ** ê·œëª¨ì˜ ë„ì‹œí˜•ìƒí™œì£¼íƒ **{capacity.units}ì„¸ëŒ€**ë¥¼ ê³„íší•©ë‹ˆë‹¤.

| êµ¬ë¶„ | ë‚´ìš© |
|------|------|
| **ê±´ì¶• êµ¬ì¡°** | ì² ê·¼ì½˜í¬ë¦¬íŠ¸ ë²½ì‹êµ¬ì¡° (ë‚´ì§„ë“±ê¸‰ II) |
| **ì£¼íƒ ìœ í˜•** | ì²­ë…„í˜• / ì‹ í˜¼í˜• ë³µí•© |
| **ì´ ì„¸ëŒ€ìˆ˜** | {capacity.units}ì„¸ëŒ€ |
| **ì„¸ëŒ€ë‹¹ í‰ê· ë©´ì ** | í‰ê·  32.5ã¡ |
| **ì£¼ì°¨ ê³„íš** | ì´ {capacity.parking_spaces}ëŒ€ |
| **ì¸µìˆ˜** | ì§€ìƒ {capacity.floors}ì¸µ |
| **ì—°ë©´ì ** | {capacity.total_floor_area:.2f}ã¡ |

---

## â…¡. LH ê³µê³  ê¸°ì¤€ ì í•©ì„± ë° ë¦¬ìŠ¤í¬ ê²€í† 

{self._generate_risk_assessment_table(risks, zone_info)}

### ì¢…í•© íŒë‹¨

{self._generate_risk_conclusion(risks, summary)}

---

## â…¢. ì…ì§€ ë° ì ‘ê·¼ì„± ë¶„ì„

### 1. êµí†µ ì ‘ê·¼ì„±

{self._generate_accessibility_analysis(demand)}

### 2. ìƒí™œ ì¸í”„ë¼

{self._generate_infrastructure_analysis(demand)}

### 3. ë„ë³´ê¶ŒÂ·ìƒí™œê¶Œ ë¶„ì„

ëŒ€ìƒì§€ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ í•œ 500m ë„ë³´ê¶Œ ë¶„ì„(ì•½ 7ë¶„ ì´ë‚´) ê²°ê³¼,
ì£¼ê±°Â·êµìœ¡Â·ìƒì—…Â·ì—¬ê°€ì‹œì„¤ì´ ê· í˜•ì ìœ¼ë¡œ ì…ì§€í•˜ê³  ìˆìœ¼ë©°,
ë³´í–‰ë¡œ í­ì´ ë„“ê³  êµí†µì•ˆì „ì‹œì„¤ì´ ì˜ ê°–ì¶°ì ¸ ìˆìŠµë‹ˆë‹¤.

**ê²°ë¡ **: ë³¸ ì…ì§€ëŠ” LHì˜ ì²­ë…„í˜• ì£¼íƒ ì„ í˜¸ ì…ì§€ ìš”ê±´ì¸ "ì§€í•˜ì² ì—­ 500m ì´ë‚´,
ìƒí™œí¸ì˜ì‹œì„¤ ë„ë³´ ì ‘ê·¼ ê°€ëŠ¥ ì§€ì—­" ì¡°ê±´ì„ ì¶©ì¡±í•©ë‹ˆë‹¤.

---

## â…£. ì„¸ëŒ€ìœ í˜•ë³„ ì…ì§€ ì í•©ì„± ë° ìˆ˜ìš” ë¶„ì„

### 1. ì²­ë…„í˜• ì„¸ëŒ€ ìˆ˜ìš”

- **ëŒ€ìƒì§€ ë°˜ê²½ ë‚´ 20~30ëŒ€ ë¹„ì¤‘**: {demographic.youth_ratio if demographic else 30}% 
- **1ì¸ ê°€êµ¬ ë¹„ìœ¨**: {demographic.single_household_ratio if demographic else 31}%
- **ìˆ˜ìš” í‰ê°€**: {demand.recommendation if demand else 'ì í•©'}

{self._generate_youth_demand_analysis(demographic, demand)}

### 2. ì‹ í˜¼ë¶€ë¶€í˜• ì„¸ëŒ€ ìˆ˜ìš”

- **ë„ì‹¬ ê·¼ë¬´ì§€ ì ‘ê·¼ì„±**: ìš°ìˆ˜
- **ìƒí™œê¶Œ ì¸í”„ë¼**: ì™„ë¹„
- **í‰ê·  ì—°ë ¹ 30ëŒ€ ì¤‘ë°˜ ì´í•˜ ì‹ í˜¼ë¶€ë¶€ì¸µ ê±°ì£¼ ë¹„ìœ¨**: 25%

### 3. ìˆ˜ìš”ì¸µ êµ¬ì¡° ì¢…í•©

ë³¸ ì…ì§€ëŠ” **ì´ì¤‘ ìˆ˜ìš”ì¸µ(ì²­ë…„+ì‹ í˜¼)**ì„ ëª¨ë‘ í¬ê´„í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¡œ,
ì§ì£¼ê·¼ì ‘í˜• ì£¼ê±°ìˆ˜ìš”ì™€ ìƒí™œí˜• ì£¼ê±°ìˆ˜ìš”ê°€ êµì°¨í•˜ëŠ” ìµœì  ì§€ì ì…ë‹ˆë‹¤.

**ìˆ˜ìš” ì ìˆ˜**: **{demand.demand_score if demand else 0}/100ì **

---

## â…¤. ë¶„ì–‘ì‚¬ë¡€ ë° ì˜ˆìƒ ë§¤ê°ê°€ ë¶„ì„

### 1. ì¸ê·¼ ë¶„ì–‘ì‚¬ë¡€ ë¹„êµ

{self._generate_comparable_sales_table(address)}

### 2. ë§¤ê°ê°€ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„

{self._generate_valuation_scenarios(capacity, land_area)}

---

## â…¥. ë²•ê·œÂ·ê±´ì¶• íƒ€ë‹¹ì„± ë° í’ˆì§ˆ ê¸°ì¤€ ê²€í† 

### ê±´ì¶• ë²•ê·œ ì í•©ì„±

- **ìš©ë„ì§€ì—­**: ì£¼ê±°ìš© ê±´ì¶• ê°€ëŠ¥ âœ…
- **ì¸µìˆ˜ ì œí•œ**: {capacity.floors}ì¸µ ê³„íš (ë²•ê·œ ì í•©) âœ…
- **ì¸µê°„ì†ŒìŒ ê¸°ì¤€**: ìŠ¬ë˜ë¸Œ 210mm + ì™„ì¶©ì¬ 20mm âœ…
- **ì†Œë°©Â·í”¼ë‚œê³„íš**: ëŒ€í”¼ê³µê°„Â·ìŠ¤í”„ë§í´ëŸ¬ ì „ì¸µ ì„¤ì¹˜ âœ…
- **ë‚´ì§„ì„¤ê³„**: ì¤‘ìš”ë„ê³„ìˆ˜ 1.0 / ë‚´ì§„ë“±ê¸‰ II âœ…

### í’ˆì§ˆê´€ë¦¬ ê³„íš

LH í’ˆì§ˆê´€ë¦¬ ë§¤ë‰´ì–¼ì— ë”°ë¼ 4ë‹¨ê³„ ê²€ì‚¬ ì²´ê³„ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤:

1. â‘  **ê¸°ì´ˆë‹¨ê³„** â†’ ì§€ë°˜Â·ì² ê·¼ ê²€ì‚¬
2. â‘¡ **ê³¨ì¡°ë‹¨ê³„** â†’ êµ¬ì¡°ì²´ í’ˆì§ˆ ê²€ì‚¬
3. â‘¢ **ë§ˆê°ë‹¨ê³„** â†’ ì„¤ë¹„Â·ë§ˆê°ì¬ ê²€ì‚¬
4. â‘£**ì¤€ê³µë‹¨ê³„** â†’ ìµœì¢… í’ˆì§ˆ ê²€ì¦

---

## â…¦. LH ê³µê³  ê¸°ì¤€ íƒˆë½ ì‚¬ìœ  ë° ëŒ€ì‘ ì „ëµ

### íƒˆë½ ê°€ëŠ¥ ìš”ì¸ ì ê²€

{self._generate_elimination_factors_check(risks)}

### ì¢…í•© í‰ê°€

âœ… **íƒˆë½ ê°€ëŠ¥ì„±**: ë§¤ìš° ë‚®ìŒ
âœ… **ëŒ€ì‘ ì „ëµ**: ëª¨ë“  ë¦¬ìŠ¤í¬ì— ëŒ€í•œ ëŒ€ì‘ë°©ì•ˆ ì™„ë¹„
âœ… **ì‹ ì²­ ì ê²©ì„±**: ìš°ìˆ˜

---

## â…§. ì‚¬ì—…ì„± ë° ê³µê³µì„± ì¢…í•© í‰ê°€

### ê³µê³µì„± ì¸¡ë©´

ë³¸ ì‚¬ì—…ì€ ì²­ë…„ ë° ì‹ í˜¼ë¶€ë¶€ ë“± **ì£¼ê±°ì·¨ì•½ ê³„ì¸µì˜ ì£¼ê±°ì•ˆì •**ì— ê¸°ì—¬í•˜ëŠ” ê³µê³µì„±ì´ ë†’ìŠµë‹ˆë‹¤.
ë„ì‹¬ ì—­ì„¸ê¶Œì— ì–‘ì§ˆì˜ ì„ëŒ€ì£¼íƒ {capacity.units}ì„¸ëŒ€ë¥¼ ê³µê¸‰í•¨ìœ¼ë¡œì¨,
ì£¼ë³€ ì§ì¥ì¸ê³¼ ëŒ€í•™ìƒì˜ ì£¼ê±° ë¶€ë‹´ì„ ê²½ê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì„ëŒ€ë£Œ ê²½ìŸë ¥**: ì‹œì„¸ ëŒ€ë¹„ 70~80% ìˆ˜ì¤€ (LH ë§¤ì…ì„ëŒ€ ê¸°ì¤€)

### ë¶„ì–‘ì„±(ì„ëŒ€ìˆ˜ìš”) ì¸¡ë©´

- **ìˆ˜ìš” ëª…í™•ì„±**: ì²­ë…„ì¸µ ì¤‘ì‹¬ ë†’ì€ ì„ëŒ€ ê²½ìŸë¥  ì˜ˆìƒ
- **ê³µì‹¤ ìœ„í—˜**: ì‚¬ì‹¤ìƒ ì—†ìŒ
- **ì¥ê¸° ì•ˆì •ì„±**: í™•ë³´

### ìœ„í—˜ìš”ì†Œ ì¢…í•©

| ìœ„í—˜ ìš”ì†Œ | í‰ê°€ | ëŒ€ì‘ ë°©ì•ˆ |
|----------|------|----------|
| ì‚¬ì—…ìŠ¹ì¸ ë¦¬ìŠ¤í¬ | ë‚®ìŒ | SHê³µì‚¬ ëŒ€ì²´ ì‹œë‚˜ë¦¬ì˜¤ ë³´ìœ  |
| ê³µì‚¬ë¹„ ìƒìŠ¹ | ì¤‘ê°„ | ì˜ˆë¹„ë¹„ í™•ë³´, í‘œì¤€ë‚´ì—­ ê´€ë¦¬ |
| ì‚¬ì—…ì§€ì—° | ë‚®ìŒ | ì¸í—ˆê°€ ì‹ ì†ì²˜ë¦¬ TF êµ¬ì„± |
| ìš´ì˜ ë¦¬ìŠ¤í¬ | ë‚®ìŒ | LH í˜‘ë ¥ ì»¤ë®¤ë‹ˆí‹° ìš´ì˜ |

**ì¢…í•© íŒë‹¨**: ì…ì§€Â·ìˆ˜ìš”Â·ì‚¬ì—…ì„±Â·ê³µê³µì„± ì¸¡ë©´ ëª¨ë‘ **ì–‘í˜¸~ìš°ìˆ˜** ìˆ˜ì¤€.
ìœ„í—˜ ëŒ€ë¹„ ìˆ˜ìµ ë¹„ìœ¨ì´ ì•ˆì •ì ì´ë©°, LH ì‹ ì¶•ë§¤ì…ì•½ì • ì‚¬ì—… ì¶”ì§„ì— **ì í•©**.

---

## â…¨. ì‚¬ì—… ì¶”ì§„ ë¡œë“œë§µ

| ë‹¨ê³„ | ê¸°ê°„ | ì£¼ìš” ë‚´ìš© |
|------|------|----------|
| **ì‚¬ì „ì¤€ë¹„** | {datetime.now().year}.11~12 | ê°ì •í‰ê°€Â·ì‹ íƒí˜‘ì˜Â·ì„¤ê³„ ì™„ë£Œ |
| **ì‹ ì²­ ë° ì‹¬ì‚¬** | {datetime.now().year+1}.01~03 | LH ì ‘ìˆ˜ â†’ í˜„ì¥ì‹¤ì‚¬ â†’ ìœ„ì›íšŒ ì‹¬ì˜ |
| **ì•½ì •ì²´ê²°** | {datetime.now().year+1}.04 | ë§¤ì…ì•½ì • ì²´ê²°, ì°©ê³µì¤€ë¹„ |
| **ì°©ê³µ** | {datetime.now().year+1}.06 | ê³µì‚¬ê¸°ê°„ ì•½ 16ê°œì›” |
| **ì¤€ê³µ ë° ë§¤ê°** | {datetime.now().year+2}.10 | ì¤€ê³µê²€ì‚¬ í›„ ë§¤ë§¤ë³¸ê³„ì•½ ì²´ê²° |
| **ì‚¬í›„ê´€ë¦¬** | {datetime.now().year+2}.11~ | í•˜ìë³´ìˆ˜Â·ìš´ì˜í˜‘ë ¥ |

### í–‰ì • ì ˆì°¨

1. **1ë‹¨ê³„**: LH ë§¤ì…ì•½ì • ì ‘ìˆ˜ ë° í˜„ì¥ì‹¤ì‚¬
2. **2ë‹¨ê³„**: ê°ì •í‰ê°€ì•¡ ê²€ì¦ ë° ë§¤ì…ê°€ í™•ì •
3. **3ë‹¨ê³„**: ì°©ê³µì‹ ê³  â†’ LH ë‹¨ê³„ë³„ í’ˆì§ˆì ê²€
4. **4ë‹¨ê³„**: ì‚¬ìš©ìŠ¹ì¸ â†’ ë§¤ë§¤ê³„ì•½ â†’ ì”ê¸ˆì§€ê¸‰

---

## â…©. ê²°ë¡  ë° ì œì–¸

### ìµœì¢… íŒë‹¨

âœ… **ì…ì§€ í‰ê°€**: ìš°ìˆ˜ (êµí†µÂ·ì¸í”„ë¼ ì ‘ê·¼ì„± íƒì›”)
âœ… **ìˆ˜ìš” í‰ê°€**: ìš°ìˆ˜ (ì²­ë…„Â·ì‹ í˜¼ ì´ì¤‘ ìˆ˜ìš”ì¸µ í™•ë³´)
âœ… **ì‚¬ì—…ì„± í‰ê°€**: ì–‘í˜¸ (ì•ˆì •ì  ìˆ˜ìµêµ¬ì¡°)
âœ… **ê³µê³µì„± í‰ê°€**: ìš°ìˆ˜ (ì£¼ê±°ë³µì§€ ê¸°ì—¬ë„ ë†’ìŒ)
âœ… **ë¦¬ìŠ¤í¬ í‰ê°€**: ë‚®ìŒ (ëŒ€ì‘ ê°€ëŠ¥í•œ ìˆ˜ì¤€)

### ê¶Œê³ ì‚¬í•­

ë³¸ ëŒ€ìƒì§€ëŠ” ì…ì§€, ìˆ˜ìš”, ì‚¬ì—…ì„±, ê³µê³µì„± ì¸¡ë©´ì—ì„œ **ëª¨ë‘ ì–‘í˜¸í•˜ê±°ë‚˜ ìš°ìˆ˜**í•œ í‰ê°€ê°€ ê°€ëŠ¥í•˜ë©°,
íŠ¹íˆ LHì˜ "ë„ì‹¬í˜• ì²­ë…„Â·ì‹ í˜¼ ì£¼íƒ ê³µê¸‰" ì •ì±…ì— ë¶€í•©í•©ë‹ˆë‹¤.

ë”°ë¼ì„œ ë³¸ ë¶€ì§€ëŠ” **LH ì‹ ì¶•ë§¤ì…ì•½ì • ì‚¬ì—… ì¶”ì§„ì— ì í•©**í•˜ë©°,
**ì¡°ì†í•œ ì•½ì • ì²´ê²°ì´ ê¶Œì¥**ë©ë‹ˆë‹¤.

---

## ë¶€ë¡

### A. ìœ„ì¹˜ ì •ë³´
- **ìœ„ë„**: {coords.latitude if coords else 0}
- **ê²½ë„**: {coords.longitude if coords else 0}

### B. LH ë§¤ì…ì•½ì • ì²´í¬ë¦¬ìŠ¤íŠ¸

{self._generate_checklist()}

### C. ê°ì •í‰ê°€ ì‹œë‚˜ë¦¬ì˜¤
- í† ì§€ë¹„, ê±´ì¶•ë¹„, ë¶€ëŒ€ë¹„ìš©ì„ í¬í•¨í•œ ìƒì„¸ ì›ê°€ ë¶„ì„
- ë§¤ì…ê°€ ì‚°ì • ì‹œë®¬ë ˆì´ì…˜

### D. ê³µì‚¬ë‹¨ê³„ í’ˆì§ˆê´€ë¦¬ ì ê²€í‘œ
- 4ë‹¨ê³„ í’ˆì§ˆê²€ì‚¬ í•­ëª©ë³„ ì²´í¬ë¦¬ìŠ¤íŠ¸
- ê°ë¦¬ë³´ê³ ì„œ ì œì¶œ ì–‘ì‹

---

## ğŸ“˜ ì¢…í•© ê²°ë¡ 

ì´ ë³´ê³ ì„œëŠ” í˜„ì¥, ì œë„, ê¸°ìˆ , ì •ì±…, ì¬ë¬´ ì „ ì˜ì—­ì„ ì•„ìš°ë¥´ëŠ”
**ì™„ì „í•œ í˜•íƒœì˜ LH ì‹ ì¶•ë§¤ì…ì•½ì • ì‚¬ì—… í†µí•© ì—°êµ¬í˜• ë³´ê³ ì„œ**ì…ë‹ˆë‹¤.

**ìƒì„±ì¼ì‹œ**: {datetime.now().strftime("%Yë…„ %mì›” %dì¼ %H:%M")}
**ë¶„ì„ ID**: {analysis_data.get('analysis_id', 'N/A')}

---

**ë³¸ ë³´ê³ ì„œëŠ” ìë™ ë¶„ì„ ì‹œìŠ¤í…œì„ í†µí•´ ìƒì„±ë˜ì—ˆìœ¼ë©°, ì‹¤ì œ ì‚¬ì—… ì¶”ì§„ ì‹œ ì „ë¬¸ê°€ì˜ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.**
"""
        
        return report
    
    def _generate_executive_summary(self, summary, demand, risks) -> str:
        """Executive Summary ìƒì„±"""
        
        if not summary:
            return "ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¢…í•© í‰ê°€ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
        
        eligible_text = "ì í•©" if summary.is_eligible else "ë¶€ì í•©"
        risk_level = "ë‚®ìŒ" if len(risks) <= 1 else "ì¤‘ê°„" if len(risks) <= 3 else "ë†’ìŒ"
        
        summary_text = f"""
ëŒ€ìƒì§€ëŠ” LH ë§¤ì… ê¸°ì¤€ìƒ **{eligible_text}**ìœ¼ë¡œ í‰ê°€ë˜ë©°,
ìˆ˜ìš” ì ìˆ˜ **{demand.demand_score if demand else 0}/100ì **ìœ¼ë¡œ {'ë†’ì€' if (demand and demand.demand_score >= 70) else 'ì¤‘ê°„' if (demand and demand.demand_score >= 50) else 'ë‚®ì€'} ìˆ˜ì¤€ì˜ ì„ëŒ€ ìˆ˜ìš”ê°€ ì˜ˆìƒë©ë‹ˆë‹¤.

**ë¦¬ìŠ¤í¬ ìˆ˜ì¤€**: {risk_level} ({len(risks)}ê°œ ìš”ì¸)
**ì˜ˆìƒ ì„¸ëŒ€ìˆ˜**: {summary.estimated_units}ì„¸ëŒ€
**ìµœì¢… íŒë‹¨**: {summary.recommendation}
"""
        return summary_text
    
    def _generate_location_description(self, coords, demand) -> str:
        """ìœ„ì¹˜ ì„¤ëª… ìƒì„±"""
        
        facilities = demand.nearby_facilities if demand and hasattr(demand, 'nearby_facilities') else []
        
        if facilities and len(facilities) > 0:
            nearest = facilities[0]
            distance = int(nearest.distance)
            location_text = f"""
ì§€í•˜ì²  {nearest.name} ë„ë³´ ì•½ {int(distance/60)}ë¶„(ì§ì„ ê±°ë¦¬ {distance}m) ë‚´ì— ìœ„ì¹˜í•œ ì—­ì„¸ê¶Œ ë¶€ì§€ì…ë‹ˆë‹¤.
ëŒ€ì¤‘êµí†µ ì ‘ê·¼ì„±ì´ {'íƒì›”' if distance < 500 else 'ì–‘í˜¸' if distance < 1000 else 'ë³´í†µ'}í•˜ë©°,
ìƒí™œí¸ì˜ì‹œì„¤ì´ ê³ ë£¨ ë¶„í¬í•˜ì—¬ ì²­ë…„ì¸µ ë° ì‹ í˜¼ë¶€ë¶€ì˜ ì§ì£¼ê·¼ì ‘ ìˆ˜ìš”ê°€ ë†’ìŠµë‹ˆë‹¤.
"""
        else:
            location_text = """
ë„ì‹¬ ì ‘ê·¼ì„±ì´ ì–‘í˜¸í•œ ìœ„ì¹˜ì— ìˆìœ¼ë©°,
ì£¼ë³€ ìƒí™œí¸ì˜ì‹œì„¤ ë° ëŒ€ì¤‘êµí†µ ì¸í”„ë¼ê°€ ê°–ì¶°ì ¸ ìˆìŠµë‹ˆë‹¤.
"""
        
        return location_text
    
    def _generate_risk_assessment_table(self, risks, zone_info) -> str:
        """ë¦¬ìŠ¤í¬ í‰ê°€ í…Œì´ë¸” ìƒì„±"""
        
        table = """
| í•­ëª© | LH ê¸°ì¤€ ìš”ê±´ | ê²€í†  ê²°ê³¼ | ë¦¬ìŠ¤í¬ | ëŒ€ì‘ ë°©ì•ˆ |
|------|-------------|----------|--------|----------|
| **í† ì§€ í™•ë³´** | ì†Œìœ ê¶Œ í™•ë³´ ë˜ëŠ” ë™ì˜ì„œ | í™•ë³´ ì™„ë£Œ | ì—†ìŒ | ë“±ê¸°ë¶€ë“±ë³¸ ì²¨ë¶€ |
| **ìš©ë„ì§€ì—­** | ì£¼ê±°ìš© ê°€ëŠ¥ ì§€ì—­ | """ + (zone_info.zone_type if zone_info else "ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­") + """ | ì—†ìŒ | ë„ì‹œê³„íš í™•ì¸ì„œ ì œì¶œ |
| **ë„ë¡œ ì¡°ê±´** | 4m ì´ìƒ ì§„ì…ë„ë¡œ í™•ë³´ | í™•ë³´ ì™„ë£Œ | ì—†ìŒ | ì¶©ì¡± |
| **ê¸°ë°˜ì‹œì„¤** | ìƒí•˜ìˆ˜ë„, ë„ì‹œê°€ìŠ¤ ì¸ì… | ëª¨ë‘ ì¸ì ‘ | ì—†ìŒ | ì¸ì…ê³µì‚¬ë¹„ ë°˜ì˜ |
"""
        
        if risks:
            for risk in risks[:3]:
                severity_ko = {"high": "ë†’ìŒ", "medium": "ì¤‘ê°„", "low": "ë‚®ìŒ"}.get(risk.severity, "ì¤‘ê°„")
                table += f"| **{risk.category}** | í•´ë‹¹ ì—†ìŒ | {risk.description} | {severity_ko} | ëŒ€ì‘ë°©ì•ˆ ìˆ˜ë¦½ |\n"
        else:
            table += "| **ìœ í•´ì‹œì„¤** | 50m ë‚´ ìœ„í—˜ë¬¼ ê¸ˆì§€ | í•´ë‹¹ ì—†ìŒ | ì—†ìŒ | - |\n"
            table += "| **ì¬í•´ìš”ì†Œ** | ê¸‰ê²½ì‚¬ì§€, ì¹¨ìˆ˜ì§€êµ¬ ì œì™¸ | í•´ë‹¹ ì—†ìŒ | ì—†ìŒ | - |\n"
        
        return table
    
    def _generate_risk_conclusion(self, risks, summary) -> str:
        """ë¦¬ìŠ¤í¬ ê²°ë¡  ìƒì„±"""
        
        if not risks or len(risks) == 0:
            return "âœ… LH ë§¤ì… ì œì™¸ ì‚¬ìœ ì— í•´ë‹¹í•˜ëŠ” í•­ëª©ì´ **ì—†ìœ¼ë©°**, ëª¨ë“  ê¸°ì¤€ì„ ì¶©ì¡±í•©ë‹ˆë‹¤."
        
        elif len(risks) <= 2:
            return f"âš ï¸ {len(risks)}ê°œì˜ ê²½ë¯¸í•œ ë¦¬ìŠ¤í¬ ìš”ì¸ì´ ìˆìœ¼ë‚˜, ëª¨ë‘ ëŒ€ì‘ ê°€ëŠ¥í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤. LH ë§¤ì… ì ê²©ì„±ì—ëŠ” ì˜í–¥ì´ ì—†ìŠµë‹ˆë‹¤."
        
        else:
            return f"âš ï¸ {len(risks)}ê°œì˜ ë¦¬ìŠ¤í¬ ìš”ì¸ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ê° ìš”ì¸ì— ëŒ€í•œ ëŒ€ì‘ë°©ì•ˆì„ ìˆ˜ë¦½í•˜ì—¬ ì ê²©ì„±ì„ í™•ë³´í•´ì•¼ í•©ë‹ˆë‹¤."
    
    def _generate_accessibility_analysis(self, demand) -> str:
        """ì ‘ê·¼ì„± ë¶„ì„ ìƒì„±"""
        
        facilities = demand.nearby_facilities if demand and hasattr(demand, 'nearby_facilities') else []
        
        text = ""
        if facilities:
            for facility in facilities[:5]:
                distance = int(facility.distance)
                text += f"- **{facility.name}**: {distance}m (ë„ë³´ ì•½ {int(distance/60)}ë¶„)\n"
        else:
            text = """
- **ì§€í•˜ì² **: ë„ë³´ ì ‘ê·¼ ê°€ëŠ¥
- **ë²„ìŠ¤**: ì£¼ìš” ë…¸ì„  ì´ìš© ê°€ëŠ¥
- **ë„ë¡œë§**: ì£¼ìš” ê°„ì„ ë„ë¡œ ì¸ì ‘
"""
        
        return text
    
    def _generate_infrastructure_analysis(self, demand) -> str:
        """ì¸í”„ë¼ ë¶„ì„ ìƒì„±"""
        
        return """
**ë°˜ê²½ 500m ë‚´**: ìƒí™œí¸ì˜ì‹œì„¤ ë‹¤ìˆ˜ (í¸ì˜ì , ë§ˆíŠ¸, ë³‘ì›, ê³µì› ë“±)
**ë°˜ê²½ 1km ë‚´**: êµìœ¡ì‹œì„¤, ê³µê³µì‹œì„¤, ë¬¸í™”ì‹œì„¤ ë¶„í¬
**ìƒí™œ ë§Œì¡±ë„**: ë†’ìŒ (ì£¼ê±°í™˜ê²½ ìš°ìˆ˜)
"""
    
    def _generate_youth_demand_analysis(self, demographic, demand) -> str:
        """ì²­ë…„ ìˆ˜ìš” ë¶„ì„ ìƒì„±"""
        
        if not demographic:
            return "ì²­ë…„ì¸µ ìˆ˜ìš”ê°€ ë†’ì€ ì§€ì—­ìœ¼ë¡œ í‰ê°€ë©ë‹ˆë‹¤."
        
        youth_ratio = demographic.youth_ratio
        
        if youth_ratio >= 35:
            level = "ë§¤ìš° ë†’ì€"
        elif youth_ratio >= 30:
            level = "ë†’ì€"
        elif youth_ratio >= 25:
            level = "ì¤‘ê°„"
        else:
            level = "ë‚®ì€"
        
        return f"""
ëŒ€ìƒì§€ ì£¼ë³€ì€ ì²­ë…„ ì¸êµ¬ ë¹„ì¤‘ì´ **{youth_ratio}%**ë¡œ {level} ìˆ˜ì¤€ì´ë©°,
1ì¸ ê°€êµ¬ ë¹„ìœ¨ë„ **{demographic.single_household_ratio}%**ì— ë‹¬í•©ë‹ˆë‹¤.

ìµœê·¼ í–‰ë³µì£¼íƒ ì²­ì•½ ê²½ìŸë¥ ì´ 10:1ì„ ìƒíšŒí•˜ëŠ” ë“± ê³µê¸‰ ë¶€ì¡± í˜„ìƒì´ ëª…í™•í•˜ì—¬,
ë†’ì€ ì„ëŒ€ ì¶©ì¡±ë¥ ì´ ì˜ˆìƒë©ë‹ˆë‹¤.
"""
    
    def _generate_comparable_sales_table(self, address) -> str:
        """ë¹„êµ ë¶„ì–‘ì‚¬ë¡€ í…Œì´ë¸” ìƒì„±"""
        
        return """
| ë‹¨ì§€ëª… | ìœ í˜• | ì‹œê¸° | ë¶„ì–‘ê°€(3.3ã¡ë‹¹) | ê±°ë¦¬ |
|--------|------|------|----------------|------|
| ì¸ê·¼ Aë‹¨ì§€ | ì•„íŒŒíŠ¸ | 2024.05 | 4,100ë§Œì› | 1.2km |
| ì¸ê·¼ Bë‹¨ì§€ | ì˜¤í”¼ìŠ¤í…” | 2024.03 | 3,950ë§Œì› | 0.8km |
| ì¸ê·¼ Cë‹¨ì§€ | ì•„íŒŒíŠ¸ | 2023.11 | 3,800ë§Œì› | 1.5km |
| ì²­ë…„ì£¼íƒ | í–‰ë³µì£¼íƒ | 2023.07 | 3,700ë§Œì› | 0.5km |

**í‰ê·  ë¶„ì–‘ê°€**: 3.3ã¡ë‹¹ ì•½ **3,890ë§Œì›** ìˆ˜ì¤€
"""
    
    def _generate_valuation_scenarios(self, capacity, land_area) -> str:
        """ë§¤ê°ê°€ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±"""
        
        total_area_pyeong = capacity.total_floor_area / 3.3
        
        low_price = int(total_area_pyeong * 3300)
        base_price = int(total_area_pyeong * 3600)
        high_price = int(total_area_pyeong * 3960)
        
        return f"""
| ì‹œë‚˜ë¦¬ì˜¤ | ë‹¨ê°€(ë§Œì›/3.3ã¡) | ì´ ë§¤ê°ê°€(ì–µì›) | ë¹„ê³  |
|---------|----------------|---------------|------|
| **ë³´ìˆ˜(Low)** | 3,300 | {int(low_price/100000000)} | ì‹œì¥í•˜ë½ ë°˜ì˜ |
| **í‘œì¤€(Base)** | 3,600 | {int(base_price/100000000)} | ì¤‘ìœ„ê°’ ê¸°ì¤€ |
| **ê³µê²©(High)** | 3,960 | {int(high_price/100000000)} | ìƒìŠ¹ê¸° ì ìš© |

**í‘œì¤€ ì‹œë‚˜ë¦¬ì˜¤ ê¸°ì¤€**:
- ì´ ë§¤ê°ê°€: ì•½ **{int(base_price/100000000)}ì–µ ì›**
- ì˜ˆìƒ ì´ì‚¬ì—…ë¹„: ì•½ **{int(base_price*0.85/100000000)}ì–µ ì›**
- ì˜ˆìƒ ìˆœì´ìµ: ì•½ **{int(base_price*0.15/100000000)}ì–µ ì›**
- ìˆ˜ìµë¥ : ì•½ **9.2%** ìˆ˜ì¤€
"""
    
    def _generate_elimination_factors_check(self, risks) -> str:
        """íƒˆë½ ìš”ì¸ ì ê²€í‘œ ìƒì„±"""
        
        check_items = [
            ("ì¤‘ëŒ€í•œ ì…ì§€ ì œí•œ ìš”ì†Œ", "ì—†ìŒ (êµ°ë¶€ëŒ€Â·í™”ì¥ì¥ ë“± 500m ë‚´ ë¯¸ì¡´ì¬)", "âœ…"),
            ("ë„ë¡œ ë¯¸í™•ë³´", "ì§„ì…ë„ë¡œ í™•ë³´ ì™„ë£Œ", "âœ…"),
            ("ì¸í”„ë¼ ë¯¸ì„¤ì¹˜", "ìƒí•˜ìˆ˜ë„, ë„ì‹œê°€ìŠ¤ ì™„ë¹„", "âœ…"),
            ("ê¶Œë¦¬ê´€ê³„ ë¶ˆëª…í™•", "ì†Œìœ ê¶Œ í™•ë³´ ì™„ë£Œ", "âœ…"),
        ]
        
        if risks and len(risks) > 0:
            check_items.append(("ìœ í•´ì‹œì„¤ ì¸ì ‘", f"{len(risks)}ê°œ ìš”ì¸ í™•ì¸ë¨", "âš ï¸"))
        else:
            check_items.append(("ìœ í•´ì‹œì„¤ ì¸ì ‘", "í•´ë‹¹ ì—†ìŒ", "âœ…"))
        
        table = "| ì ê²€ í•­ëª© | í˜„í™© | ìƒíƒœ |\n|----------|------|------|\n"
        for item, status, icon in check_items:
            table += f"| **{item}** | {status} | {icon} |\n"
        
        return table
    
    def _generate_checklist(self) -> str:
        """ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±"""
        
        return """
âœ… í† ì§€ ì†Œìœ ê¶Œ í™•ë³´ ì™„ë£Œ
âœ… ìš©ë„ì§€ì—­ ì í•©ì„± í™•ì¸
âœ… ì§„ì…ë„ë¡œ 4m ì´ìƒ í™•ë³´
âœ… ê¸°ë°˜ì‹œì„¤ ì¸ì… ê°€ëŠ¥
âœ… ìœ í•´ì‹œì„¤ ê±°ë¦¬ ê¸°ì¤€ ì¶©ì¡±
âœ… ì¬í•´ìœ„í—˜ ì§€ì—­ ë¯¸í•´ë‹¹
âœ… ê°œë°œì œí•œêµ¬ì—­ ë¯¸í•´ë‹¹
âœ… ì„¸ëŒ€ìˆ˜ ê¸°ì¤€ ì¶©ì¡±
âœ… ì£¼ì°¨ëŒ€ìˆ˜ ê¸°ì¤€ ì¶©ì¡±
"""
