<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œì íŠ¸ ë¶„ì„ - ZeroSite Decision OS</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/css/zerosite-design-system.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Noto+Sans+KR:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        .analysis-section {
            background: var(--color-background-section);
            border: 2px solid var(--color-deep-navy);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xxl);
        }

        .analysis-section__title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-deep-navy);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--color-deep-navy);
        }

        .input-group {
            margin-bottom: var(--spacing-lg);
        }

        .input-group__label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .input-group__input {
            width: 100%;
            padding: 14px 18px;
            font-size: 16px;
            font-family: var(--font-primary);
            border: 2px solid var(--color-border-light);
            background: var(--color-background-white);
            color: var(--color-text-primary);
            transition: border-color 0.2s;
        }

        .input-group__input:focus {
            outline: none;
            border-color: var(--color-institutional-blue);
        }

        .input-group__hint {
            font-size: 12px;
            color: var(--color-text-caption);
            margin-top: var(--spacing-xs);
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .action-button {
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            background: var(--color-deep-navy);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-primary);
            width: 100%;
        }

        .action-button:hover {
            background: var(--color-institutional-blue);
        }

        .action-button:disabled {
            background: var(--color-text-caption);
            cursor: not-allowed;
        }

        .progress-section {
            background: var(--color-background-section);
            border: 1px solid var(--color-border-light);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xxl);
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-step {
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            border-left: 4px solid var(--color-text-caption);
            background: var(--color-background-white);
            transition: all 0.3s;
        }

        .progress-step.running {
            border-left-color: var(--color-info);
            background: #E3F2FD;
        }

        .progress-step.completed {
            border-left-color: var(--color-positive);
            background: #E8F5E9;
        }

        .progress-step.error {
            border-left-color: var(--color-warning);
            background: #FFEBEE;
        }

        .progress-step__title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .progress-step__message {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
        }

        .result-card {
            border: 1px solid var(--color-border-light);
            padding: var(--spacing-lg);
            background: var(--color-background-section);
            text-align: center;
        }

        .result-card__label {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-text-caption);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-sm);
        }

        .result-card__link {
            display: inline-block;
            padding: 10px 16px;
            background: var(--color-deep-navy);
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .result-card__link:hover {
            background: var(--color-institutional-blue);
        }

        .result-card__link:disabled {
            background: var(--color-text-caption);
            pointer-events: none;
        }

        .example-addresses {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--color-background-white);
            border: 1px solid var(--color-border-light);
        }

        .example-addresses__title {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .example-address {
            display: inline-block;
            margin: 4px;
            padding: 6px 12px;
            font-size: 12px;
            color: var(--color-institutional-blue);
            background: white;
            border: 1px solid var(--color-border-light);
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-address:hover {
            background: var(--color-background-white);
            border-color: var(--color-institutional-blue);
        }

        .info-message {
            background: #E3F2FD;
            border-left: 4px solid var(--color-info);
            padding: var(--spacing-md);
            margin-top: var(--spacing-lg);
            font-size: 13px;
            line-height: 1.6;
        }

        .error-message {
            background: #FFEBEE;
            border-left: 4px solid var(--color-warning);
            padding: var(--spacing-md);
            margin-top: var(--spacing-lg);
            font-size: 13px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="zs-header">
        <div class="zs-header__container">
            <div class="zs-header__main">
                <h1 class="zs-header__title">ZeroSite</h1>
                <p class="zs-header__meta">
                    <span>í”„ë¡œì íŠ¸ ë¶„ì„</span>
                    <span class="zs-header__divider">|</span>
                    <span>Decision OS v1.0</span>
                </p>
            </div>
            <div class="zs-header__context">
                <span class="zs-label">System Status</span>
                <span class="zs-number">Production Ready</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="zs-container">
        <!-- Analysis Input Section -->
        <section class="analysis-section">
            <h2 class="analysis-section__title">í”„ë¡œì íŠ¸ ì •ë³´ ì…ë ¥</h2>
            
            <div class="input-group">
                <label class="input-group__label" for="address">í”„ë¡œì íŠ¸ ì£¼ì†Œ *</label>
                <input 
                    type="text" 
                    id="address" 
                    class="input-group__input" 
                    placeholder="ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123-45"
                >
                <div class="input-group__hint">
                    ë„ë¡œëª… ì£¼ì†Œ ë˜ëŠ” ì§€ë²ˆ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ë²•ì •ë™ ë‹¨ìœ„ê¹Œì§€ í•„ìˆ˜)
                </div>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <label class="input-group__label" for="landArea">ëŒ€ì§€ë©´ì  (ã¡)</label>
                    <input 
                        type="number" 
                        id="landArea" 
                        class="input-group__input" 
                        placeholder="ì˜ˆ: 500"
                        step="0.01"
                    >
                    <div class="input-group__hint">ì„ íƒì‚¬í•­ (ì…ë ¥ ì‹œ ë” ì •í™•í•œ ë¶„ì„ ê°€ëŠ¥)</div>
                </div>

                <div class="input-group">
                    <label class="input-group__label" for="zoning">ìš©ë„ì§€ì—­</label>
                    <input 
                        type="text" 
                        id="zoning" 
                        class="input-group__input" 
                        placeholder="ì˜ˆ: ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­"
                    >
                    <div class="input-group__hint">ì„ íƒì‚¬í•­ (ë¯¸ì…ë ¥ ì‹œ ìë™ ì¡°íšŒ ì‹œë„)</div>
                </div>
            </div>

            <div class="example-addresses">
                <div class="example-addresses__title">ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ìš© ì˜ˆì‹œ ì£¼ì†Œ:</div>
                <span class="example-address" onclick="setAddress('ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123-45', 500, 'ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­')">ê°•ë‚¨êµ¬ ì—­ì‚¼ë™</span>
                <span class="example-address" onclick="setAddress('ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ì„œì´ˆë™ 1234-5', 600, 'ì œ3ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­')">ì„œì´ˆêµ¬ ì„œì´ˆë™</span>
                <span class="example-address" onclick="setAddress('ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬ ì ì‹¤ë™ 567-8', 450, 'ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­')">ì†¡íŒŒêµ¬ ì ì‹¤ë™</span>
            </div>

            <button class="action-button" id="analyzeButton" onclick="startAnalysis()">
                ğŸš€ ë¶„ì„ ì‹œì‘
            </button>

            <div class="info-message" style="margin-top: var(--spacing-lg);">
                <strong>ğŸ“Œ ë¶„ì„ í”„ë¡œì„¸ìŠ¤:</strong><br>
                M1 í† ì§€ì •ë³´ ìˆ˜ì§‘ â†’ M2~M6 íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (ê°ì •í‰ê°€/ê³µê¸‰ìœ í˜•/ê±´ì¶•ê·œëª¨/ì‚¬ì—…ì„±/ì¢…í•©íŒë‹¨) â†’ ë³´ê³ ì„œ ìƒì„±<br>
                <small style="color: var(--color-text-secondary);">ì „ì²´ ë¶„ì„ ì†Œìš”ì‹œê°„: ì•½ 1~3ë¶„</small>
            </div>
        </section>

        <!-- Progress Section -->
        <section class="progress-section" id="progressSection">
            <h3 class="zs-section__title">ë¶„ì„ ì§„í–‰ ìƒí™©</h3>
            
            <div class="progress-step" id="step-m1">
                <div class="progress-step__title">â³ M1: í† ì§€ì •ë³´ ìˆ˜ì§‘</div>
                <div class="progress-step__message">ëŒ€ê¸° ì¤‘...</div>
            </div>
            
            <div class="progress-step" id="step-m2">
                <div class="progress-step__title">â³ M2~M6: ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰</div>
                <div class="progress-step__message">ëŒ€ê¸° ì¤‘...</div>
            </div>
            
            <div class="progress-step" id="step-m3">
                <div class="progress-step__title">â³ M3: ê³µê¸‰ìœ í˜• ê²°ì •</div>
                <div class="progress-step__message">ëŒ€ê¸° ì¤‘...</div>
            </div>
            
            <div class="progress-step" id="step-m4">
                <div class="progress-step__title">â³ M4: ê±´ì¶•ê·œëª¨ ì‚°ì •</div>
                <div class="progress-step__message">ëŒ€ê¸° ì¤‘...</div>
            </div>
            
            <div class="progress-step" id="step-m5">
                <div class="progress-step__title">â³ M5: ì‚¬ì—…ì„± ë¶„ì„</div>
                <div class="progress-step__message">ëŒ€ê¸° ì¤‘...</div>
            </div>
            
            <div class="progress-step" id="step-m6">
                <div class="progress-step__title">â³ M6: LH ì¢…í•©íŒë‹¨</div>
                <div class="progress-step__message">ëŒ€ê¸° ì¤‘...</div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="zs-section" id="resultsSection" style="display: none;">
            <h3 class="zs-section__title">ë¶„ì„ ê²°ê³¼ ë³´ê³ ì„œ</h3>
            <div class="results-grid">
                <div class="result-card">
                    <div class="result-card__label">M3 ê³µê¸‰ìœ í˜•</div>
                    <a href="#" id="link-m3" class="result-card__link" target="_blank">ë³´ê³ ì„œ ì—´ê¸°</a>
                </div>
                <div class="result-card">
                    <div class="result-card__label">M4 ê±´ì¶•ê·œëª¨</div>
                    <a href="#" id="link-m4" class="result-card__link" target="_blank">ë³´ê³ ì„œ ì—´ê¸°</a>
                </div>
                <div class="result-card">
                    <div class="result-card__label">M5 ì‚¬ì—…ì„±</div>
                    <a href="#" id="link-m5" class="result-card__link" target="_blank">ë³´ê³ ì„œ ì—´ê¸°</a>
                </div>
                <div class="result-card">
                    <div class="result-card__label">M6 ì¢…í•©íŒë‹¨</div>
                    <a href="#" id="link-m6" class="result-card__link" target="_blank">ë³´ê³ ì„œ ì—´ê¸°</a>
                </div>
            </div>

            <div class="info-message" style="margin-top: var(--spacing-xl);">
                <strong>ğŸ’¾ Context ID:</strong> <code id="finalContextId" style="font-family: var(--font-secondary); font-weight: 600;"></code><br>
                <small>ì´ Context IDë¡œ ì–¸ì œë“ ì§€ ë³´ê³ ì„œë¥¼ ë‹¤ì‹œ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
            </div>
        </section>

        <!-- Instructions -->
        <section class="zs-section">
            <h3 class="zs-section__title">ì‚¬ìš© ì•ˆë‚´</h3>
            <div class="zs-section__content">
                <h4>í•„ìˆ˜ ì…ë ¥ í•­ëª©</h4>
                <ul>
                    <li><strong>ì£¼ì†Œ:</strong> í”„ë¡œì íŠ¸ ëŒ€ìƒì§€ì˜ ë„ë¡œëª… ë˜ëŠ” ì§€ë²ˆ ì£¼ì†Œ (ë²•ì •ë™ ë‹¨ìœ„ê¹Œì§€)</li>
                </ul>

                <h4 style="margin-top: var(--spacing-lg);">ì„ íƒ ì…ë ¥ í•­ëª© (ê¶Œì¥)</h4>
                <ul>
                    <li><strong>ëŒ€ì§€ë©´ì :</strong> ì •í™•í•œ ê±´ì¶•ê·œëª¨ ì‚°ì •ì„ ìœ„í•´ ì…ë ¥ ê¶Œì¥</li>
                    <li><strong>ìš©ë„ì§€ì—­:</strong> ë¯¸ì…ë ¥ ì‹œ ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ì¡°íšŒ ì‹œë„</li>
                </ul>

                <h4 style="margin-top: var(--spacing-lg);">ë¶„ì„ í”„ë¡œì„¸ìŠ¤</h4>
                <ol>
                    <li><strong>M1 (í† ì§€ì •ë³´):</strong> ì£¼ì†Œ ê¸°ë°˜ í† ì§€ ì •ë³´ ìˆ˜ì§‘ ë° Context ìƒì„±</li>
                    <li><strong>M2~M6 íŒŒì´í”„ë¼ì¸:</strong> ì „ì²´ ë¶„ì„ ëª¨ë“ˆì„ í•œ ë²ˆì— ì‹¤í–‰
                        <ul style="margin-top: 8px;">
                            <li>M2: ê°ì •í‰ê°€</li>
                            <li>M3: ê³µê¸‰ìœ í˜• ê²°ì •</li>
                            <li>M4: ê±´ì¶•ê·œëª¨ ì‚°ì •</li>
                            <li>M5: ì‚¬ì—…ì„± ë¶„ì„</li>
                            <li>M6: LH ì¢…í•©íŒë‹¨</li>
                        </ul>
                    </li>
                    <li><strong>ë³´ê³ ì„œ ìƒì„±:</strong> ê° ëª¨ë“ˆë³„ HTML ë³´ê³ ì„œ ìë™ ìƒì„±</li>
                </ol>

                <div class="info-message" style="margin-top: var(--spacing-lg);">
                    <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong><br>
                    â€¢ ëª¨ë“  ë¶„ì„ì€ ì‹¤ì œ ì…ë ¥ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤.<br>
                    â€¢ ìƒ˜í”Œ ë°ì´í„°ë‚˜ ê¸°ë³¸ê°’ì€ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
                    â€¢ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ëª…í™•í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                </div>
            </div>
        </section>

        <!-- Quick Links -->
        <section class="zs-section">
            <h3 class="zs-section__title">ë‹¤ë¥¸ í˜ì´ì§€</h3>
            <div class="zs-section__content">
                <div class="zs-grid zs-grid--3col">
                    <div>
                        <h4>ë©”ì¸ í˜ì´ì§€</h4>
                        <p><a href="/">ZeroSite í™ˆ</a></p>
                    </div>
                    <div>
                        <h4>ë³´ê³ ì„œ ì¡°íšŒ</h4>
                        <p><a href="/reports">ê¸°ì¡´ ë³´ê³ ì„œ ì¡°íšŒ</a></p>
                    </div>
                    <div>
                        <h4>API ë¬¸ì„œ</h4>
                        <p><a href="/docs" target="_blank">Swagger UI</a></p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="zs-footer">
        <div class="zs-container">
            <div class="zs-footer__content">
                <p class="zs-footer__copyright">â“’ ZeroSite by AntennaHoldings | Natai Heum</p>
                <p class="zs-footer__watermark">DESIGN SYSTEM: ZEROSITE DECISION OS V1.0</p>
            </div>
        </div>
    </footer>

    <script>
        let currentContextId = null;
        let currentParcelId = null; // PNU í˜•ì‹ ID (M3~M6ìš©)

        function setAddress(address, landArea, zoning) {
            document.getElementById('address').value = address;
            document.getElementById('landArea').value = landArea || '';
            document.getElementById('zoning').value = zoning || '';
        }

        async function startAnalysis() {
            const address = document.getElementById('address').value.trim();
            const landArea = document.getElementById('landArea').value.trim();
            const zoning = document.getElementById('zoning').value.trim();

            if (!address) {
                alert('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ì´ˆê¸°í™”
            document.getElementById('analyzeButton').disabled = true;
            document.getElementById('analyzeButton').textContent = 'â³ ë¶„ì„ ì¤‘...';
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('resultsSection').style.display = 'none';

            // ì§„í–‰ ìƒí™© ì´ˆê¸°í™”
            ['m1', 'm2', 'm3', 'm4', 'm5', 'm6'].forEach(module => {
                const step = document.getElementById(`step-${module}`);
                step.className = 'progress-step';
                step.querySelector('.progress-step__title').textContent = `â³ ${module.toUpperCase()}: ëŒ€ê¸° ì¤‘...`;
                step.querySelector('.progress-step__message').textContent = 'ëŒ€ê¸° ì¤‘...';
            });

            try {
                // Step 1: M1 í† ì§€ì •ë³´ ë¶„ì„ ë° Context ìƒì„±
                await runModule('m1', 'M1: í† ì§€ì •ë³´ ìˆ˜ì§‘', async () => {
                    // 1-1: ì£¼ì†Œ ê²€ìƒ‰ìœ¼ë¡œ lat/lon íšë“
                    const searchResponse = await fetch('/api/m1/address/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: address })
                    });
                    
                    const searchData = await searchResponse.json();
                    
                    if (!searchResponse.ok || !searchData.suggestions || searchData.suggestions.length === 0) {
                        throw new Error('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }
                    
                    const firstResult = searchData.suggestions[0];
                    const finalAddress = firstResult.road_address || firstResult.jibun_address;
                    
                    // 1-2: collect-allë¡œ ì „ì²´ ì •ë³´ ìˆ˜ì§‘
                    const collectPayload = {
                        address: finalAddress,
                        lat: firstResult.coordinates.lat,
                        lon: firstResult.coordinates.lon
                    };
                    
                    if (landArea) collectPayload.land_area_sqm = parseFloat(landArea);
                    if (zoning) collectPayload.zoning = zoning;

                    const collectResponse = await fetch('/api/m1/collect-all', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(collectPayload)
                    });
                    
                    const collectData = await collectResponse.json();
                    
                    if (!collectResponse.ok || !collectData.success) {
                        throw new Error(collectData.error || 'M1 í† ì§€ì •ë³´ ìˆ˜ì§‘ ì‹¤íŒ¨');
                    }
                    
                    // 1-3: freeze-context-v2ë¡œ Context ID ìƒì„±
                    const freezePayload = {
                        // ì£¼ì†Œ ì •ë³´
                        address: collectData.data.address || finalAddress,
                        road_address: firstResult.road_address || finalAddress,
                        sido: collectData.data.sido || firstResult.sido || 'ì„œìš¸',
                        sigungu: collectData.data.sigungu || firstResult.sigungu || '',
                        dong: collectData.data.dong || firstResult.dong || '',
                        beopjeong_dong: collectData.data.beopjeong_dong || null,
                        
                        // ì¢Œí‘œ
                        coordinates: {
                            lat: firstResult.coordinates.lat,
                            lon: firstResult.coordinates.lon
                        },
                        
                        // ì§€ì  ì •ë³´
                        bonbun: collectData.data.cadastral?.bonbun || '0',
                        bubun: collectData.data.cadastral?.bubun || '0',
                        jimok: collectData.data.cadastral?.jimok || 'ëŒ€ì§€',
                        area: landArea ? parseFloat(landArea) : (collectData.data.cadastral?.area || 500),
                        
                        // ìš©ë„ì§€ì—­
                        zone_type: zoning || collectData.data.legal?.use_zone || 'ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­',
                        land_use: collectData.data.legal?.use_zone || 'ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­',
                        
                        // ê±´ì¶• ê·œì œ
                        far: collectData.data.legal?.floor_area_ratio || 200,
                        bcr: collectData.data.legal?.building_coverage_ratio || 60,
                        
                        // ë„ë¡œ ì •ë³´
                        road_width: collectData.data.road?.road_width || 8.0,
                        road_type: collectData.data.road?.road_type || 'ì¼ë°˜ë„ë¡œ',
                        
                        // ê°€ê²© ì •ë³´ (ì„ íƒ)
                        official_land_price: collectData.data.market?.official_land_price || 5000000,
                        official_land_price_date: collectData.data.market?.official_land_price_date || '2024-01-01'
                    };

                    const freezeResponse = await fetch('/api/m1/freeze-context-v2', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(freezePayload)
                    });
                    
                    const freezeData = await freezeResponse.json();
                    
                    if (!freezeResponse.ok) {
                        // ìƒì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
                        const errorDetails = freezeData.detail || freezeData.message || 'Context ìƒì„± ì‹¤íŒ¨';
                        console.error('Freeze context error:', freezeData);
                        throw new Error(typeof errorDetails === 'string' ? errorDetails : JSON.stringify(errorDetails));
                    }
                    
                    currentContextId = freezeData.context_id;
                    currentParcelId = freezeData.parcel_id; // PNU í˜•ì‹ ID
                    
                    return `Context: ${currentContextId} | PNU: ${currentParcelId} | ${finalAddress}`;
                });

                // Step 2: M2 ê°ì •í‰ê°€ (ìë™ ì‹¤í–‰)
                await runModule('m2', 'M2: ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰', async () => {
                    // M2~M6 íŒŒì´í”„ë¼ì¸ í•œë²ˆì— ì‹¤í–‰
                    const response = await fetch('/api/v4/pipeline/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ parcel_id: currentParcelId })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.detail || 'Pipeline ì‹¤í–‰ ì‹¤íŒ¨');
                    }
                    
                    return `M2~M6 íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì™„ë£Œ (${data.modules_executed}ê°œ ëª¨ë“ˆ)`;
                });

                // Step 3: M3 ê³µê¸‰ìœ í˜• ê²°ì •
                await runModule('m3', 'M3: ê³µê¸‰ìœ í˜• ê²°ì •', async () => {
                    // íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ í›„ ë³´ê³ ì„œ ì¡°íšŒë§Œ ìˆ˜í–‰
                    const response = await fetch(`/api/v4/reports/M3/html?context_id=${currentParcelId}`);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('M3 error:', errorText);
                        throw new Error('M3 ë³´ê³ ì„œ ì¡°íšŒ ì‹¤íŒ¨');
                    }
                    return 'ê³µê¸‰ìœ í˜• ê²°ì • ë³´ê³ ì„œ ì¤€ë¹„ ì™„ë£Œ';
                });

                // Step 3: M4 ê±´ì¶•ê·œëª¨ ì‚°ì •
                await runModule('m4', 'M4: ê±´ì¶•ê·œëª¨ ì‚°ì •', async () => {
                    const response = await fetch(`/api/v4/reports/M4/html?context_id=${currentParcelId}`);
                    if (!response.ok) throw new Error('M4 ë³´ê³ ì„œ ì¡°íšŒ ì‹¤íŒ¨');
                    return 'ê±´ì¶•ê·œëª¨ ì‚°ì • ë³´ê³ ì„œ ì¤€ë¹„ ì™„ë£Œ';
                });

                // Step 4: M5 ì‚¬ì—…ì„± ë¶„ì„
                await runModule('m5', 'M5: ì‚¬ì—…ì„± ë¶„ì„', async () => {
                    const response = await fetch(`/api/v4/reports/M5/html?context_id=${currentParcelId}`);
                    if (!response.ok) throw new Error('M5 ë³´ê³ ì„œ ì¡°íšŒ ì‹¤íŒ¨');
                    return 'ì‚¬ì—…ì„± ë¶„ì„ ë³´ê³ ì„œ ì¤€ë¹„ ì™„ë£Œ';
                });

                // Step 5: M6 ì¢…í•©íŒë‹¨
                await runModule('m6', 'M6: LH ì¢…í•©íŒë‹¨', async () => {
                    const response = await fetch(`/api/v4/reports/M6/html?context_id=${currentParcelId}`);
                    if (!response.ok) throw new Error('M6 ë³´ê³ ì„œ ì¡°íšŒ ì‹¤íŒ¨');
                    return 'LH ì¢…í•©íŒë‹¨ ë³´ê³ ì„œ ì¤€ë¹„ ì™„ë£Œ';
                });

                // ì™„ë£Œ ì²˜ë¦¬
                showResults();

            } catch (error) {
                console.error('Analysis error:', error);
                alert(`ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
            } finally {
                document.getElementById('analyzeButton').disabled = false;
                document.getElementById('analyzeButton').textContent = 'ğŸš€ ë¶„ì„ ì‹œì‘';
            }
        }

        async function runModule(moduleId, title, asyncFunc) {
            const step = document.getElementById(`step-${moduleId}`);
            
            // Running ìƒíƒœ
            step.className = 'progress-step running';
            step.querySelector('.progress-step__title').textContent = `ğŸ”„ ${title}`;
            step.querySelector('.progress-step__message').textContent = 'ì²˜ë¦¬ ì¤‘...';

            try {
                const message = await asyncFunc();
                
                // Completed ìƒíƒœ
                step.className = 'progress-step completed';
                step.querySelector('.progress-step__title').textContent = `âœ… ${title}`;
                step.querySelector('.progress-step__message').textContent = message;
            } catch (error) {
                // Error ìƒíƒœ
                step.className = 'progress-step error';
                step.querySelector('.progress-step__title').textContent = `âŒ ${title}`;
                step.querySelector('.progress-step__message').textContent = error.message;
                throw error;
            }
        }

        function showResults() {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('finalContextId').textContent = `${currentParcelId} (PNU)`;

            // ë³´ê³ ì„œ ë§í¬ ì„¤ì • (parcelId ì‚¬ìš©)
            ['m3', 'm4', 'm5', 'm6'].forEach(module => {
                const link = document.getElementById(`link-${module}`);
                link.href = `/api/v4/reports/${module.toUpperCase()}/html?context_id=${currentParcelId}`;
            });

            // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Enter í‚¤ ì§€ì›
        document.getElementById('address').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startAnalysis();
            }
        });
    </script>
</body>
</html>
