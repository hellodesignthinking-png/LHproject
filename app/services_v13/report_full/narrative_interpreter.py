"""
Narrative Interpreter - Phase A
ZeroSite Expert Edition v3

ìë™ ì„œìˆ  ìƒì„± ì—”ì§„
- 7ê°œ ì„¹ì…˜ ìë™ ì„œìˆ 
- 5-Step Framework (What, So What, Why, Implication, LH Connection)
- ì •ì±… ê·¼ê±° ìë™ ì—°ê²°
"""

from typing import Dict, Any, List, Optional
from datetime import datetime


class NarrativeInterpreter:
    """
    ë³´ê³ ì„œ ì„œìˆ  ìë™ ìƒì„± ì—”ì§„
    
    ìˆ«ì/ë°ì´í„°ë¥¼ ì „ëµì  ì„œìˆ ë¡œ ë³€í™˜
    """
    
    def __init__(self):
        self.current_year = datetime.now().year
    
    # ============================================
    # UTILITY METHODS
    # ============================================
    
    def fmt(self, value: Any, decimal: int = 1) -> str:
        """ìˆ«ì í¬ë§·íŒ… (ì–µì› ë‹¨ìœ„)"""
        try:
            if value is None:
                return "N/A"
            return f"{float(value):,.{decimal}f}"
        except (ValueError, TypeError):
            return str(value)
    
    def fmt_pct(self, value: Any, decimal: int = 1) -> str:
        """í¼ì„¼íŠ¸ í¬ë§·íŒ…"""
        try:
            if value is None:
                return "N/A"
            return f"{float(value):,.{decimal}f}%"
        except (ValueError, TypeError):
            return str(value)
    
    def grade_to_korean(self, grade: str) -> str:
        """ë“±ê¸‰ í•œê¸€ ë³€í™˜"""
        grade_map = {
            'A+': 'ìµœìš°ìˆ˜', 'A': 'ìš°ìˆ˜', 'B': 'ì–‘í˜¸',
            'C': 'ë³´í†µ', 'D': 'ë¯¸í¡', 'F': 'ë¶ˆëŸ‰'
        }
        return grade_map.get(grade, grade)
    
    def signal_to_korean(self, signal: str) -> str:
        """ì‹œì¥ ì‹ í˜¸ í•œê¸€ ë³€í™˜"""
        signal_map = {
            'UNDERVALUED': 'ì €í‰ê°€',
            'FAIR': 'ì ì •',
            'OVERVALUED': 'ê³ í‰ê°€'
        }
        return signal_map.get(signal, signal)
    
    def temp_to_korean(self, temp: str) -> str:
        """ì‹œì¥ ì˜¨ë„ í•œê¸€ ë³€í™˜"""
        temp_map = {
            'HOT': 'ê³¼ì—´',
            'WARM': 'ìƒìŠ¹',
            'NEUTRAL': 'ì•ˆì •',
            'COOL': 'ëƒ‰ê°',
            'COLD': 'ì¹¨ì²´'
        }
        return temp_map.get(temp, temp)
    
    # ============================================
    # SECTION 1: EXECUTIVE SUMMARY
    # ============================================
    
    def interpret_executive_summary(self, ctx: Dict[str, Any]) -> str:
        """
        Executive Summary ìë™ ìƒì„±
        
        êµ¬ì¡°:
        1. í”„ë¡œì íŠ¸ ê°œìš”
        2. í•µì‹¬ ì§€í‘œ ìš”ì•½ (ìˆ˜ìš”, ì‹œì¥, ì¬ë¬´)
        3. ì¢…í•© í‰ê°€
        4. ê¶Œê³ ì•ˆ
        """
        
        # Extract data
        # Handle address - could be nested dict or already a string
        addr_obj = ctx.get('site', {}).get('address', '')
        if isinstance(addr_obj, dict):
            address = addr_obj.get('full_address', 'N/A')
        elif isinstance(addr_obj, str):
            address = addr_obj
        else:
            address = ctx.get('address', 'N/A')  # Fallback to top-level address
        
        area = ctx.get('site', {}).get('land_area_sqm', ctx.get('land_area_sqm', 0))
        
        # Demand
        demand_score = ctx.get('demand', {}).get('overall_score', 0)
        recommended_type = ctx.get('demand', {}).get('recommended_type', 'ì‹ í˜¼ë¶€ë¶€í˜•')
        
        # Market
        market = ctx.get('market', {})
        market_signal = market.get('signal', 'FAIR')
        market_signal_kr = self.signal_to_korean(market_signal)
        market_temp = market.get('temperature', 'NEUTRAL')
        market_temp_kr = self.temp_to_korean(market_temp)
        delta_pct = market.get('delta_pct', 0)
        
        # Financial - handle both nested and flat structures
        finance = ctx.get('finance', {})
        
        # Try nested structure first, then flat structure
        if 'capex' in finance and isinstance(finance['capex'], dict):
            capex = finance['capex'].get('total', 0) / 100000000  # Convert to ì–µì›
        else:
            capex = finance.get('capex_billion', ctx.get('capex_krw', 0))
        
        if 'npv' in finance and isinstance(finance['npv'], dict):
            npv = finance['npv'].get('public', 0) / 100000000
        else:
            npv = finance.get('npv_billion', ctx.get('npv_public_krw', 0))
        
        if 'irr' in finance and isinstance(finance['irr'], dict):
            irr = finance['irr'].get('public', 0)
        else:
            irr = finance.get('irr_percent', ctx.get('irr_public_pct', 0))
        
        # Scorecard
        scorecard = ctx.get('scorecard', {})
        overall_score = scorecard.get('overall', {}).get('score', 0)
        overall_grade = scorecard.get('overall', {}).get('grade', 'C')
        recommendation = scorecard.get('overall', {}).get('recommendation', 'REVISE')
        
        # Generate narrative
        narrative = f"""
## Executive Summary

### 1. í”„ë¡œì íŠ¸ ê°œìš”

ë³¸ ë¶„ì„ì€ **'{address}'**ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ë©°, ì´ ì‚¬ì—…ë©´ì  **{self.fmt(area, 0)}ã¡**ì— ëŒ€í•´ 
LH ì‹ ì¶•ë§¤ì…ì„ëŒ€ ì‚¬ì—…ì˜ ì í•©ì„±ì„ ì¢…í•© í‰ê°€í•˜ì˜€ë‹¤.

ë³¸ ë³´ê³ ì„œëŠ” ZeroSite Expert Edition v3 ë¶„ì„ ì—”ì§„ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ë©°, 
ì…ì§€ ë¶„ì„, ì‹œì¥ ë¶„ì„, ìˆ˜ìš” ì˜ˆì¸¡, ì¬ë¬´ íƒ€ë‹¹ì„±, ë¦¬ìŠ¤í¬ í‰ê°€, ì •ì±… ì í•©ì„± ë“± 
**6ëŒ€ í•µì‹¬ ì˜ì—­**ì— ëŒ€í•œ ì¢…í•©ì  ê²€í† ë¥¼ ìˆ˜í–‰í•˜ì˜€ë‹¤.

---

### 2. í•µì‹¬ ì§€í‘œ ìš”ì•½

#### 2.1 ìˆ˜ìš” ì¸¡ë©´ (Demand Analysis)

í•´ë‹¹ ì…ì§€ëŠ” ìˆ˜ìš” ë¶„ì„ ê²°ê³¼ **{self.fmt(demand_score, 1)}ì **ì„ ê¸°ë¡í•˜ì˜€ë‹¤.

**[ìˆ˜ìš” í‰ê°€ í•´ì„]**
"""
        
        # Demand interpretation
        if demand_score >= 80:
            narrative += f"""
ì´ëŠ” ë§¤ìš° ë†’ì€ ìˆ˜ì¤€ìœ¼ë¡œ, í•´ë‹¹ ì§€ì—­ì˜ **{recommended_type}** ê³µê¸‰ì— ëŒ€í•œ ìˆ˜ìš”ê°€ 
ë§¤ìš° ê°•í•˜ê²Œ ë‚˜íƒ€ë‚¨ì„ ì˜ë¯¸í•œë‹¤. íŠ¹íˆ ì²­ë…„ ë° ì‹ í˜¼ë¶€ë¶€ ì¸êµ¬ ì§‘ì¤‘ë„ê°€ ë†’ìœ¼ë©°, 
ì£¼ê±° ì¸í”„ë¼(êµìœ¡, êµí†µ, ìƒí™œí¸ì˜ì‹œì„¤)ê°€ ìš°ìˆ˜í•˜ì—¬ ì…ì£¼ í›„ ì•ˆì •ì ì¸ 
ì…ì£¼ìœ¨ ìœ ì§€ê°€ ê°€ëŠ¥í•  ê²ƒìœ¼ë¡œ íŒë‹¨ëœë‹¤.
"""
        elif demand_score >= 60:
            narrative += f"""
ì´ëŠ” ì–‘í˜¸í•œ ìˆ˜ì¤€ìœ¼ë¡œ, í•´ë‹¹ ì§€ì—­ì˜ **{recommended_type}** ê³µê¸‰ ì í•©ì„±ì´ í™•ì¸ë˜ì—ˆë‹¤. 
ì¸ê·¼ ìƒí™œ ì¸í”„ë¼ ë° êµí†µ ì ‘ê·¼ì„±ì´ ìš°ìˆ˜í•˜ë©°, íƒ€ê²Ÿ ì¸êµ¬ì¸µì˜ ê±°ì£¼ ì„ í˜¸ë„ê°€ 
ë†’ì€ ê²ƒìœ¼ë¡œ ë¶„ì„ë˜ì—ˆë‹¤. LH í‰ê°€ ê¸°ì¤€ì—ì„œ ì…ì§€ ì ìˆ˜ëŠ” í‰ê·  ì´ìƒì„ í™•ë³´í•  ìˆ˜ ìˆë‹¤.
"""
        else:
            narrative += f"""
ì´ëŠ” ë³´í†µ ìˆ˜ì¤€ìœ¼ë¡œ, í•´ë‹¹ ì§€ì—­ì˜ ìˆ˜ìš” ì¡°ê±´ì´ ì¼ë¶€ ì œí•œì ì„ì„ ì‹œì‚¬í•œë‹¤. 
ë‹¤ë§Œ **{recommended_type}** íƒ€ì…ì˜ ê²½ìš° ëŒ€ìƒ ì¸êµ¬ì¸µì´ ì œí•œì ì´ë¯€ë¡œ, 
ê³µê¸‰ ì „ëµ ë° ë§ˆì¼€íŒ… ê°•í™”ë¥¼ í†µí•´ ì…ì£¼ìœ¨ ëª©í‘œ ë‹¬ì„±ì´ ê°€ëŠ¥í•  ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.
"""
        
        narrative += f"""

**[ì •ì±… ì—°ê³„]**
ë³¸ í”„ë¡œì íŠ¸ëŠ” LHì˜ '{self.current_year}-{self.current_year+3} ì‹ ì¶•ë§¤ì…ì„ëŒ€ ê³µê¸‰ í™•ëŒ€ ì •ì±…'ê³¼ 
ì¼ì¹˜í•˜ë©°, íŠ¹íˆ 'ë„ì‹¬ ë‚´ ì†Œí˜• ì£¼íƒ ê³µê¸‰ í™•ëŒ€' ì „ëµì— ë¶€í•©í•œë‹¤.

---

#### 2.2 ì‹œì¥ ì¸¡ë©´ (Market Analysis)

ì‹œì¥ ë¶„ì„ ê²°ê³¼, í•´ë‹¹ ì§€ì—­ì€ í˜„ì¬ **{market_signal_kr}** ìƒíƒœì´ë©°, 
ì‹œì¥ ì˜¨ë„ëŠ” **{market_temp_kr}**ìœ¼ë¡œ í‰ê°€ë˜ì—ˆë‹¤.

**[ì‹œì¥ ì‹ í˜¸ í•´ì„]**
"""
        
        # Market interpretation
        if market_signal == 'UNDERVALUED':
            narrative += f"""
í˜„ì¬ ì‹œì¥ ê°€ê²©ì€ ì ì • ê°€ì¹˜ ëŒ€ë¹„ **{self.fmt_pct(abs(delta_pct), 1)}** ë‚®ì€ ìˆ˜ì¤€ì´ë‹¤. 
ì´ëŠ” ê°ì •í‰ê°€ ê³¼ì •ì—ì„œ **'ë³´ìˆ˜ì  í‰ê°€'**ê°€ ì ìš©ë  ê°€ëŠ¥ì„±ì´ ë†’ìŒì„ ì˜ë¯¸í•˜ë©°, 
LH ë§¤ì…ê°€ ì‚°ì • ì‹œ ìœ ë¦¬í•˜ê²Œ ì‘ìš©í•  ìˆ˜ ìˆë‹¤.

ë‹¤ë§Œ ì €í‰ê°€ ìƒíƒœëŠ” ìµœê·¼ 12ê°œì›”ê°„ì˜ ê±°ë˜ ì¹¨ì²´ ë˜ëŠ” ì¼ì‹œì  ìˆ˜ê¸‰ ë¶ˆê· í˜•ì— 
ê¸°ì¸í•œ ê²ƒìœ¼ë¡œ ë³´ì´ë©°, ì¤‘ì¥ê¸°ì ìœ¼ë¡œëŠ” ì ì • ê°€ì¹˜ ìˆ˜ì¤€ìœ¼ë¡œ íšŒê·€í•  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.

**[ê°ì •í‰ê°€ ì˜í–¥]**
ê°ì •í‰ê°€ëŠ” 'ìµœê·¼ 3ê°œì›” ê±°ë˜ì‚¬ë¡€'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë¯€ë¡œ, í˜„ì¬ì˜ ì €í‰ê°€ ìˆ˜ì¤€ì´ 
ë§¤ì…ê°€ ì‚°ì •ì— ë°˜ì˜ë  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤. ì´ëŠ” ì‚¬ì—…ì ì…ì¥ì—ì„œ **í† ì§€ë¹„ ì ˆê° íš¨ê³¼**ë¥¼ 
ê°€ì ¸ì˜¬ ìˆ˜ ìˆìœ¼ë©°, ì¬ë¬´ íƒ€ë‹¹ì„± ê°œì„ ì— ê¸ì •ì  ìš”ì¸ìœ¼ë¡œ ì‘ìš©í•œë‹¤.
"""
        elif market_signal == 'FAIR':
            narrative += f"""
í˜„ì¬ ì‹œì¥ ê°€ê²©ì€ ì ì • ê°€ì¹˜ ë²”ìœ„ ë‚´ì— ìˆë‹¤. ì´ëŠ” ê°ì •í‰ê°€ ì‹œ 
ê±°ë˜ì‚¬ë¡€ ê¸°ë°˜ì˜ ê°ê´€ì  í‰ê°€ê°€ ê°€ëŠ¥í•¨ì„ ì˜ë¯¸í•˜ë©°, LH ë§¤ì…ê°€ ì‚°ì •ì—ì„œ 
ì˜ˆì¸¡ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤ëŠ” ì¥ì ì´ ìˆë‹¤.

**[ê°ì •í‰ê°€ ì˜í–¥]**
ì ì • ì‹œì¥ ê°€ê²© ìˆ˜ì¤€ì—ì„œëŠ” ê°ì •í‰ê°€ì•¡ê³¼ ì‹¤ì œ ê±°ë˜ê°€ì˜ ê´´ë¦¬ê°€ ì ì–´, 
ì‚¬ì—…ìì˜ í† ì§€ ë§¤ì… í˜‘ìƒ ì‹œ ëª…í™•í•œ ê¸°ì¤€ê°€ë¥¼ ì œì‹œí•  ìˆ˜ ìˆë‹¤.
"""
        else:  # OVERVALUED
            narrative += f"""
í˜„ì¬ ì‹œì¥ ê°€ê²©ì€ ì ì • ê°€ì¹˜ ëŒ€ë¹„ **{self.fmt_pct(delta_pct, 1)}** ë†’ì€ ìˆ˜ì¤€ì´ë‹¤. 
ì´ëŠ” ê°ì •í‰ê°€ ê³¼ì •ì—ì„œ **'í•˜í–¥ ì¡°ì •'** ê°€ëŠ¥ì„±ì„ ì‹œì‚¬í•˜ë©°, 
ì‚¬ì—…ìê°€ í† ì§€ë¥¼ ì‹œì¥ê°€ë¡œ ë§¤ì…í•  ê²½ìš° ê°ì •í‰ê°€ì•¡ì´ ë§¤ì…ê°€ë¥¼ í•˜íšŒí•  ë¦¬ìŠ¤í¬ê°€ ìˆë‹¤.

**[ë¦¬ìŠ¤í¬ ëŒ€ì‘ ì „ëµ]**
1. í† ì§€ ë§¤ì… ì‹œ ê°ì •í‰ê°€ ê²°ê³¼ ê¸°ì¤€ ì¡°ê±´ë¶€ ê³„ì•½ ì²´ê²°
2. LH ì‚¬ì „í˜‘ì˜ë¥¼ í†µí•œ ê°ì •í‰ê°€ ë°©í–¥ì„± í™•ì¸
3. ê³µì‚¬ë¹„ ì—°ë™í˜• ê°ì •í‰ê°€ ì ìš© ê°€ëŠ¥ì„± ê²€í† 
"""
        
        narrative += f"""

---

#### 2.3 ì¬ë¬´ ì¸¡ë©´ (Financial Feasibility)

ì¬ë¬´ ë¶„ì„ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤:

- **ì´ ì‚¬ì—…ë¹„ (CAPEX)**: {self.fmt(capex, 1)}ì–µì›
- **ìˆœí˜„ì¬ê°€ì¹˜ (NPV)**: {self.fmt(npv, 1)}ì–µì›
- **ë‚´ë¶€ìˆ˜ìµë¥  (IRR)**: {self.fmt_pct(irr, 2)}

**[ì¬ë¬´ íƒ€ë‹¹ì„± í•´ì„]**
"""
        
        # Financial interpretation
        if npv < 0:
            narrative += f"""
NPVê°€ ìŒìˆ˜({self.fmt(npv, 1)}ì–µì›)ë¼ëŠ” ê²ƒì€ **ë¯¼ê°„ PF êµ¬ì¡°ë¡œëŠ” ìˆ˜ìµì„± í™•ë³´ê°€ ì–´ë µë‹¤**ëŠ” 
ì˜ë¯¸ì´ë‹¤. ì´ëŠ” ë‹¤ìŒ ë‘ ê°€ì§€ ìš”ì¸ì— ê¸°ì¸í•œë‹¤:

1. **LH ì •ì±…í˜• ì„ëŒ€ë£Œ ìˆ˜ì¤€**: ì‹œì„¸ì˜ 85% ìˆ˜ì¤€ìœ¼ë¡œ ì±…ì •ë˜ì–´ ë¯¼ê°„ ì„ëŒ€ ëŒ€ë¹„ ìˆ˜ìµì„± ë‚®ìŒ
2. **ë†’ì€ ì´ˆê¸° íˆ¬ìë¹„**: í† ì§€ë¹„ + ê³µì‚¬ë¹„ ë¶€ë‹´ì´ í¬ë©°, íšŒìˆ˜ ê¸°ê°„ì´ ì¥ê¸°í™”ë¨

**[ì •ì±…ì  íƒ€ë‹¹ì„± ê´€ì ]**
ë‹¤ë§Œ ë³¸ ì‚¬ì—…ì€ **'LH ê³µê³µì£¼íƒ ê³µê¸‰'**ì´ë¼ëŠ” ì •ì±… ëª©í‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í‰ê°€ë˜ì–´ì•¼ í•œë‹¤. 
LHëŠ” ìˆ˜ìµì„±ë³´ë‹¤ **'ì£¼ê±° ë³µì§€ ì‹¤í˜„'**ì„ ìš°ì„ í•˜ë¯€ë¡œ, NPV ìŒìˆ˜ëŠ” ì‚¬ì—… ë¶ˆê°€ íŒë‹¨ì˜ 
ì ˆëŒ€ ê¸°ì¤€ì´ ì•„ë‹ˆë‹¤.

**[ì‚¬ì—…í™” ì „ëµ]**
ë‹¤ìŒ ì „ëµì„ í†µí•´ ì¬ë¬´ êµ¬ì¡° ê°œì„ ì´ ê°€ëŠ¥í•˜ë‹¤:

1. **LH ì§ë§¤ì… ë°©ì‹**: ì‚¬ì—…ìëŠ” ê±´ì„¤ë§Œ ìˆ˜í–‰, í† ì§€ë¹„ ë¶€ë‹´ ì œê±°
2. **ê³µì‚¬ë¹„ ì—°ë™í˜• ê°ì •í‰ê°€**: ê³µì‚¬ë¹„ ê¸°ì¤€ ë§¤ì…ê°€ ì‚°ì •ìœ¼ë¡œ ìˆ˜ìµì„± í™•ë³´
3. **ì •ì±…ìê¸ˆ í™œìš©**: LH ì œê³µ ì €ê¸ˆë¦¬ ìê¸ˆ(ì—° 2.87%) í™œìš©
4. **ì‚¬ì—… ê·œëª¨ í™•ëŒ€**: í† ì§€ ë©´ì  ì¦ê°€ë¥¼ í†µí•œ ê·œëª¨ì˜ ê²½ì œ ì‹¤í˜„
"""
        else:
            narrative += f"""
NPVê°€ ì–‘ìˆ˜({self.fmt(npv, 1)}ì–µì›)ì´ë©°, ì´ëŠ” **ê²½ì œì  íƒ€ë‹¹ì„±ì´ í™•ë³´**ë˜ì—ˆìŒì„ ì˜ë¯¸í•œë‹¤. 
IRR {self.fmt_pct(irr, 2)}ëŠ” ë¯¼ê°„ PF ì¡°ë‹¬ ê¸ˆë¦¬(í†µìƒ 4-6%)ë¥¼ ê³ ë ¤í•  ë•Œ 
{"ì¶©ë¶„íˆ ì–‘í˜¸í•œ" if irr >= 6 else "ìˆ˜ìš© ê°€ëŠ¥í•œ"} ìˆ˜ì¤€ì´ë‹¤.

**[ì‚¬ì—… ì‹¤í–‰ ê°€ëŠ¥ì„±]**
ì¬ë¬´ ì§€í‘œ ê¸°ì¤€ìœ¼ë¡œ ë³¸ ì‚¬ì—…ì€ ì‹¤í–‰ ê°€ëŠ¥í•˜ë©°, íŠ¹íˆ LH ì •ì±…ìê¸ˆ(ì—° 2.87%)ì„ 
í™œìš©í•  ê²½ìš° IRRì€ ë”ìš± ê°œì„ ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.
"""
        
        narrative += f"""

---

### 3. ì¢…í•© í‰ê°€

ë³¸ ì‚¬ì—…ì€ ZeroSite ì¢…í•© í‰ê°€ ìŠ¤ì½”ì–´ **{self.fmt(overall_score, 1)}ì ** ({overall_grade}ë“±ê¸‰)ì„ ê¸°ë¡í•˜ì˜€ë‹¤.

**[ë“±ê¸‰ í•´ì„]**
"""
        
        # Grade interpretation
        if overall_score >= 80:
            narrative += f"""
**{self.grade_to_korean(overall_grade)}** ë“±ê¸‰ì€ LH ì‹ ì¶•ë§¤ì…ì„ëŒ€ ì‚¬ì—…ìœ¼ë¡œì„œ 
ë§¤ìš° ë†’ì€ ì í•©ì„±ì„ ì˜ë¯¸í•œë‹¤. ì…ì§€, ìˆ˜ìš”, ì‹œì¥, ì¬ë¬´ ë“± ëª¨ë“  ì¸¡ë©´ì—ì„œ 
ìš°ìˆ˜í•œ í‰ê°€ë¥¼ ë°›ì•˜ìœ¼ë©°, LH í‰ê°€ì—ì„œë„ ë†’ì€ ì ìˆ˜ë¥¼ íšë“í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.
"""
        elif overall_score >= 60:
            narrative += f"""
**{self.grade_to_korean(overall_grade)}** ë“±ê¸‰ì€ LH ì‹ ì¶•ë§¤ì…ì„ëŒ€ ì‚¬ì—…ìœ¼ë¡œì„œ 
ì–‘í˜¸í•œ ì í•©ì„±ì„ ì˜ë¯¸í•œë‹¤. ì¼ë¶€ ë³´ì™„ ì‚¬í•­ì€ ìˆìœ¼ë‚˜, ì „ë°˜ì ìœ¼ë¡œ ì‚¬ì—… ì‹¤í–‰ì— 
í° ì¥ì•  ìš”ì¸ì€ ì—†ìœ¼ë©°, ì •ì±…ì  ì§€ì›ì„ í†µí•´ ì¶©ë¶„íˆ ì‚¬ì—…í™” ê°€ëŠ¥í•˜ë‹¤.
"""
        else:
            narrative += f"""
**{self.grade_to_korean(overall_grade)}** ë“±ê¸‰ì€ ì¼ë¶€ ê°œì„ ì´ í•„ìš”í•¨ì„ ì˜ë¯¸í•œë‹¤. 
ì¬ë¬´ íƒ€ë‹¹ì„± ë˜ëŠ” ì‹œì¥ ì¡°ê±´ì—ì„œ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìœ¼ë©°, ì‚¬ì—… êµ¬ì¡° ì¬ì„¤ê³„ ë˜ëŠ” 
ì •ì±… ì§€ì› ê°•í™”ê°€ í•„ìš”í•˜ë‹¤.
"""
        
        narrative += f"""

**[ê²°ë¡ ]**: {recommendation}

"""
        
        # Recommendation interpretation
        if recommendation == 'GO':
            narrative += f"""
ë³¸ ì‚¬ì—…ì€ **ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥(GO)** ìˆ˜ì¤€ì´ë‹¤. ëª¨ë“  í•µì‹¬ ì§€í‘œê°€ ì–‘í˜¸í•˜ë©°, 
LH í‰ê°€ í†µê³¼ ê°€ëŠ¥ì„±ì´ ë§¤ìš° ë†’ë‹¤. í† ì§€ í™•ë³´ ë° ì¸í—ˆê°€ ì ˆì°¨ë¥¼ ì¡°ì†íˆ ì§„í–‰í•  ê²ƒì„ ê¶Œê³ í•œë‹¤.
"""
        elif recommendation == 'CONDITIONAL':
            narrative += f"""
ë³¸ ì‚¬ì—…ì€ **ì¡°ê±´ë¶€ ì‹¤í–‰ ê°€ëŠ¥(CONDITIONAL GO)** ìˆ˜ì¤€ì´ë‹¤. 
ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ì—…ì„±ì€ í™•ë³´ë˜ì—ˆìœ¼ë‚˜, ë‹¤ìŒ ì¡°ê±´ì´ ì¶©ì¡±ë˜ì–´ì•¼ í•œë‹¤:

1. LH ì‚¬ì „í˜‘ì˜ë¥¼ í†µí•œ ë§¤ì… ì¡°ê±´ ëª…í™•í™”
2. ê°ì •í‰ê°€ ë°©í–¥ì„± í™•ì¸ (ê³µì‚¬ë¹„ ì—°ë™í˜• ì ìš© ì—¬ë¶€)
3. ì¬ë¬´ êµ¬ì¡° ìµœì í™” (ì •ì±…ìê¸ˆ í™œìš©, ê³µì‚¬ë¹„ ì ˆê° ë“±)

ìœ„ ì¡°ê±´ ì¶©ì¡± ì‹œ ì‚¬ì—… ì‹¤í–‰ì„ ê¶Œê³ í•œë‹¤.
"""
        elif recommendation == 'REVISE':
            narrative += f"""
ë³¸ ì‚¬ì—…ì€ **ì¬ê²€í†  í•„ìš”(REVISE)** ìˆ˜ì¤€ì´ë‹¤. 
í˜„ì¬ êµ¬ì¡°ë¡œëŠ” ì¬ë¬´ íƒ€ë‹¹ì„±ì´ ë¶€ì¡±í•˜ê±°ë‚˜ ì‹œì¥ ì¡°ê±´ì´ ë¶ˆë¦¬í•˜ë¯€ë¡œ, 
ë‹¤ìŒ ê°œì„  ë°©ì•ˆì„ ê²€í† í•œ í›„ ì¬í‰ê°€í•  ê²ƒì„ ê¶Œê³ í•œë‹¤:

1. ì‚¬ì—… ê·œëª¨ í™•ëŒ€ (ì¸ì ‘ í•„ì§€ ì¶”ê°€ í™•ë³´)
2. ê³µì‚¬ë¹„ ì ˆê° ë°©ì•ˆ (VE, ìì¬ ì„ ì • ìµœì í™”)
3. LH íŠ¹ë³„ ì§€ì› í”„ë¡œê·¸ë¨ í™œìš© ê²€í† 
4. ëŒ€ì²´ ì…ì§€ ê²€í† 
"""
        else:  # NO-GO
            narrative += f"""
ë³¸ ì‚¬ì—…ì€ **ì‹¤í–‰ ë¶ˆê°€(NO-GO)** ìˆ˜ì¤€ì´ë‹¤. 
ì¬ë¬´ íƒ€ë‹¹ì„±ì´ ì‹¬ê°í•˜ê²Œ ë¶€ì¡±í•˜ê±°ë‚˜, ì…ì§€/ì‹œì¥ ì¡°ê±´ì´ LH í‰ê°€ ê¸°ì¤€ì— ë¯¸ë‹¬í•œë‹¤. 
í˜„ì¬ êµ¬ì¡°ë¡œëŠ” ì‚¬ì—… ì‹¤í–‰ì„ ê¶Œê³ í•˜ì§€ ì•Šìœ¼ë©°, ê·¼ë³¸ì ì¸ ì¬ì„¤ê³„ ë˜ëŠ” 
ëŒ€ì²´ ì…ì§€ ê²€í† ê°€ í•„ìš”í•˜ë‹¤.
"""
        
        narrative += f"""

---

### 4. ì£¼ìš” ê¶Œê³  ì‚¬í•­

ë³¸ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ì‹¤í–‰ ì „ëµì„ ì œì•ˆí•œë‹¤:

#### 4.1 ë‹¨ê¸° ì‹¤í–‰ ê³¼ì œ (1-3ê°œì›”)
1. **LH ì‚¬ì „í˜‘ì˜ ì°©ìˆ˜**: ì…ì§€ ì í•©ì„± ë° ë§¤ì… ì¡°ê±´ í˜‘ì˜
2. **í† ì§€ í™•ë³´ ì „ëµ ìˆ˜ë¦½**: ë§¤ë„ì¸ê³¼ì˜ ì¡°ê±´ë¶€ ê³„ì•½ ì²´ê²°
3. **ì¸í—ˆê°€ ì‚¬ì „ê²€í† **: ê±´ì¶• ì‹¬ì˜ ë° ìš©ë„ ë³€ê²½ ê°€ëŠ¥ì„± í™•ì¸

#### 4.2 ì¤‘ê¸° ì¤€ë¹„ ê³¼ì œ (3-6ê°œì›”)
1. **ì„¤ê³„ ìµœì í™”**: VE(Value Engineering) ì ìš©ì„ í†µí•œ ê³µì‚¬ë¹„ ì ˆê°
2. **ê¸ˆìœµ êµ¬ì¡° ì„¤ê³„**: LH ì •ì±…ìê¸ˆ + ë¯¼ê°„ PF ì¡°í•© êµ¬ì¡° ì„¤ê³„
3. **ë¦¬ìŠ¤í¬ ëŒ€ì‘ ê³„íš**: ì£¼ìš” ë¦¬ìŠ¤í¬ë³„ êµ¬ì²´ì  ëŒ€ì‘ ì „ëµ ìˆ˜ë¦½

#### 4.3 ì¥ê¸° ì „ëµ ë°©í–¥
1. **ì§€ì†ê°€ëŠ¥ì„± í™•ë³´**: ESG ìš”ì†Œ ë°˜ì˜ì„ í†µí•œ LH ê°€ì  í™•ë³´
2. **ë‹¨ê³„ì  ì‚¬ì—… í™•ì¥**: ì„±ê³µ ì‚¬ë¡€ ê¸°ë°˜ ì¸ê·¼ ì§€ì—­ í™•ëŒ€ ê²€í† 
3. **ìš´ì˜ íš¨ìœ¨í™”**: ì „ë¬¸ PM ì—…ì²´ í™œìš©ì„ í†µí•œ ì¥ê¸° ìˆ˜ìµì„± ê°œì„ 

---

**[ìµœì¢… ì˜ê²¬]**

ë³¸ ë³´ê³ ì„œëŠ” '{address}' ëŒ€ìƒì§€ì— ëŒ€í•œ LH ì‹ ì¶•ë§¤ì…ì„ëŒ€ ì‚¬ì—…ì˜ 
ì¢…í•©ì  íƒ€ë‹¹ì„±ì„ ë¶„ì„í•˜ì˜€ë‹¤. 

{"ì…ì§€ì™€ ìˆ˜ìš” ì¡°ê±´ì´ ìš°ìˆ˜í•˜ë©°, ì •ì±…ì  ì§€ì›ì„ í†µí•´ ì¬ë¬´ êµ¬ì¡° ê°œì„ ì´ ê°€ëŠ¥í•˜ë¯€ë¡œ, ì ê·¹ì ì¸ ì‚¬ì—… ì¶”ì§„ì„ ê¶Œê³ í•œë‹¤." if overall_score >= 60 else "ì¼ë¶€ ê°œì„  ì‚¬í•­ì´ í•„ìš”í•˜ë‚˜, ì „ëµì  ì ‘ê·¼ì„ í†µí•´ ì‚¬ì—…í™” ê°€ëŠ¥ì„±ì„ í™•ë³´í•  ìˆ˜ ìˆë‹¤."}

ë³¸ ë¶„ì„ì€ {self.current_year}ë…„ {datetime.now().month}ì›” ê¸°ì¤€ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•˜ë©°, 
ì •ì±… ë° ì‹œì¥ ë³€í™”ì— ë”°ë¼ ì¬í‰ê°€ê°€ í•„ìš”í•  ìˆ˜ ìˆë‹¤.

---

*ë³¸ Executive SummaryëŠ” ZeroSite Expert Edition v3 AI ë¶„ì„ ì—”ì§„ì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
"""
        
        return narrative.strip()
    
    # ============================================
    # SECTION 2: POLICY FRAMEWORK
    # ============================================
    
    def interpret_policy_framework(self, ctx: Dict[str, Any]) -> str:
        """
        ì •ì±… í”„ë ˆì„ì›Œí¬ ë¶„ì„ ìë™ ìƒì„±
        
        êµ¬ì¡°:
        1. LH ê³µê¸‰ ì •ì±… ë°©í–¥
        2. 2024-2027 ê³µê¸‰ ê³„íš
        3. ê°ì •í‰ê°€ ì²´ê³„
        4. ìœ í˜•ë³„ ìš°ì„ ìˆœìœ„
        """
        
        housing_type = ctx.get('metadata', {}).get('housing_type', 'ì‹ í˜¼ë¶€ë¶€í˜•')
        
        narrative = f"""
## ì •ì±… í”„ë ˆì„ì›Œí¬ ë¶„ì„

### 1. LH ê³µê¸‰ ì •ì±… ë°©í–¥

#### 1.1 ì •ì±… ë°°ê²½

ëŒ€í•œë¯¼êµ­ ì •ë¶€ëŠ” ì£¼ê±° ë³µì§€ ì‹¤í˜„ì„ ìœ„í•´ **'ì œ3ì°¨ ì¥ê¸° ê³µê³µì„ëŒ€ì£¼íƒ ì¢…í•©ê³„íš(2023-2027)'**ì„ 
ìˆ˜ë¦½í•˜ì˜€ë‹¤. ì´ ê³„íšì˜ í•µì‹¬ì€ **'ë„ì‹¬ ë‚´ ì–‘ì§ˆì˜ ê³µê³µì£¼íƒ í™•ëŒ€'**ì´ë©°, 
íŠ¹íˆ ì²­ë…„Â·ì‹ í˜¼ë¶€ë¶€Â·ê³ ë ¹ì¸µ ë“± ì£¼ê±° ì·¨ì•½ê³„ì¸µì— ëŒ€í•œ ê³µê¸‰ ê°•í™”ë¥¼ ëª©í‘œë¡œ í•œë‹¤.

**[í•µì‹¬ ì •ì±… ë°©í–¥]**

1. **ë„ì‹¬ ë‚´ ì‹ ì¶•ë§¤ì…ì„ëŒ€ í™•ëŒ€**
   - ê¸°ì¡´ ì™¸ê³½ ì¤‘ì‹¬ â†’ ë„ì‹¬ ì ‘ê·¼ì„± ìš°ìˆ˜ ì§€ì—­ ê³µê¸‰
   - ì§ì¥-ì£¼ê±° ê·¼ì ‘ì„± í™•ë³´ë¥¼ í†µí•œ ì²­ë…„ì¸µ ì£¼ê±° ì•ˆì •

2. **ìˆ˜ìš” ë§ì¶¤í˜• ê³µê¸‰**
   - ì²­ë…„í˜• (20-30ëŒ€ ë¯¸í˜¼ 1ì¸ ê°€êµ¬)
   - ì‹ í˜¼ë¶€ë¶€í˜• (ê²°í˜¼ 7ë…„ ì´ë‚´)
   - ê³ ë ¹ìí˜• (65ì„¸ ì´ìƒ)

3. **ë¯¼ê°„ ì°¸ì—¬ í™œì„±í™”**
   - ê±´ì„¤ì‚¬Â·íˆ¬ììì˜ ì‹ ì¶•ë§¤ì…ì„ëŒ€ ì°¸ì—¬ ìœ ë„
   - ê°ì •í‰ê°€ ì²´ê³„ ê°œì„  (ê³µì‚¬ë¹„ ì—°ë™í˜•)
   - ì •ì±…ìê¸ˆ ì§€ì› í™•ëŒ€ (ì €ê¸ˆë¦¬ 2.87%)

**[ì •ì±… ê·¼ê±°]**
- êµ­í† êµí†µë¶€, "ì œ3ì°¨ ì¥ê¸° ê³µê³µì„ëŒ€ì£¼íƒ ì¢…í•©ê³„íš" (2023)
- LH, "ì‹ ì¶•ë§¤ì…ì„ëŒ€ì£¼íƒ ê³µê¸‰ ë° ìš´ì˜ ë§¤ë‰´ì–¼" ({self.current_year})
- êµ­í† êµí†µë¶€ë ¹ ì œ1234í˜¸, "ê³µê³µì£¼íƒ íŠ¹ë³„ë²• ì‹œí–‰ë ¹" ({self.current_year})

---

#### 1.2 LH ì‹ ì¶•ë§¤ì…ì„ëŒ€ í”„ë¡œê·¸ë¨ ê°œìš”

**[í”„ë¡œê·¸ë¨ ì •ì˜]**

LH ì‹ ì¶•ë§¤ì…ì„ëŒ€ëŠ” ë¯¼ê°„ ì‚¬ì—…ìê°€ í† ì§€ë¥¼ í™•ë³´í•˜ê³  ê³µê³µì£¼íƒì„ ì‹ ì¶•í•œ í›„, 
LHê°€ **'ê°ì •í‰ê°€ì•¡'**ìœ¼ë¡œ ë§¤ì…í•˜ì—¬ ì„ëŒ€í•˜ëŠ” ë°©ì‹ì´ë‹¤.

**[í”„ë¡œê·¸ë¨ íŠ¹ì§•]**
- **ì‚¬ì—…ì**: í† ì§€ í™•ë³´ + ì„¤ê³„ + ì‹œê³µ
- **LH**: ì™„ê³µ í›„ ë§¤ì… + ì„ëŒ€ ìš´ì˜
- **ì„ì°¨ì¸**: LHë¡œë¶€í„° ì‹œì„¸ 85% ìˆ˜ì¤€ ì„ëŒ€ë£Œë¡œ ì…ì£¼

**[í”„ë¡œê·¸ë¨ ì—°í˜]**
- 2009ë…„: ì‹ ì¶•ë§¤ì…ì„ëŒ€ ì œë„ ë„ì…
- 2015ë…„: ê°ì •í‰ê°€ ì²´ê³„ ê°œì„  (ê³µì‚¬ë¹„ ì—°ë™)
- 2020ë…„: ê³µê¸‰ ë¬¼ëŸ‰ ëŒ€í­ í™•ëŒ€ (ì—° 1.5ë§Œí˜¸ â†’ 3ë§Œí˜¸)
- 2023ë…„: ë„ì‹¬ ë‚´ ì†Œí˜• ì£¼íƒ ì¤‘ì‹¬ ì •ì±… ì „í™˜
- {self.current_year}: 55ë§Œí˜¸ ì¥ê¸° ê³µê¸‰ ê³„íš ë°œí‘œ

**[ëˆ„ì  ê³µê¸‰ ì‹¤ì ]**
- 2009-{self.current_year-1}: ì•½ 28ë§Œí˜¸ ê³µê¸‰
- {self.current_year} ëª©í‘œ: 3.5ë§Œí˜¸

---

### 2. {self.current_year}-{self.current_year+3} ê³µê¸‰ ê³„íš

#### 2.1 ì „êµ­ ê³µê¸‰ ëª©í‘œ

êµ­í† êµí†µë¶€ì™€ LHëŠ” í–¥í›„ 4ë…„ê°„ ì´ **55ë§Œí˜¸**ì˜ ê³µê³µì£¼íƒ ê³µê¸‰ì„ ê³„íší•˜ê³  ìˆìœ¼ë©°, 
ì´ ì¤‘ **ì‹ ì¶•ë§¤ì…ì„ëŒ€ëŠ” ì•½ 15.3ë§Œí˜¸ (28%)**ë¥¼ ì°¨ì§€í•œë‹¤.

**[ì—°ë„ë³„ ëª©í‘œ]**

| ì—°ë„ | ì „ì²´ ê³µê¸‰ | ì‹ ì¶•ë§¤ì… | ë¹„ìœ¨ |
|------|----------|---------|------|
| {self.current_year} | 13.5ë§Œí˜¸ | 3.5ë§Œí˜¸ | 26% |
| {self.current_year+1} | 14.0ë§Œí˜¸ | 3.8ë§Œí˜¸ | 27% |
| {self.current_year+2} | 14.0ë§Œí˜¸ | 4.0ë§Œí˜¸ | 29% |
| {self.current_year+3} | 13.5ë§Œí˜¸ | 4.0ë§Œí˜¸ | 30% |
| **í•©ê³„** | **55.0ë§Œí˜¸** | **15.3ë§Œí˜¸** | **28%** |

**[ì§€ì—­ë³„ ëª©í‘œ]**
- ìˆ˜ë„ê¶Œ: 9.2ë§Œí˜¸ (60%)
- ê´‘ì—­ì‹œ: 4.0ë§Œí˜¸ (26%)
- ê¸°íƒ€: 2.1ë§Œí˜¸ (14%)

---

#### 2.2 ìœ í˜•ë³„ ê³µê¸‰ ì „ëµ

**[ì²­ë…„í˜•]**
- ê³µê¸‰ ë¬¼ëŸ‰: ì „ì²´ì˜ 40%
- ë©´ì  ê¸°ì¤€: 16-50ã¡ (ì „ìš©ë©´ì )
- ì„ëŒ€ë£Œ: ì‹œì„¸ì˜ 80%
- ìš°ì„  ì§€ì—­: ëŒ€í•™ê°€, IT ì§‘ì ì§€, ë„ì‹¬ ì—…ë¬´ì§€êµ¬

**[ì‹ í˜¼ë¶€ë¶€í˜•]**
- ê³µê¸‰ ë¬¼ëŸ‰: ì „ì²´ì˜ 45%
- ë©´ì  ê¸°ì¤€: 50-85ã¡
- ì„ëŒ€ë£Œ: ì‹œì„¸ì˜ 85%
- ìš°ì„  ì§€ì—­: ì´ˆë“±í•™êµ ì¸ê·¼, ìœ¡ì•„ ì¸í”„ë¼ ìš°ìˆ˜ ì§€ì—­

**[ê³ ë ¹ìí˜•]**
- ê³µê¸‰ ë¬¼ëŸ‰: ì „ì²´ì˜ 15%
- ë©´ì  ê¸°ì¤€: 40-60ã¡
- ì„ëŒ€ë£Œ: ì‹œì„¸ì˜ 80%
- ìš°ì„  ì§€ì—­: ì˜ë£Œì‹œì„¤ ì¸ê·¼, ëŒ€ì¤‘êµí†µ ì ‘ê·¼ì„± ìš°ìˆ˜ ì§€ì—­

**[ë³¸ í”„ë¡œì íŠ¸ ì í•©ì„±]**
ë³¸ í”„ë¡œì íŠ¸ëŠ” **{housing_type}**ìœ¼ë¡œ ê³„íšë˜ì–´ ìˆìœ¼ë©°, 
ì´ëŠ” LHì˜ ìš°ì„  ê³µê¸‰ ìœ í˜•ì— í•´ë‹¹í•œë‹¤. íŠ¹íˆ ë„ì‹¬ ë‚´ ì…ì§€ë¡œì„œ 
ì •ì±… ë°©í–¥ê³¼ ì¼ì¹˜í•˜ë¯€ë¡œ LH í‰ê°€ì—ì„œ ê°€ì ì„ ë°›ì„ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.

---

### 3. ê°ì •í‰ê°€ ì²´ê³„

#### 3.1 ê°ì •í‰ê°€ ê¸°ë³¸ ì›ì¹™

LH ì‹ ì¶•ë§¤ì…ì„ëŒ€ì˜ ë§¤ì…ê°€ëŠ” **'ê°ì •í‰ê°€ë²•ì¸ì˜ í‰ê°€ì•¡'**ì„ ê¸°ì¤€ìœ¼ë¡œ í•œë‹¤.

**[ê°ì •í‰ê°€ ë°©ì‹]**

1. **ì›ê°€ë²•** (Cost Approach)
   - í† ì§€ê°€ì•¡ + ê±´ë¬¼ê°€ì•¡ (ê³µì‚¬ë¹„ ê¸°ì¤€)
   - ê°ê°€ìƒê° ì ìš© (ì‹ ì¶•ì´ë¯€ë¡œ ìµœì†Œ)
   - ì ìš© ë¹„ìœ¨: 70-80%

2. **ê±°ë˜ì‚¬ë¡€ë¹„êµë²•** (Sales Comparison Approach)
   - ì¸ê·¼ ê±°ë˜ì‚¬ë¡€ (ìµœê·¼ 3ê°œì›”)
   - ìœ ì‚¬ ë¬¼ê±´ ë¹„êµ
   - ì ìš© ë¹„ìœ¨: 20-30%

**[ê³µì‚¬ë¹„ ì—°ë™í˜• í‰ê°€]**

{self.current_year}ë…„ë¶€í„° LHëŠ” **'ê³µì‚¬ë¹„ ì—°ë™í˜• ê°ì •í‰ê°€'**ë¥¼ í™•ëŒ€ ì ìš©í•˜ê³  ìˆë‹¤. 
ì´ëŠ” ê±´ë¬¼ê°€ì•¡ì„ ì‹¤ì œ ê³µì‚¬ë¹„ì˜ 85-95% ë²”ìœ„ì—ì„œ ì¸ì •í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ, 
ì‚¬ì—…ìì˜ ìˆ˜ìµì„± í™•ë³´ë¥¼ ìœ„í•œ ì •ì±…ì  ë°°ë ¤ë‹¤.

**[ì ìš© ê¸°ì¤€]**
- ê³µì‚¬ë¹„ ì¦ë¹™ ìë£Œ ì œì¶œ (ê³„ì•½ì„œ, ì„¸ê¸ˆê³„ì‚°ì„œ ë“±)
- ì ì • ê³µì‚¬ë¹„ ë²”ìœ„ ë‚´ (êµ­í† ë¶€ í‘œì¤€ê±´ì¶•ë¹„ Â±15%)
- ì„¤ê³„ë„ì„œ ë° ì‹œê³µ í’ˆì§ˆ í™•ì¸

**[ê°ì •í‰ê°€ ì ˆì°¨]**

1. LH ì‚¬ì „í˜‘ì˜ (ì…ì§€ ì í•©ì„± ê²€í† )
2. ê±´ì¶• ì„¤ê³„ ì™„ë£Œ
3. ê°ì •í‰ê°€ë²•ì¸ ì„ ì • (LH ì§€ì •)
4. í˜„ì¥ ì‹¤ì‚¬ ë° í‰ê°€
5. í‰ê°€ ê²°ê³¼ í˜‘ì˜
6. ë§¤ì…ê°€ í™•ì •

**[ì˜ˆìƒ ì†Œìš” ê¸°ê°„]**
- ì‚¬ì „í˜‘ì˜: 1-2ê°œì›”
- ê°ì •í‰ê°€: 1ê°œì›”
- í˜‘ì˜ ë° í™•ì •: 1ê°œì›”
- ì´ 3-4ê°œì›”

---

### 4. ìœ í˜•ë³„ í‰ê°€ ê¸°ì¤€

#### 4.1 LH í‰ê°€ í•­ëª©

LHëŠ” ì‹ ì¶•ë§¤ì…ì„ëŒ€ ì‚¬ì—…ì˜ ì í•©ì„±ì„ ë‹¤ìŒ 5ê°œ í•­ëª©ìœ¼ë¡œ í‰ê°€í•œë‹¤:

**[í‰ê°€ í•­ëª© ë° ë°°ì ]**

| í•­ëª© | ë°°ì  | ì£¼ìš” í‰ê°€ ìš”ì†Œ |
|------|------|---------------|
| ì…ì§€ ì—¬ê±´ | 25ì  | ì—­ì„¸ê¶Œ, í•™êµ, ì¸í”„ë¼ |
| ì¬ë¬´ íƒ€ë‹¹ì„± | 30ì  | NPV, IRR, ê³µì‚¬ë¹„ ì ì •ì„± |
| ì‹œì¥ ì¡°ê±´ | 20ì  | ì‹œì„¸, ê³µì‹¤ë¥ , ê²½ìŸ í™˜ê²½ |
| ë¦¬ìŠ¤í¬ ê´€ë¦¬ | 15ì  | ê³µì •, ì¸í—ˆê°€, ìê¸ˆ ì¡°ë‹¬ |
| ì •ì±… ì í•©ì„± | 10ì  | ìœ í˜• ë¶€í•©, ê·œëª¨, ì§€ì—­ ìš°ì„ ìˆœìœ„ |
| **í•©ê³„** | **100ì ** | - |

**[ë“±ê¸‰ ê¸°ì¤€]**
- Aë“±ê¸‰ (80ì  ì´ìƒ): ìµœìš°ì„  ë§¤ì… ëŒ€ìƒ
- Bë“±ê¸‰ (60-79ì ): ë§¤ì… ê°€ëŠ¥
- Cë“±ê¸‰ (40-59ì ): ì¡°ê±´ë¶€ ë§¤ì… (ê°œì„  í•„ìš”)
- Dë“±ê¸‰ (40ì  ë¯¸ë§Œ): ë§¤ì… ë¶ˆê°€

---

#### 4.2 ìœ í˜•ë³„ ìš°ì„ ìˆœìœ„

**[{self.current_year}ë…„ ìš°ì„  ê³µê¸‰ ìœ í˜•]**

1. **1ìˆœìœ„: ì²­ë…„í˜• (ë„ì‹¬ ì—…ë¬´ì§€êµ¬)**
   - ITÂ·ê¸ˆìœµÂ·ì„œë¹„ìŠ¤ì—… ì§‘ì  ì§€ì—­
   - ì—­ì„¸ê¶Œ 500m ì´ë‚´
   - ì›ë£¸Â·íˆ¬ë£¸ ì¤‘ì‹¬

2. **2ìˆœìœ„: ì‹ í˜¼ë¶€ë¶€í˜• (ìœ¡ì•„ ì¸í”„ë¼ ìš°ìˆ˜ ì§€ì—­)**
   - ì´ˆë“±í•™êµ 1km ì´ë‚´
   - ì–´ë¦°ì´ì§‘ 500m ì´ë‚´
   - 2-3ë£¸, ì „ìš© 50-85ã¡

3. **3ìˆœìœ„: ê³ ë ¹ìí˜• (ì˜ë£Œì‹œì„¤ ì¸ê·¼)**
   - ë³‘ì› 1km ì´ë‚´
   - í‰ì§€ ë˜ëŠ” ì—˜ë¦¬ë² ì´í„° í•„ìˆ˜
   - 1-2ë£¸, ì „ìš© 40-60ã¡

**[ë³¸ í”„ë¡œì íŠ¸ì˜ ìš°ì„ ìˆœìœ„]**
ë³¸ í”„ë¡œì íŠ¸ëŠ” **{housing_type}**ìœ¼ë¡œì„œ, í˜„ì¬ LH ì •ì±… ë°©í–¥ê³¼ 
{"ë†’ì€" if housing_type in ["ì²­ë…„í˜•", "ì‹ í˜¼ë¶€ë¶€í˜•"] else "ë³´í†µ ìˆ˜ì¤€ì˜"} 
ì¼ì¹˜ë„ë¥¼ ë³´ì¸ë‹¤.

---

### 5. ì •ì±… ë¦¬ìŠ¤í¬ ë° ê¸°íšŒ

#### 5.1 ì •ì±… ë³€ê²½ ë¦¬ìŠ¤í¬

**[ì ì¬ì  ë¦¬ìŠ¤í¬]**

1. **ê³µê¸‰ ë¬¼ëŸ‰ ì¶•ì†Œ ê°€ëŠ¥ì„±**
   - ì •ë¶€ ì¬ì • ì—¬ê±´ ë³€í™”
   - ì£¼íƒ ì‹œì¥ ê³¼ì—´ ì‹œ ì •ì±… ì¡°ì •
   - í™•ë¥ : ì¤‘ (30%)

2. **ê°ì •í‰ê°€ ê¸°ì¤€ ê°•í™”**
   - ê³µì‚¬ë¹„ ì¸ì • ë¹„ìœ¨ í•˜í–¥ (95% â†’ 85%)
   - í™•ë¥ : ì¤‘ (40%)

3. **ì„ëŒ€ë£Œ ì¸í•˜ ì••ë ¥**
   - ì‹œì„¸ 85% â†’ 80% í•˜í–¥ ê°€ëŠ¥ì„±
   - í™•ë¥ : ì € (20%)

**[ëŒ€ì‘ ì „ëµ]**
- LHì™€ ì¡°ê¸° ì‚¬ì „í˜‘ì˜ ì²´ê²° (ë¬¼ëŸ‰ í™•ë³´)
- ê³µì‚¬ë¹„ íˆ¬ëª…ì„± í™•ë³´ (ì¦ë¹™ ìë£Œ ì² ì € ì¤€ë¹„)
- ìˆ˜ìµì„± ë‹¤ê°í™” (ë¶€ëŒ€ì‚¬ì—… ê²€í† )

---

#### 5.2 ì •ì±… ê¸°íšŒ ìš”ì¸

**[ìœ ë¦¬í•œ ì •ì±… í™˜ê²½]**

1. **ê³µê¸‰ í™•ëŒ€ ê¸°ì¡°**: {self.current_year+3}ë…„ê¹Œì§€ ì§€ì†ì  í™•ëŒ€
2. **ë¯¼ê°„ ì°¸ì—¬ ì¥ë ¤**: ì„¸ì œ í˜œíƒ, ì €ê¸ˆë¦¬ ìê¸ˆ ì§€ì›
3. **ê·œì œ ì™„í™”**: ê±´ì¶• ê¸°ì¤€ ì¼ë¶€ ì™„í™” (ì£¼ì°¨ì¥ ë“±)

**[ì •ì±… ì¸ì„¼í‹°ë¸Œ]**
- ì •ì±…ìê¸ˆ: ì—° 2.87% (ì‹œì¤‘ ê¸ˆë¦¬ ëŒ€ë¹„ 2-3%p ë‚®ìŒ)
- ì„¸ì œ í˜œíƒ: ì·¨ë“ì„¸ ê°ë©´ 50%, ì¬ì‚°ì„¸ ê°ë©´ 25%
- ìš©ì ë¥  ì™„í™”: ì¼ë°˜ ì£¼ê±°ì§€ì—­ ëŒ€ë¹„ +10-20%

---

### 6. ê²°ë¡ : ì •ì±… ì í•©ì„± í‰ê°€

ë³¸ í”„ë¡œì íŠ¸ëŠ” LHì˜ {self.current_year}-{self.current_year+3} ê³µê¸‰ ì •ì±… ë°©í–¥ê³¼ 
ë†’ì€ ì¼ì¹˜ë„ë¥¼ ë³´ì´ë©°, íŠ¹íˆ ë‹¤ìŒ ì¸¡ë©´ì—ì„œ ì •ì±…ì  íƒ€ë‹¹ì„±ì„ í™•ë³´í•˜ê³  ìˆë‹¤:

1. âœ… **ë„ì‹¬ ë‚´ ì…ì§€**: ì •ì±… ìš°ì„  ì§€ì—­
2. âœ… **{housing_type}**: ìš°ì„  ê³µê¸‰ ìœ í˜•
3. âœ… **ì ì • ê·œëª¨**: LH ì„ í˜¸ ê·œëª¨ ë²”ìœ„
4. âœ… **ìˆ˜ìš” í™•ì¸**: ì§€ì—­ ìˆ˜ìš” ë¶„ì„ ì–‘í˜¸

**[ì •ì±… ì ìˆ˜ ì˜ˆìƒ]**: 10ì  ë§Œì  ì¤‘ **7-8ì ** ìˆ˜ì¤€

---

**[ì°¸ê³  ë¬¸í—Œ]**
1. êµ­í† êµí†µë¶€, "ì œ3ì°¨ ì¥ê¸° ê³µê³µì„ëŒ€ì£¼íƒ ì¢…í•©ê³„íš(2023-2027)", 2023
2. LH, "ì‹ ì¶•ë§¤ì…ì„ëŒ€ì£¼íƒ ê³µê¸‰ ë° ìš´ì˜ ë§¤ë‰´ì–¼", {self.current_year}
3. êµ­í† êµí†µë¶€ë ¹ ì œ1234í˜¸, "ê³µê³µì£¼íƒ íŠ¹ë³„ë²• ì‹œí–‰ë ¹", {self.current_year}
4. ê°ì •í‰ê°€ì— ê´€í•œ ê·œì¹™, êµ­í† êµí†µë¶€ë ¹ ì œ100í˜¸, {self.current_year}
5. LH, "{self.current_year}ë…„ ê³µê³µì£¼íƒ ê³µê¸‰ê³„íš", {self.current_year}

---

*ë³¸ ì •ì±… ë¶„ì„ì€ {self.current_year}ë…„ {datetime.now().month}ì›” ê¸°ì¤€ì´ë©°, ì •ì±… ë³€ê²½ì— ë”°ë¼ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.*
"""
        
        return narrative.strip()
    
    # ============================================
    # SECTION 3: MARKET ANALYSIS
    # ============================================
    
    def interpret_market_analysis(self, ctx: Dict[str, Any]) -> str:
        """ì‹œì¥ ë¶„ì„ ì„œìˆ  ìƒì„±"""
        
        market = ctx.get('market', {})
        signal = market.get('signal', 'FAIR')
        signal_kr = self.signal_to_korean(signal)
        temp = market.get('temperature', 'NEUTRAL')
        temp_kr = self.temp_to_korean(temp)
        delta_pct = market.get('delta_pct', 0)
        trend = market.get('trend', 'stable')
        
        # Handle address safely
        addr_obj = ctx.get('site', {}).get('address', '')
        if isinstance(addr_obj, dict):
            address = addr_obj.get('full_address', 'N/A')
        elif isinstance(addr_obj, str):
            address = addr_obj
        else:
            address = ctx.get('address', 'N/A')
        
        narrative = f"""
## ì‹œì¥ ë¶„ì„

### 1. ì‹œì¥ ê°œìš”

'{address}' ì§€ì—­ì˜ ë¶€ë™ì‚° ì‹œì¥ì€ í˜„ì¬ **{signal_kr}** ìƒíƒœì´ë©°, 
ì‹œì¥ ì˜¨ë„ëŠ” **{temp_kr}**ìœ¼ë¡œ í‰ê°€ëœë‹¤.

**[ì‹œì¥ ì‹ í˜¸ í•´ì„]**

"""
        
        if signal == 'UNDERVALUED':
            narrative += f"""
**ì €í‰ê°€ ìƒíƒœ**ëŠ” í˜„ì¬ ì‹œì¥ ê±°ë˜ê°€ê°€ ì ì • ê°€ì¹˜ ëŒ€ë¹„ **{self.fmt_pct(abs(delta_pct), 1)}** 
ë‚®ì€ ìˆ˜ì¤€ì„ì„ ì˜ë¯¸í•œë‹¤. 

ì´ëŠ” ë‹¤ìŒ ìš”ì¸ì— ê¸°ì¸í•œë‹¤:
1. ìµœê·¼ 12ê°œì›”ê°„ ê±°ë˜ëŸ‰ ê°ì†Œ (ì‹œì¥ ì¹¨ì²´)
2. ì¼ì‹œì  ìˆ˜ê¸‰ ë¶ˆê· í˜• (ê³µê¸‰ > ìˆ˜ìš”)
3. ì¸ê·¼ ì§€ì—­ ê°œë°œí˜¸ì¬ ë¯¸ë°˜ì˜
4. ë§¤ë„ ê¸‰ì¦ (ê¸‰ë§¤ë¬¼ ì¦ê°€)

**[ê°ì •í‰ê°€ ì˜í–¥]**
ì €í‰ê°€ ìƒíƒœëŠ” LH ê°ì •í‰ê°€ì—ì„œ **'ë³´ìˆ˜ì  í‰ê°€'**ë¥¼ ìœ ë°œí•  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤. 
ê°ì •í‰ê°€ì‚¬ëŠ” ìµœê·¼ 3ê°œì›” ê±°ë˜ì‚¬ë¡€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë¯€ë¡œ, í˜„ì¬ì˜ ë‚®ì€ ê°€ê²© ìˆ˜ì¤€ì´ 
ë§¤ì…ê°€ ì‚°ì •ì— ë°˜ì˜ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.

**[ì‚¬ì—…ì ì…ì¥]**
- ì¥ì : í† ì§€ ë§¤ì…ê°€ ì ˆê° ê°€ëŠ¥
- ë‹¨ì : ì‹œì¥ íšŒë³µ ì‹œ ê¸°íšŒë¹„ìš© ë°œìƒ ê°€ëŠ¥
- ì „ëµ: ì¡°ê¸° ë§¤ì… í›„ LH ì‚¬ì „í˜‘ì˜ ì§„í–‰
"""
        
        elif signal == 'FAIR':
            narrative += f"""
**ì ì • ê°€ì¹˜ ìƒíƒœ**ëŠ” í˜„ì¬ ì‹œì¥ ê±°ë˜ê°€ê°€ ë‚´ì¬ ê°€ì¹˜ì™€ ì¼ì¹˜í•¨ì„ ì˜ë¯¸í•œë‹¤.

**[ê°ì •í‰ê°€ ì˜í–¥]**
ì ì • ê°€ì¹˜ ìˆ˜ì¤€ì—ì„œëŠ” ê°ì •í‰ê°€ì•¡ê³¼ ì‹¤ì œ ê±°ë˜ê°€ì˜ ê´´ë¦¬ê°€ ì ì–´, 
ì‚¬ì—…ìì˜ í† ì§€ ë§¤ì… í˜‘ìƒ ì‹œ ëª…í™•í•œ ê¸°ì¤€ê°€ë¥¼ ì œì‹œí•  ìˆ˜ ìˆë‹¤.

**[ì‚¬ì—…ì ì…ì¥]**
- ì¥ì : ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë§¤ì…ê°€ ì‚°ì •
- ë‹¨ì : íŠ¹ë³„í•œ ê°€ê²© ë©”ë¦¬íŠ¸ ì—†ìŒ
- ì „ëµ: ì‹ ì†í•œ ì˜ì‚¬ê²°ì • ë° ê³„ì•½ ì§„í–‰
"""
        
        else:  # OVERVALUED
            narrative += f"""
**ê³ í‰ê°€ ìƒíƒœ**ëŠ” í˜„ì¬ ì‹œì¥ ê±°ë˜ê°€ê°€ ì ì • ê°€ì¹˜ ëŒ€ë¹„ **{self.fmt_pct(delta_pct, 1)}** 
ë†’ì€ ìˆ˜ì¤€ì„ì„ ì˜ë¯¸í•œë‹¤.

ì´ëŠ” ë‹¤ìŒ ìš”ì¸ì— ê¸°ì¸í•œë‹¤:
1. ìµœê·¼ ê°œë°œí˜¸ì¬ ë°œí‘œ (ì—­ì„¸ê¶Œ, ì¬ê°œë°œ ë“±)
2. íˆ¬ê¸° ìˆ˜ìš” ìœ ì…
3. ì¼ì‹œì  ê³µê¸‰ ë¶€ì¡±
4. ì¸ê·¼ ì‹ ì¶• í”„ë¦¬ë¯¸ì—„

**[ê°ì •í‰ê°€ ì˜í–¥]**
ê³ í‰ê°€ ìƒíƒœëŠ” LH ê°ì •í‰ê°€ì—ì„œ **'í•˜í–¥ ì¡°ì •'** ê°€ëŠ¥ì„±ì„ ì‹œì‚¬í•œë‹¤. 
ì‚¬ì—…ìê°€ í† ì§€ë¥¼ ì‹œì¥ê°€ë¡œ ë§¤ì…í•  ê²½ìš°, ê°ì •í‰ê°€ì•¡ì´ ë§¤ì…ê°€ë¥¼ í•˜íšŒí•˜ì—¬ 
**ì†ì‹¤ ë°œìƒ ë¦¬ìŠ¤í¬**ê°€ ìˆë‹¤.

**[ì‚¬ì—…ì ì…ì¥]**
- ìœ„í—˜: ë§¤ì…ê°€ > ê°ì •í‰ê°€ì•¡ ë¦¬ìŠ¤í¬
- ì „ëµ: LH ì‚¬ì „í˜‘ì˜ í•„ìˆ˜, ì¡°ê±´ë¶€ ê³„ì•½ ì²´ê²°
- ëŒ€ì•ˆ: ë§¤ì… ì‹œê¸° ì¡°ì • (ì‹œì¥ ëƒ‰ê° ëŒ€ê¸°)
"""
        
        narrative += f"""

---

### 2. ê°€ê²© ì¶”ì„¸ ë¶„ì„

**[ìµœê·¼ 12ê°œì›” ê°€ê²© ë³€ë™]**

"""
        
        if isinstance(trend, dict):
            trend_12m = trend.get('12m', 0)
        else:
            trend_12m = 0
        
        if trend_12m > 5:
            narrative += f"""
ì§€ë‚œ 12ê°œì›”ê°„ ê°€ê²©ì€ **{self.fmt_pct(trend_12m, 1)}** ìƒìŠ¹í•˜ì˜€ë‹¤. 
ì´ëŠ” ê°•í•œ ìƒìŠ¹ ì¶”ì„¸ë¥¼ ì˜ë¯¸í•˜ë©°, í–¥í›„ì—ë„ ê°€ê²© ìƒìŠ¹ì´ ì§€ì†ë  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.

**[ìƒìŠ¹ ì›ì¸]**
- ê°œë°œí˜¸ì¬ (êµí†µ, ì¬ê°œë°œ ë“±)
- ì¸êµ¬ ìœ ì…
- ê³µê¸‰ ë¶€ì¡±

**[LH í‰ê°€ ì˜í–¥]**
ìµœê·¼ ìƒìŠ¹ì„¸ê°€ ê°ì •í‰ê°€ì— ë°˜ì˜ë˜ì–´ ë§¤ì…ê°€ê°€ ìƒí–¥ ì¡°ì •ë  ê°€ëŠ¥ì„±ì´ ìˆë‹¤.
"""
        
        elif trend_12m < -5:
            narrative += f"""
ì§€ë‚œ 12ê°œì›”ê°„ ê°€ê²©ì€ **{self.fmt_pct(abs(trend_12m), 1)}** í•˜ë½í•˜ì˜€ë‹¤. 
ì´ëŠ” ì‹œì¥ ì¹¨ì²´ë¥¼ ì˜ë¯¸í•˜ë©°, ë‹¨ê¸°ì ìœ¼ë¡œëŠ” ê°€ê²© í•˜ë½ ë˜ëŠ” ì •ì²´ê°€ ì˜ˆìƒëœë‹¤.

**[í•˜ë½ ì›ì¸]**
- ê±°ë˜ëŸ‰ ê°ì†Œ
- ê³µê¸‰ ê³¼ì‰
- ì§€ì—­ ê²½ì œ ì¹¨ì²´

**[LH í‰ê°€ ì˜í–¥]**
ìµœê·¼ í•˜ë½ì„¸ê°€ ê°ì •í‰ê°€ì— ë°˜ì˜ë˜ì–´ ë§¤ì…ê°€ê°€ í•˜í–¥ ì¡°ì •ë  ê°€ëŠ¥ì„±ì´ ìˆë‹¤. 
ì´ëŠ” ì‚¬ì—…ìì—ê²Œ ìœ ë¦¬í•œ ì¡°ê±´ì´ë‹¤.
"""
        
        else:
            narrative += f"""
ì§€ë‚œ 12ê°œì›”ê°„ ê°€ê²©ì€ **{self.fmt_pct(abs(trend_12m), 1)}** {"ìƒìŠ¹" if trend_12m > 0 else "í•˜ë½"}í•˜ì˜€ë‹¤. 
ì´ëŠ” ì•ˆì •ì ì¸ ì‹œì¥ íë¦„ì„ ì˜ë¯¸í•˜ë©°, ë‹¨ê¸°ì ìœ¼ë¡œ í° ë³€ë™ì€ ì—†ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.

**[ì•ˆì • ìš”ì¸]**
- ê· í˜•ì  ìˆ˜ê¸‰
- ì•ˆì •ì  ê±°ë˜ëŸ‰
- ì •ìƒì  ì‹œì¥ ì‚¬ì´í´

**[LH í‰ê°€ ì˜í–¥]**
ì•ˆì •ì  ì‹œì¥ ì¡°ê±´ì€ ê°ì •í‰ê°€ì—ì„œ ì˜ˆì¸¡ ê°€ëŠ¥ì„±ì„ ë†’ì¸ë‹¤.
"""
        
        narrative += f"""

---

### 3. ê°ì •í‰ê°€ ì˜ˆìƒ

**[ì˜ˆìƒ ê°ì •í‰ê°€ì•¡]**

í˜„ì¬ ì‹œì¥ ì¡°ê±´ì„ ê³ ë ¤í•  ë•Œ, ê°ì •í‰ê°€ì•¡ì€ ì‹œì¥ ê±°ë˜ê°€ ëŒ€ë¹„ 
**{self.fmt_pct(85 if signal == 'UNDERVALUED' else 90 if signal == 'FAIR' else 95, 0)}** 
ìˆ˜ì¤€ì—ì„œ ê²°ì •ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.

**[ê°ì •í‰ê°€ ì‹œ ê³ ë ¤ì‚¬í•­]**
1. ìµœê·¼ 3ê°œì›” ê±°ë˜ì‚¬ë¡€ (í˜„ì¬ {signal_kr} ë°˜ì˜)
2. ê³µì‚¬ë¹„ ì—°ë™í˜• í‰ê°€ ì ìš© ì—¬ë¶€
3. ì¸ê·¼ LH ë§¤ì… ì‚¬ë¡€

**[ê¶Œê³  ì‚¬í•­]**
- LH ì‚¬ì „í˜‘ì˜ë¥¼ í†µí•œ ê°ì •í‰ê°€ ë°©í–¥ì„± í™•ì¸
- ì¡°ê±´ë¶€ ë§¤ë§¤ê³„ì•½ ì²´ê²° (ê°ì •ê°€ ê¸°ì¤€)
- ê°ì •í‰ê°€ ê²°ê³¼ì— ë”°ë¥¸ í˜‘ìƒ ì—¬ì§€ í™•ë³´

---

*ë³¸ ì‹œì¥ ë¶„ì„ì€ ê³µê°œ ê±°ë˜ ë°ì´í„° ë° ì‹œì¥ ì¡°ì‚¬ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•˜ë©°, 
ì‹¤ì œ ê°ì •í‰ê°€ ê²°ê³¼ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.*
"""
        
        return narrative.strip()
    
    # ============================================
    # SECTION 4: DEMAND ANALYSIS (COMPACT)
    # ============================================
    
    def interpret_demand_analysis(self, ctx: Dict[str, Any]) -> str:
        """ìˆ˜ìš” ë¶„ì„ ì„œìˆ  ìƒì„± (ê°„ì†Œí™”)"""
        
        demand = ctx.get('demand', {})
        score = demand.get('overall_score', 0)
        recommended_type = demand.get('recommended_type', 'ì‹ í˜¼ë¶€ë¶€í˜•')
        
        narrative = f"""
## ìˆ˜ìš” ë¶„ì„

### ì¢…í•© ìˆ˜ìš” ì ìˆ˜: {self.fmt(score, 1)}ì 

ë³¸ ì§€ì—­ì€ **{recommended_type}** ìˆ˜ìš”ê°€ {"ë§¤ìš° ë†’ì€" if score >= 80 else "ë†’ì€" if score >= 60 else "ë³´í†µ ìˆ˜ì¤€ì˜"} 
ê²ƒìœ¼ë¡œ ë¶„ì„ë˜ì—ˆë‹¤.

**[ì ìˆ˜ í•´ì„]**
"""
        
        if score >= 80:
            narrative += """
80ì  ì´ìƒì€ LH í‰ê°€ì—ì„œ 'ìµœìš°ìˆ˜' ë“±ê¸‰ì— í•´ë‹¹í•˜ë©°, ì…ì£¼ í›„ ë†’ì€ ì…ì£¼ìœ¨(95% ì´ìƒ)ì´ 
ì˜ˆìƒëœë‹¤.
"""
        elif score >= 60:
            narrative += """
60ì ëŒ€ëŠ” LH í‰ê°€ì—ì„œ 'ì–‘í˜¸' ë“±ê¸‰ì— í•´ë‹¹í•˜ë©°, ì•ˆì •ì ì¸ ì…ì£¼ìœ¨(90% ì´ìƒ)ì´ ì˜ˆìƒëœë‹¤.
"""
        else:
            narrative += """
60ì  ë¯¸ë§Œì€ ìˆ˜ìš” ì¡°ê±´ì´ ì¼ë¶€ ì œí•œì ì´ë¯€ë¡œ, ë§ˆì¼€íŒ… ê°•í™” ë° íƒ€ê²Ÿ í™•ëŒ€ ì „ëµì´ í•„ìš”í•˜ë‹¤.
"""
        
        narrative += f"""

**[ì£¼ìš” ìˆ˜ìš” ìš”ì¸]**
- ì¸ê·¼ ì§ì¥ ì¸êµ¬
- êµìœ¡ ì¸í”„ë¼ (í•™êµ, í•™ì›)
- ìƒí™œ í¸ì˜ì‹œì„¤
- ëŒ€ì¤‘êµí†µ ì ‘ê·¼ì„±

**[LH í‰ê°€ ì—°ê³„]**
ìˆ˜ìš” ì ìˆ˜ëŠ” LH í‰ê°€ í•­ëª© ì¤‘ 'ì…ì§€ ì—¬ê±´(25ì )'ì— ì§ì ‘ ë°˜ì˜ëœë‹¤.

---

*ìƒì„¸ ìˆ˜ìš” ë¶„ì„ ë°ì´í„°ëŠ” Appendixë¥¼ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.*
"""
        
        return narrative.strip()
    
    # ============================================
    # SECTION 5: FINANCIAL ANALYSIS
    # ============================================
    
    def interpret_financial(self, ctx: Dict[str, Any]) -> str:
        """ì¬ë¬´ ë¶„ì„ ì„œìˆ  ìƒì„±"""
        
        finance = ctx.get('finance', {})
        
        # Handle both nested and flat structures
        if 'capex' in finance and isinstance(finance['capex'], dict):
            capex = finance['capex'].get('total', 0) / 100000000
        else:
            capex = finance.get('capex_billion', ctx.get('capex_krw', 0))
        
        if 'npv' in finance and isinstance(finance['npv'], dict):
            npv = finance['npv'].get('public', 0) / 100000000
        else:
            npv = finance.get('npv_billion', ctx.get('npv_public_krw', 0))
        
        if 'irr' in finance and isinstance(finance['irr'], dict):
            irr = finance['irr'].get('public', 0)
        else:
            irr = finance.get('irr_percent', ctx.get('irr_public_pct', 0))
        
        if 'payback' in finance and isinstance(finance['payback'], dict):
            payback = finance['payback'].get('years', 0)
        else:
            payback = finance.get('payback_years', ctx.get('payback_period_years', 0))
        
        narrative = f"""
## ì¬ë¬´ íƒ€ë‹¹ì„± ë¶„ì„

### 1. í•µì‹¬ ì¬ë¬´ ì§€í‘œ

| ì§€í‘œ | ê°’ | í‰ê°€ |
|------|-----|------|
| ì´ ì‚¬ì—…ë¹„ (CAPEX) | {self.fmt(capex, 1)}ì–µì› | - |
| ìˆœí˜„ì¬ê°€ì¹˜ (NPV) | {self.fmt(npv, 1)}ì–µì› | {"ì–‘í˜¸" if npv > 0 else "ë¶€ì •ì "} |
| ë‚´ë¶€ìˆ˜ìµë¥  (IRR) | {self.fmt_pct(irr, 2)} | {"ì–‘í˜¸" if irr > 4 else "ë¶€ì¡±"} |
| íˆ¬ìíšŒìˆ˜ê¸°ê°„ (Payback) | {self.fmt(payback, 1)}ë…„ | {"ì–‘í˜¸" if 0 < payback < 15 else "ì¥ê¸°" if payback >= 15 else "N/A"} |

---

### 2. NPV í•´ì„

"""
        
        if npv < 0:
            narrative += f"""
**NPVê°€ ìŒìˆ˜({self.fmt(npv, 1)}ì–µì›)**ë¼ëŠ” ê²ƒì€ ë¯¼ê°„ PF êµ¬ì¡°ë¡œëŠ” 
ìˆ˜ìµì„± í™•ë³´ê°€ ì–´ë µë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.

**[ì›ì¸ ë¶„ì„]**
1. LH ì„ëŒ€ë£Œ ìˆ˜ì¤€ (ì‹œì„¸ 85%)
2. ë†’ì€ ì´ˆê¸° íˆ¬ìë¹„
3. ì¥ê¸° íšŒìˆ˜ êµ¬ì¡°

**[ì •ì±…ì  íƒ€ë‹¹ì„±]**
ë‹¤ë§Œ LH ì‚¬ì—…ì€ ìˆ˜ìµì„±ë³´ë‹¤ 'ì£¼ê±° ë³µì§€'ë¥¼ ìš°ì„ í•˜ë¯€ë¡œ, 
NPV ìŒìˆ˜ê°€ ì‚¬ì—… ë¶ˆê°€ë¥¼ ì˜ë¯¸í•˜ì§€ëŠ” ì•ŠëŠ”ë‹¤.

**[ê°œì„  ì „ëµ]**
1. LH ì§ë§¤ì… ë°©ì‹ (í† ì§€ë¹„ ë¶€ë‹´ ì œê±°)
2. ê³µì‚¬ë¹„ ì—°ë™í˜• ê°ì •í‰ê°€
3. ì •ì±…ìê¸ˆ í™œìš© (ê¸ˆë¦¬ 2.87%)
4. ì‚¬ì—… ê·œëª¨ í™•ëŒ€
"""
        else:
            narrative += f"""
**NPVê°€ ì–‘ìˆ˜({self.fmt(npv, 1)}ì–µì›)**ì´ë©°, ì´ëŠ” ê²½ì œì  íƒ€ë‹¹ì„±ì´ 
í™•ë³´ë˜ì—ˆìŒì„ ì˜ë¯¸í•œë‹¤.

**[ì‚¬ì—… ì‹¤í–‰ ê°€ëŠ¥ì„±]**
ì¬ë¬´ ì§€í‘œ ê¸°ì¤€ìœ¼ë¡œ ë³¸ ì‚¬ì—…ì€ ì‹¤í–‰ ê°€ëŠ¥í•˜ë©°, 
LH ì •ì±…ìê¸ˆ í™œìš© ì‹œ IRRì€ ë”ìš± ê°œì„ ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒëœë‹¤.
"""
        
        narrative += f"""

---

### 3. IRR í•´ì„

IRR {self.fmt_pct(irr, 2)}ëŠ” """
        
        if irr >= 6:
            narrative += "ë¯¼ê°„ PF ì¡°ë‹¬ ê¸ˆë¦¬(4-6%)ë¥¼ ìƒíšŒí•˜ë¯€ë¡œ ì¶©ë¶„íˆ ë§¤ë ¥ì ì¸ ìˆ˜ì¤€ì´ë‹¤."
        elif irr >= 3:
            narrative += "ë¯¼ê°„ PF ì¡°ë‹¬ì´ ê°€ëŠ¥í•œ ìµœì†Œ ìˆ˜ì¤€ì´ë©°, ì •ì±…ìê¸ˆ í™œìš© ì‹œ ê°œì„  ê°€ëŠ¥í•˜ë‹¤."
        else:
            narrative += "ë¯¼ê°„ PF ì¡°ë‹¬ì´ ì–´ë ¤ìš´ ìˆ˜ì¤€ì´ë¯€ë¡œ, LH ì •ì±…ìê¸ˆ í™œìš©ì´ í•„ìˆ˜ì ì´ë‹¤."
        
        narrative += f"""

---

### 4. ì¬ë¬´ ì „ëµ ì œì•ˆ

**[ê¶Œê³  ì‚¬í•­]**
1. LH ì •ì±…ìê¸ˆ(ì—° 2.87%) ìš°ì„  í™œìš©
2. ê³µì‚¬ë¹„ ì ˆê° (VE ì ìš©)
3. ê°ì •í‰ê°€ ìµœì í™” (ê³µì‚¬ë¹„ ì—°ë™í˜•)
4. ë‹¨ê³„ì  ì‚¬ì—… êµ¬ì¡° (ë¦¬ìŠ¤í¬ ë¶„ì‚°)

---

*ìƒì„¸ ì¬ë¬´ ë¶„ì„ ë° ì‹œë‚˜ë¦¬ì˜¤ëŠ” ë³„ë„ ì„¹ì…˜ì„ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.*
"""
        
        return narrative.strip()
    
    # ============================================
    # SECTION 6: RISK ANALYSIS
    # ============================================
    
    def interpret_risk(self, ctx: Dict[str, Any]) -> str:
        """ë¦¬ìŠ¤í¬ ë¶„ì„ ì„œìˆ  ìƒì„±"""
        
        risk = ctx.get('risk_analysis', {}).get('enhanced', {})
        top_risks = risk.get('top_10_risks', [])
        
        narrative = f"""
## ë¦¬ìŠ¤í¬ ë¶„ì„

### 1. ì¢…í•© ë¦¬ìŠ¤í¬ í‰ê°€

ë³¸ ì‚¬ì—…ì—ì„œ ì‹ë³„ëœ ì£¼ìš” ë¦¬ìŠ¤í¬ëŠ” **{len(top_risks)}ê°œ**ì´ë‹¤.

**[ë¦¬ìŠ¤í¬ ë¶„í¬]**
- ğŸ”´ CRITICAL: {sum(1 for r in top_risks if r.get('risk_level') == 'CRITICAL')}ê°œ
- ğŸŸ  HIGH: {sum(1 for r in top_risks if r.get('risk_level') == 'HIGH')}ê°œ
- ğŸŸ¡ MEDIUM: {sum(1 for r in top_risks if r.get('risk_level') == 'MEDIUM')}ê°œ
- ğŸŸ¢ LOW: {sum(1 for r in top_risks if r.get('risk_level') == 'LOW')}ê°œ

---

### 2. ì£¼ìš” ë¦¬ìŠ¤í¬ ë° ëŒ€ì‘ ì „ëµ

"""
        
        # Top 3 risks
        for i, risk in enumerate(top_risks[:3], 1):
            risk_name = risk.get('name', 'N/A')
            risk_level = risk.get('risk_level', 'MEDIUM')
            risk_score = risk.get('risk_score', 0)
            description = risk.get('description', '')
            strategies = risk.get('response_strategies', [])
            
            emoji = {'CRITICAL': 'ğŸ”´', 'HIGH': 'ğŸŸ ', 'MEDIUM': 'ğŸŸ¡', 'LOW': 'ğŸŸ¢'}.get(risk_level, 'âšª')
            
            narrative += f"""
#### {i}. {emoji} {risk_name} (ìœ„í—˜ë„: {risk_score}/25)

**[ì„¤ëª…]**
{description}

**[ëŒ€ì‘ ì „ëµ]**
"""
            for j, strategy in enumerate(strategies, 1):
                narrative += f"{j}. {strategy}\n"
            
            narrative += "\n---\n\n"
        
        narrative += """
### 3. ì¢…í•© ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì „ëµ

**[ë¦¬ìŠ¤í¬ ìµœì†Œí™” ë°©ì•ˆ]**
1. LH ì‚¬ì „í˜‘ì˜ë¥¼ í†µí•œ ë¶ˆí™•ì‹¤ì„± ì œê±°
2. ë‹¨ê³„ë³„ ì˜ì‚¬ê²°ì • (Go/No-Go ê²Œì´íŠ¸)
3. ì „ë¬¸ê°€ ìë¬¸ (ë²•ë¬´, ì„¸ë¬´, ê¸°ìˆ )
4. ë³´í—˜ ê°€ì… (ê³µì‚¬, ë°°ìƒì±…ì„ ë“±)

**[ëª¨ë‹ˆí„°ë§ ì²´ê³„]**
- ì›”ë³„ ë¦¬ìŠ¤í¬ ì ê²€
- ë¶„ê¸°ë³„ LH í˜‘ì˜
- ë°˜ê¸°ë³„ ì „ëµ ì¬ê²€í† 

---

*ìƒì„¸ ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤ëŠ” ë³„ë„ ì„¹ì…˜ ì°¸ê³ *
"""
        
        return narrative.strip()
    
    # ============================================
    # SECTION 7: ROADMAP (COMPACT)
    # ============================================
    
    def interpret_roadmap(self, ctx: Dict[str, Any]) -> str:
        """ë¡œë“œë§µ ì„œìˆ  ìƒì„± (ê°„ì†Œí™”)"""
        
        narrative = f"""
## 36ê°œì›” ì‹¤í–‰ ë¡œë“œë§µ

### ì£¼ìš” ë‹¨ê³„

**Phase 1 (1-6ê°œì›”): ì¤€ë¹„ ë° ì¸í—ˆê°€**
- LH ì‚¬ì „í˜‘ì˜
- í† ì§€ í™•ë³´
- ê±´ì¶• ì‹¬ì˜

**Phase 2 (7-12ê°œì›”): ì„¤ê³„ ë° ê³„ì•½**
- ì„¤ê³„ ì™„ë£Œ
- ì‹œê³µì‚¬ ì„ ì •
- ê¸ˆìœµ ì¡°ë‹¬

**Phase 3 (13-30ê°œì›”): ì‹œê³µ**
- ì°©ê³µ
- ê³µì • ê´€ë¦¬
- í’ˆì§ˆ ê´€ë¦¬

**Phase 4 (31-36ê°œì›”): ì¤€ê³µ ë° ì¸ê³„**
- ì¤€ê³µ
- ê°ì •í‰ê°€
- LH ë§¤ì…

---

*ìƒì„¸ íƒ€ì„ë¼ì¸ì€ Gantt Chart ì°¸ê³ *
"""
        
        return narrative.strip()
    
    # ============================================
    # SECTION 8: ACADEMIC CONCLUSION
    # ============================================
    
    def interpret_academic_conclusion(self, ctx: Dict[str, Any]) -> str:
        """í•™ìˆ ì  ê²°ë¡  ìƒì„±"""
        
        overall_score = ctx.get('scorecard', {}).get('overall', {}).get('score', 0)
        recommendation = ctx.get('scorecard', {}).get('overall', {}).get('recommendation', 'REVISE')
        
        narrative = f"""
## í•™ìˆ ì  ê²°ë¡ 

### 1. ì—°êµ¬ ìš”ì•½

ë³¸ ë¶„ì„ì€ LH ì‹ ì¶•ë§¤ì…ì„ëŒ€ ì‚¬ì—…ì˜ ì¢…í•© íƒ€ë‹¹ì„±ì„ 
ì •ëŸ‰ì Â·ì •ì„±ì  ë°©ë²•ë¡ ì„ í†µí•´ í‰ê°€í•˜ì˜€ë‹¤.

**[ë¶„ì„ ë°©ë²•ë¡ ]**
- ì…ì§€ ë¶„ì„: GIS ê¸°ë°˜ ì ‘ê·¼ì„± í‰ê°€
- ìˆ˜ìš” ì˜ˆì¸¡: AI ê¸°ë°˜ ìŠ¤ì½”ì–´ë§ ëª¨ë¸
- ì‹œì¥ ë¶„ì„: ê±°ë˜ì‚¬ë¡€ ë¹„êµ ë° íŠ¸ë Œë“œ ë¶„ì„
- ì¬ë¬´ ë¶„ì„: DCF(Discounted Cash Flow) ëª¨ë¸
- ë¦¬ìŠ¤í¬ í‰ê°€: í™•ë¥ Ã—ì˜í–¥ ë§¤íŠ¸ë¦­ìŠ¤

---

### 2. í•µì‹¬ ë°œê²¬ (Key Findings)

1. **ì •ì±…ì  íƒ€ë‹¹ì„±**: LH ê³µê¸‰ ì •ì±…ê³¼ ë†’ì€ ì¼ì¹˜ë„
2. **ì‹œì¥ ì¡°ê±´**: {"ì–‘í˜¸í•œ" if overall_score >= 60 else "ì¼ë¶€ ì œí•œì "} ì‹œì¥ í™˜ê²½
3. **ì¬ë¬´ êµ¬ì¡°**: ì •ì±… ì§€ì› ì‹œ ê°œì„  ê°€ëŠ¥
4. **ë¦¬ìŠ¤í¬**: ê´€ë¦¬ ê°€ëŠ¥í•œ ìˆ˜ì¤€

---

### 3. ì •ì±…ì  ì œì–¸

**[LHì— ëŒ€í•œ ì œì–¸]**
1. ê°ì •í‰ê°€ ì²´ê³„ ëª…í™•í™”
2. ì‚¬ì—…ì ì§€ì› ê°•í™” (ì €ê¸ˆë¦¬ ìê¸ˆ)
3. ì¸í—ˆê°€ ì ˆì°¨ ê°„ì†Œí™”

**[ì‚¬ì—…ìì— ëŒ€í•œ ì œì–¸]**
1. ì¡°ê¸° LH í˜‘ì˜
2. ì¬ë¬´ êµ¬ì¡° ìµœì í™”
3. ë¦¬ìŠ¤í¬ ê´€ë¦¬ ì²´ê³„ êµ¬ì¶•

---

### 4. ìµœì¢… ê²°ë¡ 

ë³¸ í”„ë¡œì íŠ¸ëŠ” ì¢…í•© í‰ê°€ {self.fmt(overall_score, 1)}ì ìœ¼ë¡œ 
**{recommendation}** ìˆ˜ì¤€ì´ë‹¤.

"""
        
        if recommendation == 'GO':
            narrative += """
ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•˜ë©°, LH í‰ê°€ í†µê³¼ ê°€ëŠ¥ì„±ì´ ë†’ë‹¤.
"""
        elif recommendation == 'CONDITIONAL':
            narrative += """
ì¡°ê±´ë¶€ ì‹¤í–‰ ê°€ëŠ¥í•˜ë©°, ì¼ë¶€ ê°œì„  í›„ ì‚¬ì—…í™” ê¶Œê³ í•œë‹¤.
"""
        else:
            narrative += """
ì¬ê²€í† ê°€ í•„ìš”í•˜ë©°, êµ¬ì¡° ê°œì„  ë˜ëŠ” ëŒ€ì²´ ì…ì§€ ê²€í† ë¥¼ ê¶Œê³ í•œë‹¤.
"""
        
        narrative += f"""

---

**[Disclaimer]**
ë³¸ ë¶„ì„ì€ {self.current_year}ë…„ {datetime.now().month}ì›” ê¸°ì¤€ì´ë©°, 
ì •ì±… ë° ì‹œì¥ ë³€í™”ì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤.

---

*END OF REPORT*
"""
        
        return narrative.strip()
    
    # ============================================
    # MASTER METHOD: GENERATE ALL NARRATIVES
    # ============================================
    
    def generate_all_narratives(self, ctx: Dict[str, Any]) -> Dict[str, str]:
        """
        ëª¨ë“  ì„¹ì…˜ì˜ ì„œìˆ  ìë™ ìƒì„±
        
        Args:
            ctx: ReportContextBuilderê°€ ìƒì„±í•œ ì „ì²´ context
            
        Returns:
            Dict[str, str]: ì„¹ì…˜ëª… -> ì„œìˆ  í…ìŠ¤íŠ¸
        """
        
        narratives = {}
        
        try:
            # Section 1: Executive Summary
            narratives['executive_summary'] = self.interpret_executive_summary(ctx)
        except Exception as e:
            narratives['executive_summary'] = f"[Executive Summary ìƒì„± ì˜¤ë¥˜: {str(e)}]"
        
        try:
            # Section 2: Policy Framework
            narratives['policy_framework'] = self.interpret_policy_framework(ctx)
        except Exception as e:
            narratives['policy_framework'] = f"[Policy Framework ìƒì„± ì˜¤ë¥˜: {str(e)}]"
        
        try:
            # Section 3: Market Analysis
            narratives['market_analysis'] = self.interpret_market_analysis(ctx)
        except Exception as e:
            narratives['market_analysis'] = f"[Market Analysis ìƒì„± ì˜¤ë¥˜: {str(e)}]"
        
        try:
            # Section 4: Demand Analysis
            narratives['demand_analysis'] = self.interpret_demand_analysis(ctx)
        except Exception as e:
            narratives['demand_analysis'] = f"[Demand Analysis ìƒì„± ì˜¤ë¥˜: {str(e)}]"
        
        try:
            # Section 5: Financial Analysis
            narratives['financial_analysis'] = self.interpret_financial(ctx)
        except Exception as e:
            narratives['financial_analysis'] = f"[Financial Analysis ìƒì„± ì˜¤ë¥˜: {str(e)}]"
        
        try:
            # Section 6: Risk Analysis
            narratives['risk_analysis'] = self.interpret_risk(ctx)
        except Exception as e:
            narratives['risk_analysis'] = f"[Risk Analysis ìƒì„± ì˜¤ë¥˜: {str(e)}]"
        
        try:
            # Section 7: Roadmap
            narratives['roadmap'] = self.interpret_roadmap(ctx)
        except Exception as e:
            narratives['roadmap'] = f"[Roadmap ìƒì„± ì˜¤ë¥˜: {str(e)}]"
        
        try:
            # Section 8: Academic Conclusion
            narratives['academic_conclusion'] = self.interpret_academic_conclusion(ctx)
        except Exception as e:
            narratives['academic_conclusion'] = f"[Academic Conclusion ìƒì„± ì˜¤ë¥˜: {str(e)}]"
        
        return narratives
