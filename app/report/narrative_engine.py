"""
ZeroSite Phase 13: Academic Narrative Engine

What / So What / Why / Insight êµ¬ì¡°ì˜ í•™ìˆ ì  ë³´ê³ ì„œ ì„œìˆ  ìƒì„±

Author: ZeroSite Development Team + GenSpark AI
Created: 2025-12-10
Version: 13.0
"""

from typing import Dict, Any, List
from dataclasses import dataclass
from enum import Enum


class NarrativeType(str, Enum):
    """ì„œìˆ  ìœ í˜•"""
    WHAT = "what"              # ë¬´ì—‡ì„ (í˜„ìƒ/ì‚¬ì‹¤)
    SO_WHAT = "so_what"        # ê·¸ë˜ì„œ ì–´ë–¤ë° (ì˜ë¯¸/ì˜í–¥)
    WHY = "why"                # ì™œ (ì›ì¸/ë°°ê²½)
    INSIGHT = "insight"        # í†µì°° (ì‹œì‚¬ì )
    CONCLUSION = "conclusion"  # ê²°ë¡  (ì œì•ˆ)


@dataclass
class NarrativeSection:
    """ì„œìˆ  ì„¹ì…˜"""
    type: NarrativeType
    title: str
    content: str
    key_points: List[str]


class AcademicNarrativeEngine:
    """
    í•™ìˆ  ë…¼ë¬¸ ìŠ¤íƒ€ì¼ì˜ ì„œìˆ  ìƒì„± ì—”ì§„
    
    KDI/ì •ì±…ì—°êµ¬ ë³´ê³ ì„œ í˜•ì‹ì˜ êµ¬ì¡°í™”ëœ ì„œìˆ ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
    
    Structure:
    1. WHAT: í˜„ìƒê³¼ ë°ì´í„° ì œì‹œ
    2. SO WHAT: ì˜ë¯¸ì™€ ì˜í–¥ ë¶„ì„
    3. WHY: ì›ì¸ê³¼ ë°°ê²½ ì„¤ëª…
    4. INSIGHT: í•µì‹¬ í†µì°°ê³¼ ì‹œì‚¬ì 
    5. CONCLUSION: ì •ì±… ì œì•ˆ ë° ê²°ë¡ 
    """
    
    def __init__(self):
        """Initialize narrative engine"""
        pass
    
    def generate_full_narrative(
        self,
        design_result: Dict[str, Any],
        financial_result: Dict[str, Any],
        lh_score: Dict[str, Any]
    ) -> List[NarrativeSection]:
        """
        ì™„ì „í•œ í•™ìˆ ì  ì„œìˆ  ìƒì„±
        
        Args:
            design_result: ì„¤ê³„ ê²°ê³¼ (Phase 11)
            financial_result: ì¬ë¬´ ë¶„ì„ ê²°ê³¼ (Phase 2)
            lh_score: LH í‰ê°€ ê²°ê³¼ (Phase 3)
        
        Returns:
            List of NarrativeSection
        """
        sections = []
        
        # 1. WHAT: í˜„ìƒ ì„œìˆ 
        sections.append(self._generate_what(design_result, financial_result, lh_score))
        
        # 2. SO WHAT: ì˜ë¯¸ ë¶„ì„
        sections.append(self._generate_so_what(design_result, financial_result, lh_score))
        
        # 3. WHY: ì›ì¸ ì„¤ëª…
        sections.append(self._generate_why(design_result, financial_result, lh_score))
        
        # 4. INSIGHT: í†µì°°
        sections.append(self._generate_insight(design_result, financial_result, lh_score))
        
        # 5. CONCLUSION: ê²°ë¡ 
        sections.append(self._generate_conclusion(design_result, financial_result, lh_score))
        
        return sections
    
    def _generate_what(
        self,
        design: Dict,
        financial: Dict,
        lh_score: Dict
    ) -> NarrativeSection:
        """WHAT: í˜„ìƒ ì„œìˆ """
        
        total_units = design.get("total_units", 0)
        total_gfa = design.get("total_gfa", 0)
        supply_type = design.get("supply_type", "")
        roi = financial.get("roi", 0)
        lh_total = lh_score.get("total_score", 0)
        
        content = f"""
ë³¸ í”„ë¡œì íŠ¸ëŠ” LH ì‹ ì¶•ë§¤ì…ì„ëŒ€ ì‚¬ì—…ìœ¼ë¡œ ê³„íšëœ ê³µê³µì£¼íƒ ê°œë°œ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.

**í”„ë¡œì íŠ¸ ê°œìš”:**
- ê³µê¸‰ìœ í˜•: {supply_type}í˜• ë§¤ì…ì„ëŒ€
- ì´ ì„¸ëŒ€ìˆ˜: {total_units}ì„¸ëŒ€
- ì´ ì—°ë©´ì : {total_gfa:,.0f}ã¡
- íˆ¬ììˆ˜ìµë¥ (ROI): {roi:.2f}%
- LH í‰ê°€ì ìˆ˜: {lh_total:.1f}/100ì 

**ì„¤ê³„ íŠ¹ì§•:**
ë³¸ ì„¤ê³„ëŠ” LH ì •ì±… ê¸°ì¤€ì— ë”°ë¥¸ í‰í˜• êµ¬ì„±ê³¼ ê³µìš©ê³µê°„ 15% ì´ìƒ í™•ë³´ë¥¼ í†µí•´
ì»¤ë®¤ë‹ˆí‹° ê¸°ë°˜ ì£¼ê±° ëª¨ë¸ì„ ì‹¤í˜„í•˜ê³ ì í•©ë‹ˆë‹¤.

**ì‚¬ì—… êµ¬ì¡°:**
ë¯¼ê°„ ì‚¬ì—…ìê°€ ê±´ì¶• í›„ LHê°€ ì „ì²´ ë˜ëŠ” ì¼ë¶€ë¥¼ ë§¤ì…í•˜ì—¬
ì²­ë…„Â·ì‹ í˜¼ë¶€ë¶€Â·ê³ ë ¹ì ë“± ì£¼ê±° ì·¨ì•½ ê³„ì¸µì—ê²Œ ì‹œì„¸ ì´í•˜ë¡œ ê³µê¸‰í•˜ëŠ”
'ê³µê³µì§€ì› ë¯¼ê°„ì„ëŒ€ì£¼íƒ' ëª¨ë¸ì…ë‹ˆë‹¤.
        """
        
        key_points = [
            f"ì´ {total_units}ì„¸ëŒ€ ê·œëª¨ì˜ LH ë§¤ì…ì„ëŒ€ ì£¼íƒ",
            f"LH í‰ê°€ì ìˆ˜ {lh_total:.1f}ì ìœ¼ë¡œ {self._get_grade(lh_total)} ë“±ê¸‰",
            f"íˆ¬ììˆ˜ìµë¥  {roi:.2f}%ì˜ ì•ˆì •ì  ìˆ˜ìµ êµ¬ì¡°",
            "ê³µìš©ê³µê°„ 15% ì´ìƒ í™•ë³´ë¡œ ì»¤ë®¤ë‹ˆí‹° ê¸°ëŠ¥ ê°•í™”"
        ]
        
        return NarrativeSection(
            type=NarrativeType.WHAT,
            title="1. í”„ë¡œì íŠ¸ í˜„í™© (WHAT)",
            content=content.strip(),
            key_points=key_points
        )
    
    def _generate_so_what(
        self,
        design: Dict,
        financial: Dict,
        lh_score: Dict
    ) -> NarrativeSection:
        """SO WHAT: ì˜ë¯¸ ë¶„ì„"""
        
        total_units = design.get("total_units", 0)
        lh_total = lh_score.get("total_score", 0)
        roi = financial.get("roi", 0)
        
        # ì‚¬íšŒì  ì˜ë¯¸
        social_impact = self._calculate_social_impact(total_units)
        
        # ê²½ì œì  ì˜ë¯¸
        economic_significance = self._assess_economic_significance(roi, lh_total)
        
        content = f"""
ë³¸ í”„ë¡œì íŠ¸ëŠ” ë‹¨ìˆœí•œ ì£¼íƒ ê³µê¸‰ì„ ë„˜ì–´ ë‹¤ìŒê³¼ ê°™ì€ ì‚¬íšŒÂ·ê²½ì œì  ì˜ë¯¸ë¥¼ ê°–ìŠµë‹ˆë‹¤.

**ì‚¬íšŒì  ì˜ë¯¸:**
{social_impact}

**ê²½ì œì  ì˜ë¯¸:**
{economic_significance}

**ì •ì±…ì  ì˜ë¯¸:**
LH ë§¤ì…ì„ëŒ€ ì‚¬ì—…ì€ ë¯¼ê°„ì˜ ê°œë°œ ì—­ëŸ‰ê³¼ ê³µê³µì˜ ë³µì§€ ëª©í‘œë¥¼ ê²°í•©í•œ
'ë¯¼ê´€í˜‘ë ¥(PPP)' ëª¨ë¸ì˜ ëŒ€í‘œ ì‚¬ë¡€ì…ë‹ˆë‹¤.

ë³¸ í”„ë¡œì íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì •ì±… íš¨ê³¼ë¥¼ ê¸°ëŒ€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. **ì£¼ê±° ì•ˆì •ì„± ì œê³ **: ì‹œì„¸ ëŒ€ë¹„ 70~80% ìˆ˜ì¤€ì˜ ì„ëŒ€ë£Œë¡œ ì£¼ê±°ë¹„ ë¶€ë‹´ ê²½ê°
2. **ê³µê¸‰ ë‹¤ì–‘ì„± í™•ëŒ€**: ë¯¼ê°„ ì˜ì—­ì—ì„œ ê³µê³µì£¼íƒ ê³µê¸‰ ê¸°ì—¬
3. **ë„ì‹œ ì¬ìƒ íš¨ê³¼**: ê¸°ì¡´ ì£¼ê±°ì§€ì—­ì˜ ë¬¼ë¦¬ì Â·ì‚¬íšŒì  í™˜ê²½ ê°œì„ 
4. **ì§€ì—­ ê²½ì œ í™œì„±í™”**: ê±´ì„¤ íˆ¬ì ë° ê±°ì£¼ ì¸êµ¬ ìœ ì…ìœ¼ë¡œ ì§€ì—­ ê²½ì œ ê¸°ì—¬

**í•µì‹¬ ì‹œì‚¬ì :**
ë³¸ í”„ë¡œì íŠ¸ëŠ” 'ì£¼ê±° ë³µì§€'ì™€ 'ë¯¼ê°„ ìˆ˜ìµì„±'ì„ ë™ì‹œì— ë‹¬ì„±í•  ìˆ˜ ìˆëŠ”
ì§€ì†ê°€ëŠ¥í•œ ì£¼íƒ ê³µê¸‰ ëª¨ë¸ì˜ ê°€ëŠ¥ì„±ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
        """
        
        key_points = [
            f"{total_units}ì„¸ëŒ€ì˜ ì£¼ê±° ì·¨ì•½ ê³„ì¸µ ì§€ì›",
            "ë¯¼ê´€í˜‘ë ¥(PPP) ëª¨ë¸ì˜ ì„±ê³µì  ì‚¬ë¡€ êµ¬ì¶•",
            f"LH {lh_total:.1f}ì  ë‹¬ì„±ìœ¼ë¡œ ì •ì±… ëª©í‘œ ë¶€í•©",
            "ì§€ì†ê°€ëŠ¥í•œ ì£¼íƒ ê³µê¸‰ ëª¨ë¸ ì‹¤í˜„"
        ]
        
        return NarrativeSection(
            type=NarrativeType.SO_WHAT,
            title="2. í”„ë¡œì íŠ¸ ì˜ë¯¸ (SO WHAT)",
            content=content.strip(),
            key_points=key_points
        )
    
    def _generate_why(
        self,
        design: Dict,
        financial: Dict,
        lh_score: Dict
    ) -> NarrativeSection:
        """WHY: ì›ì¸ ì„¤ëª…"""
        
        content = """
ë³¸ í”„ë¡œì íŠ¸ê°€ í˜„ ì‹œì ì—ì„œ ì¶”ì§„ë˜ì–´ì•¼ í•˜ëŠ” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

**1. ì •ì±… í™˜ê²½:**

êµ­í† êµí†µë¶€ëŠ” 'ì œ3ì°¨ ì¥ê¸°('23~'32) ê³µê³µì£¼íƒ ì¢…í•©ê³„íš'ì„ í†µí•´
ì—°í‰ê·  25ë§Œí˜¸ì˜ ê³µê³µì£¼íƒ ê³µê¸‰ ëª©í‘œë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.

ì´ ì¤‘ ë§¤ì…ì„ëŒ€ëŠ” ì•½ 20%(ì—° 5ë§Œí˜¸)ë¥¼ ì°¨ì§€í•˜ë©°,
íŠ¹íˆ ì²­ë…„Â·ì‹ í˜¼ë¶€ë¶€ ëŒ€ìƒ ë§¤ì…ì„ëŒ€ í™•ëŒ€ ì •ì±…ì´ ê°•í™”ë˜ê³  ìˆìŠµë‹ˆë‹¤.

**2. ì‹œì¥ í™˜ê²½:**

- **ì£¼ê±°ë¹„ ë¶€ë‹´ ì‹¬í™”**: ì„œìš¸ í‰ê·  ì „ì„¸ê°€ê²© 6ì–µì› ëŒíŒŒ (2024)
- **ì²­ë…„ ì£¼ê±° ë¶ˆì•ˆì •**: 20~30ëŒ€ ìê°€ ë³´ìœ ìœ¨ 10% ë¯¸ë§Œ
- **1ì¸ê°€êµ¬ ì¦ê°€**: ì „ì²´ ê°€êµ¬ì˜ 33.4% (í†µê³„ì²­, 2023)

ì´ëŸ¬í•œ ì‹œì¥ í™˜ê²½ì—ì„œ **ì €ë ´í•˜ê³  ì•ˆì •ì ì¸ ì£¼ê±° ê³µê¸‰**ì´ ì ˆì‹¤í•œ ìƒí™©ì…ë‹ˆë‹¤.

**3. ì‚¬ì—… í™˜ê²½:**

LHëŠ” ë§¤ì…ì„ëŒ€ ë¬¼ëŸ‰ í™•ëŒ€ë¥¼ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ì§€ì›ì±…ì„ ì‹œí–‰ ì¤‘ì…ë‹ˆë‹¤:

- ë§¤ì… ê°€ê²© ìƒí–¥ ì¡°ì • (ê°ì •í‰ê°€ì•¡ì˜ 85% â†’ 90%)
- ìš°ì„  ë§¤ì… ì§€ì—­ í™•ëŒ€ (ì—­ì„¸ê¶Œ, ëŒ€í•™ê°€ ë“±)
- ì¸ì¦(BF, ì—ë„ˆì§€) ê°€ì‚°ì  ë¶€ì—¬

**4. ì¬ë¬´ í™˜ê²½:**

í˜„ì¬ LH ë§¤ì…ì„ëŒ€ ì‚¬ì—…ì˜ í‰ê·  ìˆ˜ìµë¥ ì€ ì—° 2~3% ìˆ˜ì¤€ìœ¼ë¡œ
ì•ˆì •ì ì´ë‚˜ ë‚®ì€ ìˆ˜ìµ êµ¬ì¡°ì…ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ LH ë§¤ì… ë³´ì¥ìœ¼ë¡œ ì¸í•œ **ë‚®ì€ ë¦¬ìŠ¤í¬**ì™€
**ì¥ê¸° ì•ˆì • ìˆ˜ìµ** íŠ¹ì„±ìœ¼ë¡œ ì—°ê¸°ê¸ˆÂ·ë³´í—˜ì‚¬ ë“± ê¸°ê´€íˆ¬ììì˜ ê´€ì‹¬ì´ ë†’ìŠµë‹ˆë‹¤.

**ê²°ë¡ :**
ì •ì±…Â·ì‹œì¥Â·ì‚¬ì—…Â·ì¬ë¬´ í™˜ê²½ ëª¨ë‘ê°€ LH ë§¤ì…ì„ëŒ€ ì‚¬ì—…ì— ìœ ë¦¬í•œ ì‹œì ì´ë©°,
íŠ¹íˆ ì²­ë…„Â·ì‹ í˜¼ë¶€ë¶€ ëŒ€ìƒ ì‚¬ì—…ì€ ì •ì±… ìš°ì„ ìˆœìœ„ê°€ ë†’ì•„ ì„±ê³µ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤.
        """
        
        key_points = [
            "ì •ë¶€ì˜ ê³µê³µì£¼íƒ ê³µê¸‰ í™•ëŒ€ ì •ì±… (ì—° 25ë§Œí˜¸)",
            "ì²­ë…„ ì£¼ê±° ë¶ˆì•ˆì • ì‹¬í™” (ìê°€ ë³´ìœ ìœ¨ 10% ë¯¸ë§Œ)",
            "LH ë§¤ì… ê°€ê²© ìƒí–¥ ë° ì§€ì›ì±… í™•ëŒ€",
            "ê¸°ê´€íˆ¬ììì˜ ì•ˆì •ì  ìˆ˜ìµ ì¶”êµ¬ ê²½í–¥"
        ]
        
        return NarrativeSection(
            type=NarrativeType.WHY,
            title="3. ì¶”ì§„ ë°°ê²½ (WHY)",
            content=content.strip(),
            key_points=key_points
        )
    
    def _generate_insight(
        self,
        design: Dict,
        financial: Dict,
        lh_score: Dict
    ) -> NarrativeSection:
        """INSIGHT: í†µì°°"""
        
        lh_total = lh_score.get("total_score", 0)
        roi = financial.get("roi", 0)
        
        # í•µì‹¬ í†µì°° ë„ì¶œ
        insights = self._derive_key_insights(lh_total, roi, design)
        
        content = f"""
ë³¸ í”„ë¡œì íŠ¸ ë¶„ì„ì„ í†µí•´ ë„ì¶œëœ í•µì‹¬ í†µì°°ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

**í†µì°° 1: ì •ì±… ì •í•©ì„±ì´ ì‚¬ì—… ì„±ê³µì˜ í•µì‹¬**

LH ë§¤ì…ì„ëŒ€ ì‚¬ì—…ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ 'ì •ì±… ì •í•©ì„±'ì…ë‹ˆë‹¤.
ë³¸ í”„ë¡œì íŠ¸ì˜ LH í‰ê°€ì ìˆ˜ {lh_total:.1f}ì ì€
ì •ì±… ê¸°ì¤€(í‰í˜•, ê³µìš©ê³µê°„, ì…ì§€ ë“±)ì„ ì¶©ì‹¤íˆ ë°˜ì˜í•œ ê²°ê³¼ì…ë‹ˆë‹¤.

ì´ëŠ” ë‹¨ìˆœíˆ ê±´ì¶• ê·œëª¨ë¥¼ ìµœëŒ€í™”í•˜ëŠ” ê²ƒë³´ë‹¤
**'LHê°€ ì›í•˜ëŠ” ì„¤ê³„'**ë¥¼ í•˜ëŠ” ê²ƒì´ ë” ì¤‘ìš”í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

**í†µì°° 2: ìˆ˜ìµì„±ê³¼ ê³µê³µì„±ì˜ ê· í˜•ì  ì¡´ì¬**

ë³¸ í”„ë¡œì íŠ¸ì˜ ROI {roi:.2f}%ëŠ” ì¼ë°˜ ë¯¼ê°„ ì„ëŒ€ì£¼íƒ ëŒ€ë¹„ ë‚®ì§€ë§Œ,
LH ë§¤ì… ë³´ì¥ìœ¼ë¡œ ì¸í•œ ë¦¬ìŠ¤í¬ ê°ì†Œë¥¼ ê³ ë ¤í•˜ë©´ ì¶©ë¶„íˆ ë§¤ë ¥ì ì…ë‹ˆë‹¤.

ì¦‰, **'ë‚®ì€ ìˆ˜ìµë¥  + ë‚®ì€ ë¦¬ìŠ¤í¬ = ì•ˆì •ì  íˆ¬ì'** êµ¬ì¡°ê°€ ì„±ë¦½í•©ë‹ˆë‹¤.

**í†µì°° 3: ì»¤ë®¤ë‹ˆí‹° ì„¤ê³„ê°€ ì°¨ë³„í™” ìš”ì†Œ**

ê³µìš©ê³µê°„ 15% ì´ìƒ í™•ë³´ëŠ” ë‹¨ìˆœ ê·œì œ ì¶©ì¡±ì´ ì•„ë‹ˆë¼,
ê±°ì£¼ì ë§Œì¡±ë„ì™€ LH í‰ê°€ ì ìˆ˜ë¥¼ ë™ì‹œì— ë†’ì´ëŠ” í•µì‹¬ ì „ëµì…ë‹ˆë‹¤.

**í†µì°° 4: ì„¤ê³„ â†’ ì‚¬ì—…ì„± â†’ LH í‰ê°€ì˜ í†µí•© ë¶„ì„ í•„ìš”**

{insights}

**ê²°ë¡ ì  í†µì°°:**
LH ë§¤ì…ì„ëŒ€ ì‚¬ì—…ì€ 'ì •ì±… ì´í•´ â†’ ìµœì  ì„¤ê³„ â†’ ì‚¬ì—…ì„± ê²€ì¦'ì˜
í†µí•©ì  ì ‘ê·¼ì´ í•„ìˆ˜ì´ë©°, ì´ë¥¼ ì§€ì›í•˜ëŠ” AI ê¸°ë°˜ ì˜ì‚¬ê²°ì • ì‹œìŠ¤í…œì´ ìœ íš¨í•©ë‹ˆë‹¤.
        """
        
        key_points = [
            "ì •ì±… ì •í•©ì„±ì´ ì‚¬ì—… ì„±ê³µì˜ í•µì‹¬ ìš”ì†Œ",
            "ë‚®ì€ ìˆ˜ìµë¥  + ë‚®ì€ ë¦¬ìŠ¤í¬ = ì•ˆì •ì  íˆ¬ì êµ¬ì¡°",
            "ì»¤ë®¤ë‹ˆí‹° ì„¤ê³„ê°€ LH í‰ê°€ì˜ ì°¨ë³„í™” í¬ì¸íŠ¸",
            "í†µí•©ì  ë¶„ì„ ì‹œìŠ¤í…œì˜ í•„ìš”ì„±"
        ]
        
        return NarrativeSection(
            type=NarrativeType.INSIGHT,
            title="4. í•µì‹¬ í†µì°° (INSIGHT)",
            content=content.strip(),
            key_points=key_points
        )
    
    def _generate_conclusion(
        self,
        design: Dict,
        financial: Dict,
        lh_score: Dict
    ) -> NarrativeSection:
        """CONCLUSION: ê²°ë¡ """
        
        lh_total = lh_score.get("total_score", 0)
        decision = self._make_decision(lh_total, financial.get("roi", 0))
        
        content = f"""
ë³¸ í”„ë¡œì íŠ¸ì— ëŒ€í•œ ì¢…í•© í‰ê°€ ë° ì •ì±… ì œì–¸ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

**ì¢…í•© í‰ê°€:**

{decision}

**ì •ì±… ì œì–¸:**

1. **ì‚¬ì—…ì ì¸¡ë©´:**
   - LH ì •ì±… ê¸°ì¤€ì„ ì‚¬ì „ì— ì¶©ë¶„íˆ ê²€í† í•˜ê³  ì„¤ê³„ì— ë°˜ì˜
   - ê³µìš©ê³µê°„ ì„¤ê³„ë¥¼ ë‹¨ìˆœ ê·œì œ ì¶©ì¡±ì´ ì•„ë‹Œ 'ê°€ì¹˜ ì°½ì¶œ' ê´€ì ìœ¼ë¡œ ì ‘ê·¼
   - ì¬ë¬´ êµ¬ì¡°ëŠ” ì•ˆì •ì„± ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ê³„ (ë‚®ì€ ë ˆë²„ë¦¬ì§€)

2. **LH ì¸¡ë©´:**
   - ìš°ìˆ˜ ì„¤ê³„ì•ˆì— ëŒ€í•œ ê°€ì‚°ì  í™•ëŒ€ (í˜„í–‰ 5% â†’ 10%)
   - ì§€ì—­ë³„ ë§¤ì… ê°€ê²© ì°¨ë“±í™”ë¥¼ í†µí•œ ê³µê¸‰ ë‹¤ì–‘ì„± í™•ë³´
   - ì»¤ë®¤ë‹ˆí‹° ìš´ì˜ ê³„íš ì œì¶œ ì‹œ í‰ê°€ ë°˜ì˜

3. **ì •ë¶€ ì¸¡ë©´:**
   - ë§¤ì…ì„ëŒ€ ì§€ì› ì˜ˆì‚° í™•ëŒ€ (í˜„í–‰ ì—° 5ë§Œí˜¸ â†’ 7ë§Œí˜¸)
   - í† ì§€ì„ëŒ€ë¶€ ë§¤ì…ì„ëŒ€ ë“± ë‹¤ì–‘í•œ ëª¨ë¸ ì‹¤í—˜
   - ì¥ê¸° ê±°ì£¼ìì— ëŒ€í•œ ë¶„ì–‘ ì „í™˜ ì˜µì…˜ ë¶€ì—¬

**ìµœì¢… ì œì–¸:**

ë³¸ í”„ë¡œì íŠ¸ëŠ” í˜„í–‰ LH ë§¤ì…ì„ëŒ€ ì œë„ í•˜ì—ì„œ **ì‹¤í˜„ ê°€ëŠ¥ì„±ì´ ë†’ì€ ì‚¬ì—…**ìœ¼ë¡œ í‰ê°€ë©ë‹ˆë‹¤.

ë‹¤ë§Œ, ì„±ê³µì  ì¶”ì§„ì„ ìœ„í•´ì„œëŠ”:
- ì„¤ê³„ ë‹¨ê³„ë¶€í„° LH ì •ì±… ê¸°ì¤€ ë°˜ì˜
- ì»¤ë®¤ë‹ˆí‹° ìš´ì˜ ê³„íš ìˆ˜ë¦½
- ì•ˆì •ì  ì¬ë¬´ êµ¬ì¡° í™•ë³´
ê°€ í•„ìˆ˜ì ì…ë‹ˆë‹¤.

**í–¥í›„ ê³¼ì œ:**
- ì‹¤ì œ LH ë§¤ì… ì‹¬ì‚¬ ê²°ê³¼ ëª¨ë‹ˆí„°ë§
- ê±°ì£¼ì ë§Œì¡±ë„ ì¡°ì‚¬ ë° í”¼ë“œë°± ë°˜ì˜
- ìœ ì‚¬ í”„ë¡œì íŠ¸ ë²¤ì¹˜ë§ˆí‚¹ ë° ê°œì„ 
        """
        
        key_points = [
            decision.split("\n")[0].strip(),
            "ì‚¬ì—…ìÂ·LHÂ·ì •ë¶€ ì¸¡ë©´ì˜ í†µí•©ì  ì œì–¸",
            "ì‹¤í˜„ ê°€ëŠ¥ì„± ë†’ì€ ì‚¬ì—…ìœ¼ë¡œ í‰ê°€",
            "ì„±ê³µì„ ìœ„í•œ í•µì‹¬ ê³¼ì œ ì œì‹œ"
        ]
        
        return NarrativeSection(
            type=NarrativeType.CONCLUSION,
            title="5. ê²°ë¡  ë° ì œì–¸ (CONCLUSION)",
            content=content.strip(),
            key_points=key_points
        )
    
    # ============================================================
    # Helper Methods
    # ============================================================
    
    def _get_grade(self, score: float) -> str:
        """ì ìˆ˜ì—ì„œ ë“±ê¸‰ ì¶”ì¶œ"""
        if score >= 90:
            return "ìµœìš°ìˆ˜"
        elif score >= 80:
            return "ìš°ìˆ˜"
        elif score >= 70:
            return "ì–‘í˜¸"
        elif score >= 60:
            return "ë³´í†µ"
        else:
            return "ë¯¸í¡"
    
    def _calculate_social_impact(self, units: int) -> str:
        """ì‚¬íšŒì  ì˜í–¥ ê³„ì‚°"""
        return f"""
ë³¸ í”„ë¡œì íŠ¸ëŠ” ì´ {units}ì„¸ëŒ€ì˜ ì£¼ê±°ë¥¼ ì œê³µí•¨ìœ¼ë¡œì¨
ì£¼ê±° ì·¨ì•½ ê³„ì¸µ {units * 2}~{units * 3}ëª…(ê°€êµ¬ë‹¹ 2~3ì¸ ê°€ì •)ì˜
ì£¼ê±° ì•ˆì •ì— ê¸°ì—¬í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.

íŠ¹íˆ ì‹œì„¸ ëŒ€ë¹„ 70~80% ìˆ˜ì¤€ì˜ ì„ëŒ€ë£Œë¡œ ê³µê¸‰ë¨ì— ë”°ë¼
ì—°ê°„ ì•½ {units * 300}ë§Œì›ì˜ ì£¼ê±°ë¹„ ì ˆê° íš¨ê³¼ê°€ ë°œìƒí•˜ë©°,
ì´ëŠ” ê±°ì£¼ìì˜ ì‚¶ì˜ ì§ˆ í–¥ìƒê³¼ ì†Œë¹„ ì—¬ë ¥ ì¦ëŒ€ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤.
        """.strip()
    
    def _assess_economic_significance(self, roi: float, lh_score: float) -> str:
        """ê²½ì œì  ì˜ë¯¸ í‰ê°€"""
        return f"""
ë³¸ í”„ë¡œì íŠ¸ì˜ ROI {roi:.2f}%ëŠ” ì¼ë°˜ ë¯¼ê°„ ì„ëŒ€ ì‚¬ì—… ëŒ€ë¹„ ë‚®ìœ¼ë‚˜,
LH ë§¤ì… ë³´ì¥ìœ¼ë¡œ ì¸í•œ ì„ëŒ€ë£Œ ë° ê³µì‹¤ ë¦¬ìŠ¤í¬ê°€ ì—†ì–´
ì‹¤ì§ˆì ìœ¼ë¡œëŠ” ì•ˆì •ì ì¸ ìˆ˜ìµ êµ¬ì¡°ë¥¼ ê°–ì¶”ê³  ìˆìŠµë‹ˆë‹¤.

ë˜í•œ LH í‰ê°€ì ìˆ˜ {lh_score:.1f}ì ì€
ë§¤ì… ê°€ëŠ¥ì„±ì´ ë†’ìŒì„ ì˜ë¯¸í•˜ë©°,
ì´ëŠ” ì‚¬ì—… ë¶ˆí™•ì‹¤ì„±ì„ ëŒ€í­ ê°ì†Œì‹œí‚¤ëŠ” ìš”ì¸ì…ë‹ˆë‹¤.

ë”°ë¼ì„œ ë³¸ í”„ë¡œì íŠ¸ëŠ” 'ë†’ì€ ìˆ˜ìµ'ë³´ë‹¤ëŠ”
'ì•ˆì •ì ì´ê³  ì˜ˆì¸¡ ê°€ëŠ¥í•œ ìˆ˜ìµ'ì„ ì¶”êµ¬í•˜ëŠ” íˆ¬ììì—ê²Œ ì í•©í•©ë‹ˆë‹¤.
        """.strip()
    
    def _derive_key_insights(self, lh_score: float, roi: float, design: Dict) -> str:
        """í•µì‹¬ í†µì°° ë„ì¶œ"""
        return f"""
ë³¸ í”„ë¡œì íŠ¸ ë¶„ì„ì„ í†µí•´ 'A/B/C ì„¤ê³„ì•ˆ ë¹„êµ'ê°€
ë‹¨ìˆœí•œ ê·œëª¨ ë¹„êµê°€ ì•„ë‹ˆë¼ **'ì •ì±… ì ìˆ˜ vs ìˆ˜ìµì„±'ì˜ íŠ¸ë ˆì´ë“œì˜¤í”„**ë¥¼
ëª…í™•íˆ ë³´ì—¬ì¤€ë‹¤ëŠ” ì ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.

ì´ëŠ” ì‚¬ì—…ìê°€ LH ë§¤ì… ê°€ëŠ¥ì„±ê³¼ ìˆ˜ìµì„± ì‚¬ì´ì—ì„œ
**ì „ëµì  ì„ íƒ**ì„ í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ” ì˜ì‚¬ê²°ì • ë„êµ¬ì˜ ì¤‘ìš”ì„±ì„ ì‹œì‚¬í•©ë‹ˆë‹¤.
        """.strip()
    
    def _make_decision(self, lh_score: float, roi: float) -> str:
        """ì¢…í•© íŒì •"""
        if lh_score >= 80 and roi >= 2.0:
            return f"""
ë³¸ í”„ë¡œì íŠ¸ëŠ” LH í‰ê°€ì ìˆ˜ {lh_score:.1f}ì , ROI {roi:.2f}%ë¡œ
**ì‚¬ì—… ì¶”ì§„ì„ ì ê·¹ ê¶Œì¥**í•©ë‹ˆë‹¤.

ì •ì±… ì •í•©ì„±ê³¼ ìˆ˜ìµì„±ì´ ëª¨ë‘ ìš°ìˆ˜í•˜ì—¬ LH ë§¤ì… ê°€ëŠ¥ì„±ì´ ë†’ìœ¼ë©°,
ì•ˆì •ì ì¸ íˆ¬ì ìˆ˜ìµì„ ê¸°ëŒ€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            """.strip()
        elif lh_score >= 70 and roi >= 1.5:
            return f"""
ë³¸ í”„ë¡œì íŠ¸ëŠ” LH í‰ê°€ì ìˆ˜ {lh_score:.1f}ì , ROI {roi:.2f}%ë¡œ
**ì¡°ê±´ë¶€ ì¶”ì§„ì„ ê¶Œì¥**í•©ë‹ˆë‹¤.

ì¼ë¶€ ê°œì„ ì´ í•„ìš”í•˜ë‚˜ ì „ë°˜ì ìœ¼ë¡œ ì–‘í˜¸í•œ ìˆ˜ì¤€ì´ë©°,
ì„¸ë¶€ ì„¤ê³„ ì¡°ì •ì„ í†µí•´ ì‚¬ì—…ì„± í–¥ìƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            """.strip()
        else:
            return f"""
ë³¸ í”„ë¡œì íŠ¸ëŠ” LH í‰ê°€ì ìˆ˜ {lh_score:.1f}ì , ROI {roi:.2f}%ë¡œ
**ì¬ê²€í† ë¥¼ ê¶Œì¥**í•©ë‹ˆë‹¤.

ì •ì±… ì •í•©ì„± ë˜ëŠ” ìˆ˜ìµì„± ê°œì„ ì´ í•„ìš”í•˜ë©°,
ì„¤ê³„ì•ˆ ì „ë©´ ìˆ˜ì • ë˜ëŠ” ì‚¬ì—… ì¡°ê±´ ì¬í˜‘ìƒì„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.
            """.strip()


# ============================================================
# Usage Example
# ============================================================

if __name__ == "__main__":
    # Test data
    design_result = {
        "total_units": 42,
        "total_gfa": 1500,
        "supply_type": "ì²­ë…„"
    }
    
    financial_result = {
        "roi": 2.5,
        "capex": 15_000_000_000
    }
    
    lh_score = {
        "total_score": 85.0,
        "grade": "B"
    }
    
    # Generate narrative
    engine = AcademicNarrativeEngine()
    sections = engine.generate_full_narrative(design_result, financial_result, lh_score)
    
    print("="*80)
    print("Academic Narrative Engine - Test Output")
    print("="*80)
    
    for section in sections:
        print(f"\n{section.title}")
        print("-"*80)
        print(section.content)
        print(f"\nğŸ“Œ Key Points:")
        for point in section.key_points:
            print(f"  â€¢ {point}")
    
    print("\n" + "="*80)
    print("âœ… Academic Narrative Engine ì •ìƒ ì‘ë™")
